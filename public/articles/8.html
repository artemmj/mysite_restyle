<h1 class="article-title">Go. –°—Ç–∞—Ç—å—è. –ü—Ä–æ–µ–∫—Ç gRPC (SSO Auth)</h1>
<div class="article-meta">
    <span>üóì 25 –ú–∞—è 2025</span>
    <span>üè∑Ô∏è Go, gRPC</span>
</div>
<div style="text-align: right;">
    <p>–ß–µ—Ä–ø–∞–ª –≤–¥–æ—Ö–Ω–æ–≤–µ–Ω–∏–µ –∏–∑: <a href="https://habr.com/ru/articles/774796/">–°—Ç–∞—Ç—å—è –Ω–∞ habr</a></p>
</div>
<p>–í —ç—Ç–æ–π —Å—Ç–∞—Ç—å–µ –Ω–∞–ø–∏—à–µ–º –≤–µ–± –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–∞ Go - —Å–µ—Ä–≤–µ—Ä –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ (–∞–Ω–∞–ª–æ–≥ –ø—Ä–æ REST API –º–æ–∂–Ω–æ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ä—è–¥–æ–º –Ω–∞ —Å–∞–π—Ç–µ) —Å –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–æ–π, —Å–ª–æ—è–º–∏. –ù–∞–ø–∏—à–µ–º –∫–∞–∫ —Å–µ—Ä–≤–µ—Ä–Ω—É—é —á–∞—Å—Ç—å, —Ç–∞–∫ –∏ –∫–ª–∏–µ–Ω—Ç—Å–∫—É—é —á–∞—Å—Ç–∏.</p>
<p><b>TODO:</b></p>
<ul>
    <li>–ù–∞–ø–∏—Å–∞—Ç—å –ø—Ä–æ—Å—Ç–æ–π, –Ω–æ –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–π gRPC-—Å–µ—Ä–≤–∏—Å</li>
    <li>–û—Å–≤–µ–∂–∏—Ç—å –∑–Ω–∞–Ω–∏—è –ø–æ –±–∞–∑–æ–≤—ã–º–∏ –ø—Ä–∏–Ω—Ü–∏–ø–∞–º–∏ —Ä–∞–±–æ—Ç—ã –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏</li>
    <li>–ü–æ–¥—Ä—É–∂–∏–º –µ–≥–æ —Å —É–∂–µ –≥–æ—Ç–æ–≤—ã–º —Å–µ—Ä–≤–∏—Å–æ–º URL Shortener ‚Äî –∏–∑ —Å—Ç–∞—Ç—å–∏ —Ä—è–¥–æ–º</li>
    <li>–ù–∞–ø–∏—à–µ–º –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ —Ç–µ—Å—Ç—ã</li>
</ul>
<p>–≠—Ç–∞ —Å—Ç–∞—Ç—å—è, –≤ –ø–µ—Ä–≤—É—é –æ—á–µ—Ä–µ–¥—å, –ø—Ä–æ –Ω–∞–ø–∏—Å–∞–Ω–∏–µ gRPC-—Å–µ—Ä–≤–∏—Å–∞, –≤—Å—ë –æ—Å—Ç–∞–ª—å–Ω–æ–µ ‚Äî –ø–æ–±–æ—á–Ω–æ–µ. –ú—ã –Ω–µ –ø–∏—à–µ–º –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–π Auth, –º—ã –Ω–µ –æ–±—Å—É–∂–¥–∞–µ–º –ª—É—á—à–∏–µ –ø–æ–¥—Ö–æ–¥—ã –∫ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ, —ç—Ç–æ –ø–æ–±–æ—á–Ω–æ–µ.</p>
<p><b>SSO –∏–ª–∏ Auth?</b></p>
<p>–û–±—ã—á–Ω–æ —Ç–µ—Ä–º–∏–Ω–æ–º Auth –Ω–∞–∑—ã–≤–∞—é—Ç —Å–µ—Ä–≤–∏—Å—ã, –∫–æ—Ç–æ—Ä—ã–µ –æ—Ç–≤–µ—á–∞—é—Ç —Ç–æ–ª—å–∫–æ –∑–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é –∏ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é, –∞ SSO –Ω–µ—á—Ç–æ –±–æ–ª–µ–µ –æ–±—â–µ–µ ‚Äî —Ä–∞–±–æ—Ç–∞ —Å –ø—Ä–∞–≤–∞–º–∏ (permissions), –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ –∏ –¥—Ä. –ö–æ–Ω–µ—á–Ω–æ, —É –ø–æ–¥–æ–±–Ω—ã—Ö —Ç–∏–ø–æ–≤ —Å–µ—Ä–≤–∏—Å–æ–≤ –µ—Å—Ç—å –∏ –±–æ–ª–µ–µ —Å—Ç—Ä–æ–≥–∏–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è, –Ω–æ –∫–æ–≥–¥–∞ —è –≤—Å—Ç—Ä–µ—á–∞–ª —ç—Ç–∏ —Å–µ—Ä–≤–∏—Å—ã –Ω–∞ –ø—Ä–∞–∫—Ç–∏–∫–µ, –≥—Ä–∞–Ω–∏—Ü—ã –≤—Å–µ–≥–¥–∞ –±—ã–ª–∏ —Ä–∞–∑–º—ã—Ç—ã –∏–ª–∏ –≤–æ–≤—Å–µ —Å—Ç–∏—Ä–∞–ª–∏—Å—å.</p>
<p>–ß—Ç–æ–±—ã –≤–Ω–µ—Å—Ç–∏ —è—Å–Ω–æ—Å—Ç—å, –Ω–∞–∑–æ–≤–µ–º —Ç–µ—Ä–º–∏–Ω–æ–º SSO —Å–µ—Ä–≤–∏—Å, –æ–±—ä–µ–¥–∏–Ω—è—é—â–∏–π –≤ —Å–µ–±–µ —Ç—Ä–∏ –≤–∞–∂–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–∏: –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è (Auth), –†–∞–±–æ—Ç–∞ —Å –ø–µ—Ä–º–∏—à–µ–Ω–Ω–∞–º–∏ (Permissions), –ü—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ (User Info). –í —ç—Ç–æ–π —Å—Ç–∞—Ç—å–µ –±—É–¥–µ—Ç —Ç–æ–ª—å–∫–æ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è.</p>
<p><b>–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞</b></p>
<p>–û—Å–Ω–æ–≤–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã, –∫–æ—Ç–æ—Ä—ã–º–∏ –±—É–¥–µ–º –∂–µ—Ä—Ç–≤–æ–≤–∞—Ç—å:</p>
<ul>
    <li>–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–µ—Ä–≤–∏—Å–∞. –°–∞–º–∞ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –≤ —Ü–µ–ª–æ–º –±—É–¥–µ—Ç –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –ø—Ä–∏–±–ª–∏–∂–µ–Ω–∞ –∫ –±–æ–µ–≤–æ–º—É —Å–µ—Ä–≤–∏—Å—É. –ñ–µ—Ä—Ç–≤–æ–≤–∞—Ç—å –∂–µ –±—É–¥–µ–º –≤ –æ—Å–Ω–æ–≤–Ω–æ–º –æ–±–≤—è–∑–∫–∞–º–∏: –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥, lifecycle, —Ç–µ—Å—Ç–∞–º–∏ –∏ —Ç.–ø.</li>
    <li>–°—Ö–µ–º–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏. –ê –≤–æ—Ç –æ–Ω–∞ –±—É–¥–µ—Ç –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ —É–ø—Ä–æ—â–µ–Ω–∞, —Ç.–∫. –æ—Å–Ω–æ–≤–Ω–æ–π —Ñ–æ–∫—É—Å –º—ã –¥–µ–ª–∞–µ–º –Ω–∞ –Ω–∞–ø–∏—Å–∞–Ω–∏–µ gRPC-—Å–µ—Ä–≤–∏—Å–∞. –ù–æ —Ç–µ–º –Ω–µ –º–µ–Ω–µ–µ, –µ–≥–æ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞ —Ö–≤–∞—Ç–∏—Ç –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–≥–æ —Ä–∞–∑–≤–∏—Ç–∏—è</li>
</ul>
<p><b>–û–±—â–∞—è —Å—Ö–µ–º–∞ –ø—Ä–æ–µ–∫—Ç–∞ ‚Äî –∫–∞–∫ –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</b></p>
<p>–î–µ–π—Å—Ç–≤—É—é—â–∏–µ –ª–∏—Ü–∞:</p>
<ul>
    <li>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å (User) ‚Äî —á–µ–ª–æ–≤–µ–∫, –∫–æ—Ç–æ—Ä—ã–π –≤—ã–Ω—É–∂–¥–µ–Ω –∞–≤—Ç–æ—Ä–∏–∑–æ–≤—ã–≤–∞—Ç—å—Å—è, —Ç.–∫. –æ–Ω —Ö–æ—á–µ—Ç –≤–æ—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –Ω–∞—à–∏–º URL Shortener'–æ–º</li>
    <li>URL Shortener ‚Äî —Å–µ—Ä–≤–∏—Å, –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç –∫–ª–∏–µ–Ω—Ç–æ–º SSO</li>
    <li>–°–µ—Ä–≤–µ—Ä –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ (SSO) ‚Äî —Å–µ—Ä–≤–∏—Å, –∫–æ—Ç–æ—Ä—ã–π —É–º–µ–µ—Ç –∞–≤—Ç–æ—Ä–∏–∑–æ–≤—ã–≤–∞—Ç—å, –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø—Ä–∞–≤–∞—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ —Ç.–ø.</li>
</ul>
<p>–ö–∞–∫ —ç—Ç–æ –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å:</p>
<ul>
    <li>User (–∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º–æ–µ –∏–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ) –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∑–∞–ø—Ä–æ—Å –≤ SSO, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å JWT —Ç–æ–∫–µ–Ω –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏</li>
    <li>–° —ç—Ç–∏–º —Ç–æ–∫–µ–Ω–æ–º –æ–Ω –∏–¥—ë—Ç –≤ URL Shortener, —á—Ç–æ–±—ã –≤—ã–ø–æ–ª–Ω—è—Ç—å —Ä–∞–∑–Ω—ã–µ –ø–æ–ª–µ–∑–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã ‚Äî —Å–æ–∑–¥–∞–≤–∞—Ç—å –∫–æ—Ä–æ—Ç–∫–∏–µ —Å—Å—ã–ª–∫–∏, —É–¥–∞–ª—è—Ç—å –∏—Ö –∏ —Ç.–ø.</li>
    <li>URL Shortener –ø–æ–ª—É—á–∞–µ—Ç –∑–∞–ø—Ä–æ—Å –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞, –¥–æ—Å—Ç–∞—ë—Ç –∏–∑ –Ω–µ–≥–æ —Ç–æ–∫–µ–Ω, –ø–æ –∫–æ—Ç–æ—Ä–æ–º—É –ø–æ–Ω–∏–º–∞–µ—Ç –∫—Ç–æ –ø—Ä–∏—à–µ–ª, –∏ —á—Ç–æ –µ–º—É —Ä–∞–∑—Ä–µ—à–µ–Ω–æ –¥–µ–ª–∞—Ç—å</li>
</ul>
<p>–í–∞–∂–Ω—ã–µ –≤–µ—â–∏, –∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ –±—É–¥–µ—Ç:</p>
<ul>
    <li>–ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç–∏ JWT ‚Äî –º—ã –±—É–¥–µ–º –≤–µ—Ä–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏, –∫–æ—Ç–æ—Ä–∞—è –≤ –Ω—ë–º —Å–æ–¥–µ—Ä–∂–∏—Ç—Å—è. –ú—ã –º–æ–∂–µ–º —Ç–∞–∫ –¥–µ–ª–∞—Ç—å, —Ç.–∫. JWT –ø–æ–¥–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è —Å–µ–∫—Ä–µ—Ç–Ω—ã–º –∫–ª—é—á–æ–º –∏ –ø–æ–¥–¥–µ–ª–∞—Ç—å –µ–≥–æ –Ω–µ –ø–æ–ª—É—á–∏—Ç—Å—è.</li>
    <li>–û—Ç–∑—ã–≤ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ ‚Äî –ø–æ—Å–∫–æ–ª—å–∫—É –º—ã –≤–µ—Ä–∏–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –≤ JWT, –º—ã –Ω–µ —Å–º–æ–∂–µ–º —Ä–∞–∑–ª–æ–≥–∏–Ω–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–æ "–ø—Ä–æ—Ç—É—Ö–∞–Ω–∏—è" –µ–≥–æ —Ç–æ–∫–µ–Ω–∞. –≠—Ç–æ —Å–∏–ª—å–Ω–æ —É—Å–ª–æ–∂–Ω–∏–ª–æ –±—ã —Å—Ç–∞—Ç—å—é, –≤–µ–¥—å –ø–æ–Ω–∞–¥–æ–±–∏–ª–æ—Å—å –±—ã —Ö—Ä–∞–Ω–∏—Ç—å —Å–µ—Å—Å–∏–∏ –≤ SSO, –¥–µ–ª–∞—Ç—å –ø—Ä–æ–≤–µ—Ä–æ—á–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –æ—Ç URL Shortener –ø–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞ –∏ –¥—Ä.</li>
    <li>–ì–∏–±–∫–∞—è —Å–∏—Å—Ç–µ–º–∞ —Ä–æ–ª–µ–π –∏ –ø–µ—Ä–º–∏—à–µ–Ω–æ–≤ ‚Äî —ç—Ç–æ —Ç–µ–º–∞ –¥–ª—è –æ—Ç–¥–µ–ª—å–Ω–æ–π —Å—Ç–∞—Ç—å–∏</li>
</ul>
<h3 class="section-title" id="contract_code">–û–ø–∏—Å–∞–Ω–∏–µ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞ –∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–æ–¥–∞</h3>
<p>–° —á–µ–≥–æ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞ –ª—é–±–æ–≥–æ gRPC —Å–µ—Ä–≤–∏—Å–∞? C –Ω–∞–ø–∏—Å–∞–Ω–∏—è proto-—Ñ–∞–π–ª–∞ (Protocol Buffers, protobuf). –≠—Ç–æ –æ–ø–∏—Å–∞–Ω–∏–µ API (–∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞) –Ω–∞—à–µ–≥–æ —Å–µ—Ä–≤–∏—Å–∞. –ë–ª–∏–∂–∞–π—à–∞—è –∞–Ω–∞–ª–æ–≥–∏—è –∏–∑ –º–∏—Ä–∞ REST API ‚Äî Swagger / OpenAPI. –û–ø–∏—Å–∞–Ω–∏–µ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞, —ç—Ç–æ, –≤ –Ω–µ–∫–æ—Ç–æ—Ä–æ–º —Å–º—ã—Å–ª–µ, API-–¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –∫ –Ω–∞—à–µ–º—É —Å–µ—Ä–≤–∏—Å—É, –∫–æ—Ç–æ—Ä–∞—è –æ–±—è–∑–∞–Ω–∞ –≤—Å–µ–≥–¥–∞ –±—ã—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω–æ–π, –∏ –ø–æ –∫–æ—Ç–æ—Ä–æ–π –º–æ–∂–Ω–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∏ –∫–ª–∏–µ–Ω—Ç, –∏ —Å–µ—Ä–≤–µ—Ä. –≠—Ç–æ –æ—á–µ–Ω—å —É–¥–æ–±–Ω–æ, –ø–æ—Ç–æ–º—É —á—Ç–æ –Ω–∞–º –Ω–µ –Ω—É–∂–Ω–æ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å –≥–¥–µ-—Ç–æ –æ—Ç–¥–µ–ª—å–Ω–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é, –∏ –º—ã –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –∑–∞–±—É–¥–µ–º –æ–±–Ω–æ–≤–∏—Ç—å –∫–æ–Ω—Ç—Ä–∞–∫—Ç, —Ç.–∫. —Å–µ—Ä–≤–µ—Ä –Ω–∞–ø—Ä—è–º—É—é —Å –Ω–∏–º —Å–≤—è–∑–∞–Ω –±–ª–∞–≥–æ–¥–∞—Ä—è –∫–æ–¥–æ–≥–µ–Ω–µ—Ä–∞—Ü–∏–∏. –•—Ä–∞–Ω–∏—Ç—å proto-—Ñ–∞–π–ª—ã –∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–¥ –±—É–¥–µ–º –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏, –ø–æ—Å–∫–æ–ª—å–∫—É –∫–æ–Ω—Ç—Ä–∞–∫—Ç –Ω—É–∂–µ–Ω –∏ —Å–µ—Ä–≤–µ—Ä—É, –∏ –≤—Å–µ–º –∫–ª–∏–µ–Ω—Ç–∞–º (—Å–µ—Ä–≤–∏—Å–∞–º, –∫–æ—Ç–æ—Ä—ã–µ –ø–æ–ª—å–∑—É—é—Ç—Å—è SSO). –°–µ—Ä–≤–∏—Å—ã –±—É–¥—É—Ç –ø–æ–¥–∫–ª—é—á–∞—Ç—å —ç—Ç–æ—Ç —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π —á–µ—Ä–µ–∑ go.mod.</p>
<p>–ò—Ç–∞–∫, —Å–æ–∑–¥–∞—ë–º –ø—Ä–æ–µ–∫—Ç —Å –Ω–∞–∑–≤–∞–Ω–∏–µ–º protos (–ª–∏–±–æ contract / api-contracts –∏–ª–∏ –∫–∞–∫ –≤–∞–º –±–æ–ª—å—à–µ –Ω—Ä–∞–≤–∏—Ç—Å—è).</p>
<p>–í –∫–æ—Ä–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞ –±—É–¥–µ—Ç –¥–≤–µ –æ—Å–Ω–æ–≤–Ω—ã—Ö –ø–∞–ø–∫–∏:</p>
<ul>
    <li>proto ‚Äî —Ç—É—Ç –±—É–¥–µ–º —Ö—Ä–∞–Ω–∏—Ç—å —Å–∞–º–∏ proto-—Ñ–∞–π–ª—ã</li>
    <li>gen ‚Äî –∞ –∑–¥–µ—Å—å –±—É–¥–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ –Ω–∏–º –∫–æ–¥</li>
</ul>
<p>–í –ø–∞–ø–∫–µ proto/sso —Å–æ–∑–¥–∞—ë–º —Ñ–∞–π–ª sso.proto. –ï–≥–æ —Ñ–æ—Ä–º–∞—Ç –æ—á–µ–Ω—å –ø—Ä–æ—Å—Ç, –≤ –Ω—ë–º –±—É–¥—É—Ç –æ–ø–∏—Å–∞–Ω—ã:</p>
<ul>
    <li>–û–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è: –≤–µ—Ä—Å–∏—è –ø—Ä–æ—Ç–æ–∫–æ–ª–∞, –ø–∞–∫–µ—Ç –∏ –æ–ø—Ü–∏–∏ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ go-—Ñ–∞–π–ª–æ–≤</li>
    <li>–°–µ—Ä–≤–∏—Å—ã: –ø–æ —Å—É—Ç–∏, —ç—Ç–æ –∞–Ω–∞–ª–æ–≥–∏–∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞–º –≤ Go ‚Äî –æ–ø–∏—Å–∞–Ω–∏–µ —Å–∏–≥–Ω–∞—Ç—É—Ä –º–µ—Ç–æ–¥–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ —Å–µ—Ä–≤–∏—Å –¥–æ–ª–∂–µ–Ω —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å</li>
    <li>–§–æ—Ä–º–∞—Ç —Å–æ–æ–±—â–µ–Ω–∏–π: –æ–±—ä–µ–∫—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ –º–µ—Ç–æ–¥—ã —Å–µ—Ä–≤–∏—Å–æ–≤ –±—É–¥—É—Ç –ø—Ä–∏–Ω–∏–º–∞—Ç—å –∏ –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å</li>
</ul>
<p>–í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π —Å–µ—Ä–≤–∏—Å —É –Ω–∞—Å –ø–æ–∫–∞ –±—É–¥–µ—Ç –æ–¥–∏–Ω: Auth.</p>
<pre><code class="language-go">// –í–µ—Ä—Å–∏—è ProtoBuf
syntax = "proto3";

// –¢–µ–∫—É—â–∏–π –ø–∞–∫–µ—Ç - —É–∫–∞–∑—ã–≤–∞–µ—Ç –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ –∏–º–µ–Ω –¥–ª—è —Å–µ—Ä–≤–∏—Å–∞ –∏ —Å–æ–æ–±—â–µ–Ω–∏–π. –ü–æ–º–æ–≥–∞–µ—Ç –∏–∑–±–µ–≥–∞—Ç—å –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ –∏–º–µ–Ω.
package auth;

// –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ Go –∫–æ–¥–∞.
option go_package = "proto.sso";

// Auth is service for managing permissions and roles.
service Auth {
    // Register registers a new user.
    rpc Register (RegisterRequest) returns (RegisterResponse);
    // Login logs in a user and returns an auth token.
    rpc Login (LoginRequest) returns (LoginResponse);
}

// TODO: –ù–∞ –±—É–¥—É—â–µ–µ, —Å–ª–µ–¥—É—é—â–∏–π —Å–µ—Ä–≤–∏—Å –º–æ–∂–Ω–æ –æ–ø–∏—Å–∞—Ç—å –ø—Ä—è–º–æ –∑–¥–µ—Å—å,
// –ª–∏–±–æ –≤—ã–Ω–µ—Å—Ç–∏ –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–π —Ñ–∞–π–ª
// service Permissions {
//    GetUserPermissions(GetUserPermissionsRequest) return UserPermissions
// }

// –û–±—ä–µ–∫—Ç, –∫–æ—Ç–æ—Ä—ã–π –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –ø—Ä–∏ –≤—ã–∑–æ–≤–µ RPC-–º–µ—Ç–æ–¥–∞ (—Ä—É—á–∫–∏) Register.
message RegisterRequest {
    string email = 1; // Email of the user to register.
    string password = 2; // Password of the user to register.
}

// –û–±—ä–µ–∫—Ç, –∫–æ—Ç–æ—Ä—ã–π –º–µ—Ç–æ–¥ (—Ä—É—á–∫–∞) –≤–µ—Ä–Ω—ë—Ç.
message RegisterResponse {
    int64 user_id = 1; // User ID of the registered user.
}

// –¢–æ –∂–µ —Å–∞–º–æ–µ –¥–ª—è –º–µ—Ç–æ–¥–∞ Login()
message LoginRequest {
    string email = 1; // Email of the user to login.
    string password = 2; // Password of the user to login.
    int32 app_id = 3; // ID of the app to login to.
}

message LoginResponse {
    string token = 1; // Auth token of the logged in user.
}</code></pre>
<p>–¢–µ–ø–µ—Ä—å –ø–æ –≥–æ—Ç–æ–≤–æ–º—É –∫–æ–Ω—Ç—Ä–∞–∫—Ç—É –Ω–∞–º –Ω—É–∂–Ω–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å Go-–∫–æ–¥. –î–ª—è —ç—Ç–æ–≥–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–∞—è —É—Ç–∏–ª–∏—Ç–∞ ‚Äî protoc (–∫–æ–º–ø–∏–ª—è—Ç–æ—Ä Protocol Buffers).</p>
<p>–°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–¥–∏–º –ø–∞–ø–∫—É, –≤ –∫–æ—Ç–æ—Ä–æ–π –±—É–¥–µ–º —Ö—Ä–∞–Ω–∏—Ç—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã (gen/go). –ö–æ–º–∞–Ω–¥–∞ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —É –Ω–∞—Å –±—É–¥–µ—Ç –≤—ã–≥–ª—è–¥–µ—Ç—å —Å–ª–µ–¥—É—é—â–∏–º –æ–±—Ä–∞–∑–æ–º:</p>
<pre><code class="lang-bash">protoc -I proto proto/sso/sso.proto \
    --go_out=./gen/go/ \
    --go_opt=paths=source_relative \
    --go-grpc_out=./gen/go/ \
    --go-grpc_opt=paths=source_relative</code></pre>
<p>–î–∞–≤–∞–π—Ç–µ –µ—ë —Ä–∞–∑–±–µ—Ä—ë–º:</p>
<ul>
    <li><b>-I proto:</b> –û–ø—Ü–∏—è -I –∏–ª–∏ --proto_path —É–∫–∞–∑—ã–≤–∞–µ—Ç –ø—É—Ç—å –∫ –∫–æ—Ä–Ω–µ–≤–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ —Å .proto —Ñ–∞–π–ª–∞–º–∏. –≠—Ç–æ –Ω—É–∂–Ω–æ –¥–ª—è —Ç–æ–≥–æ, —á—Ç–æ–±—ã –∫–æ–º–ø–∏–ª—è—Ç–æ—Ä —Å–º–æ–≥ –Ω–∞–π—Ç–∏ –∏–º–ø–æ—Ä—Ç—ã, –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å. –í –Ω–∞—à–µ–º —Å–ª—É—á–∞–µ —ç—Ç–æ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è proto.</li>
    <li><b>proto/sso/sso.proto:</b> –ø—É—Ç—å –∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º—É .proto —Ñ–∞–π–ª—É, –∫–æ—Ç–æ—Ä—ã–π –º—ã –∫–æ–º–ø–∏–ª–∏—Ä—É–µ–º.</li>
    <li><b>--go_out=./gen/go/:</b> –û–ø—Ü–∏—è --go_out —É–∫–∞–∑—ã–≤–∞–µ—Ç, –∫—É–¥–∞ –∑–∞–ø–∏—Å—ã–≤–∞—Ç—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π Go-–∫–æ–¥. –í –Ω–∞—à–µ–º —Å–ª—É—á–∞–µ ‚Äî ./gen/go/.</li>
    <li><b>--go_opt=paths=source_relative:</b> –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –æ–ø—Ü–∏—è ‚Äî —É–∫–∞–∑—ã–≤–∞–µ—Ç, –∫–∞–∫ —Å–æ–∑–¥–∞–≤–∞—Ç—å –∏–º–µ–Ω–∞ –ø–∞–∫–µ—Ç–æ–≤. paths=source_relative –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ –≤—ã—Ö–æ–¥–Ω—ã–µ —Ñ–∞–π–ª—ã –±—É–¥—É—Ç –∏–º–µ—Ç—å —Ç–æ—Ç –∂–µ –ø–∞–∫–µ—Ç, —á—Ç–æ –∏ –∏—Å—Ö–æ–¥–Ω—ã–µ .proto —Ñ–∞–π–ª—ã.</li>
    <li><b>--go-grpc_out=./gen/go/:</b> –∫—É–¥–∞ –∑–∞–ø–∏—Å—ã–≤–∞—Ç—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π Go gRPC-–∫–æ–¥. –ö–∞–∫ –∏ –≤ –ø—Ä–µ–¥—ã–¥—É—â–µ–º —Å–ª—É—á–∞–µ, –≤—ã—Ö–æ–¥–Ω—ã–µ —Ñ–∞–π–ª—ã –±—É–¥—É—Ç –ø–æ–º–µ—â–µ–Ω—ã –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é ./gen/go/.</li>
    <li><b>--go-grpc_opt=paths=source_relative:</b> –≠—Ç–æ –∞–Ω–∞–ª–æ–≥–∏—á–Ω–∞—è –æ–ø—Ü–∏—è –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ Go gRPC-–∫–æ–¥–∞, —É–∫–∞–∑—ã–≤–∞—é—â–∞—è, –∫–∞–∫ —Å–æ–∑–¥–∞–≤–∞—Ç—å –∏–º–µ–Ω–∞ –ø–∞–∫–µ—Ç–æ–≤ –¥–ª—è gRPC.</li>
</ul>
<p>–í–º–µ—Å—Ç–æ –ø—É—Ç–∏ –¥–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ proto-—Ñ–∞–π–ª–∞ –º–æ–∂–µ—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤–æ—Ç —Ç–∞–∫—É—é –∑–∞–ø–∏—Å—å:</p>
<pre><code class="lang-go">protoc -I proto proto/sso/*.proto &lt;–ø—Ä–æ—á–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã&gt;</code></pre>
<p>–¢–æ–≥–¥–∞ –±—É–¥–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –∫–æ–¥ –ø–æ –≤—Å–µ–º proto-—Ñ–∞–π–ª–∞–º –∏–∑ —É–∫–∞–∑–∞–Ω–Ω–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏. –†–µ–∫—É—Ä—Ä–µ–Ω—Ç–Ω–æ –∑–∞—Ö–æ–¥–∏—Ç—å –≤ –ø–æ–¥–¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –æ–Ω–æ, –∫–æ–Ω–µ—á–Ω–æ, –≤ —Ç–∞–∫–æ–º –≤–∏–¥–µ –Ω–µ –±—É–¥–µ—Ç ‚Äî —ç—Ç–æ —Å–¥–µ–ª–∞—Ç—å –Ω–µ–º–Ω–æ–≥–æ —Å–ª–æ–∂–Ω–µ–µ.</p>
<p>–ò–∑ –æ–ø–∏—Å–∞–Ω–∏—è –∫–æ–º–∞–Ω–¥—ã –º—ã –≤–∏–¥–∏–º, —á—Ç–æ –±—É–¥—É—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω—ã –¥–≤–∞ —Ç–∏–ø–∞ —Ñ–∞–π–ª–æ–≤:</p>
<ul>
    <li>Go –∫–æ–¥: —ç—Ç–æ –Ω–∞–±–æ—Ä —Ç–∏–ø–æ–≤ –¥–∞–Ω–Ω—ã—Ö –∏ –º–µ—Ç–æ–¥–æ–≤ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –Ω–∞—à–∏–º–∏ protobuf —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏ –∏–∑ –ø—Ä–æ–≥—Ä–∞–º–º—ã –Ω–∞ Go. –≠—Ç–æ—Ç –∫–æ–¥ –ø–æ–∑–≤–æ–ª—è–µ—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å, –º–∞–Ω–∏–ø—É–ª–∏—Ä–æ–≤–∞—Ç—å –∏ —Å–µ—Ä–∏–∞–ª–∏–∑–æ–≤–∞—Ç—å/–¥–µ—Å–µ—Ä–∏–∞–ª–∏–∑–æ–≤–∞—Ç—å —ç–∫–∑–µ–º–ø–ª—è—Ä—ã —Å–æ–æ–±—â–µ–Ω–∏–π.</li>
    <li>Go gRPC –∫–æ–¥ —Å–æ–¥–µ—Ä–∂–∏—Ç –∫–ª–∏–µ–Ω—Ç—Å–∫—É—é –∏ —Å–µ—Ä–≤–µ—Ä–Ω—É—é —á–∞—Å—Ç—å:</li>
    <ul>
        <li>–°–µ—Ä–≤–µ—Ä–Ω–∞—è —á–∞—Å—Ç—å: —ç—Ç–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–≤ gRPC —Å–µ—Ä–≤–∏—Å–æ–≤, –≤–∫–ª—é—á–∞—è –º–µ—Ç–æ–¥—ã RPC, –∫–æ—Ç–æ—Ä—ã–µ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã. –¢–∞–∫–∂–µ —Ç—É—Ç –±—É–¥—É—Ç –±–∞–∑–æ–≤—ã–µ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–≤ —Å–µ—Ä–≤–µ—Ä–∞, –∫–æ—Ç–æ—Ä—ã–µ –º—ã –¥–æ–ª–∂–Ω—ã –¥–æ–ø–æ–ª–Ω–∏—Ç—å —Å–≤–æ–µ–π –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–æ–π. –û–Ω–∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è—é—Ç "—Å–∫–µ–ª–µ—Ç" —Å–µ—Ä–≤–µ—Ä–∞.</li>
        <li>–ö–ª–∏–µ–Ω—Ç—Å–∫–∞—è —á–∞—Å—Ç—å: –≥–æ—Ç–æ–≤—ã–µ –∫–ª–∏–µ–Ω—Ç—ã –¥–ª—è –æ–±—Ä–∞—â–µ–Ω–∏—è –∫ gRPC —Å–µ—Ä–≤–µ—Ä—É.</li>
    </ul>
</ul>
<h3 class="section-title" id="enter_point">–¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞ –∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è</h3>
<p>–¢–µ–ø–µ—Ä—å —Å–æ–∑–¥–∞—ë–º –ø—Ä–æ–µ–∫—Ç –¥–ª—è —Å–∞–º–æ–≥–æ —Å–µ—Ä–≤–∏—Å–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –±—É–¥–µ—Ç –≤—ã–≥–ª—è–¥–µ—Ç—å —Å–ª–µ–¥—É—é—â–∏–º –æ–±—Ä–∞–∑–æ–º:</p>
<pre><code class="lang-bash">sso
‚îú‚îÄ‚îÄ cmd.............. –ö–æ–º–∞–Ω–¥—ã –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –∏ —É—Ç–∏–ª–∏—Ç
‚îÇ   ‚îú‚îÄ‚îÄ migrator..... –£—Ç–∏–ª–∏—Ç–∞ –¥–ª—è –º–∏–≥—Ä–∞—Ü–∏–π –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
‚îÇ   ‚îî‚îÄ‚îÄ sso.......... –û—Å–Ω–æ–≤–Ω–∞—è —Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞ –≤ —Å–µ—Ä–≤–∏—Å SSO
‚îú‚îÄ‚îÄ config........... –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ yaml-—Ñ–∞–π–ª—ã
‚îú‚îÄ‚îÄ internal......... –í–Ω—É—Ç—Ä–µ–Ω–Ω–æ—Å—Ç–∏ –ø—Ä–æ–µ–∫—Ç–∞
‚îÇ   ‚îú‚îÄ‚îÄ app.......... –ö–æ–¥ –¥–ª—è –∑–∞–ø—É—Å–∫–∞ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ grpc..... –ó–∞–ø—É—Å–∫ gRPC-—Å–µ—Ä–≤–µ—Ä–∞
‚îÇ   ‚îú‚îÄ‚îÄ config....... –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
‚îÇ   ‚îú‚îÄ‚îÄ domain
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ models... –°—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–∞–Ω–Ω—ã—Ö –∏ –º–æ–¥–µ–ª–∏ –¥–æ–º–µ–Ω–∞
‚îÇ   ‚îú‚îÄ‚îÄ grpc
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ auth..... gRPC-—Ö—ç–Ω–¥–ª–µ—Ä—ã —Å–µ—Ä–≤–∏—Å–∞ Auth
‚îÇ   ‚îú‚îÄ‚îÄ lib.......... –û–±—â–∏–µ –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —É—Ç–∏–ª–∏—Ç—ã –∏ —Ñ—É–Ω–∫—Ü–∏–∏
‚îÇ   ‚îú‚îÄ‚îÄ services..... –°–µ—Ä–≤–∏—Å–Ω—ã–π —Å–ª–æ–π (–±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ auth
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ permissions
‚îÇ   ‚îî‚îÄ‚îÄ storage...... –°–ª–æ–π —Ä–∞–±–æ—Ç—ã —Å –¥–∞–Ω–Ω—ã–º–∏ 
‚îÇ       ‚îî‚îÄ‚îÄ sqlite... –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –Ω–∞ SQLite
‚îú‚îÄ‚îÄ migrations....... –ú–∏–≥—Ä–∞—Ü–∏–∏ –¥–ª—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
‚îú‚îÄ‚îÄ storage.......... –§–∞–π–ª—ã —Ö—Ä–∞–Ω–∏–ª–∏—â–∞, –Ω–∞–ø—Ä–∏–º–µ—Ä SQLite –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
‚îî‚îÄ‚îÄ tests............ –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ —Ç–µ—Å—Ç—ã</code></pre>
<p>–ù–∞—á–Ω—ë–º —Å —Å–∞–º–æ–≥–æ –ø—Ä–æ—Å—Ç–æ–≥–æ ‚Äî —Å —Ç–æ—á–∫–∏ –≤—Ö–æ–¥–∞. –ü—Ä–æ–ø–∏—à–µ–º TODO:</p>
<pre><code class="lang-go">// cmd/sso/main.go
package main

func main() {  
    // TODO: –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –æ–±—ä–µ–∫—Ç –∫–æ–Ω—Ñ–∏–≥–∞
    // TODO: –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ª–æ–≥–≥–µ—Ä
    // TODO: –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ (app)
    // TODO: –∑–∞–ø—É—Å—Ç–∏—Ç—å gRPC-—Å–µ—Ä–≤–µ—Ä –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
}</code></pre>
<p>–ù–∞—á–Ω—ë–º –ø–æ –ø–æ—Ä—è–¥–∫—É, —Ç.–µ. —Å –∫–æ–Ω—Ñ–∏–≥–∞:</p>
<pre><code class="lang-go">// internal/config/config.go
package config

type Config struct {  
    Env            string     `yaml:"env" env-default:"local"`  
    StoragePath    string     `yaml:"storage_path" env-required:"true"`  
    GRPC           GRPCConfig `yaml:"grpc"`  
    MigrationsPath string  
    TokenTTL       time.Duration `yaml:"token_ttl" env-default:"1h"`  
}  

type GRPCConfig struct {  
    Port    int           `yaml:"port"`  
    Timeout time.Duration `yaml:"timeout"`  
}</code></pre>
<p>–≠—Ç–æ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã, –≤ –∫–æ—Ç–æ—Ä—ã–µ –±—É–¥–µ—Ç –∞–Ω–º–∞—Ä—à–∞–ª–ª–∏—Ç—å—Å—è (–ø–∞—Ä—Å–∏—Ç—å—Å—è) –∫–æ–Ω—Ñ–∏–≥-—Ñ–∞–π–ª. –¢–∞–∫–∂–µ –∑–¥–µ—Å—å –≤–∏–¥–∏–º struct-—Ç–µ–≥–∏. –î–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞ –∫–æ–Ω—Ñ–∏–≥–∞-—Ñ–∞–π–ª–∞ –±—É–¥–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±–∏–±–ª–∏–æ—Ç–µ–∫—É cleanenv, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ –∏ struct-—Ç–µ–≥–∏ –º—ã –∑–¥–µ—Å—å –ø–∏—à–µ–º –¥–ª—è –¥–ª—è –Ω–µ—ë.</p>
<p>–£—Å—Ç–∞–Ω–æ–≤–∏–º cleanenv:</p>
<pre><code class="lang-bash">go get github.com/ilyakaznacheev/cleanenv</code></pre>
<ul>
    <li><b>Env</b> ‚Äî —Ç–µ–∫—É—â–µ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ: local, dev, prod –∏ —Ç.–ø.</li>
    <li><b>StoragePath</b> ‚Äî –º—ã –±—É–¥–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å SQLite, –ø–æ—ç—Ç–æ–º—É –Ω—É–∂–Ω–æ —É–∫–∞–∑–∞—Ç—å –ø—É—Ç—å –¥–æ —Ñ–∞–π–ª–∞, –≥–¥–µ —Ö—Ä–∞–Ω–∏—Ç—Å—è –Ω–∞—à–∞ –ë–î</li>
    <li><b>GRPCConfig</b> ‚Äî –ø–æ—Ä—Ç gRPC-—Å–µ—Ä–≤–∏—Å–∞ –∏ —Ç–∞–π–º–∞—É—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–ø—Ä–æ—Å–æ–≤</li>
    <li><b>MigrationsPath</b> ‚Äî –ø—É—Ç—å –¥–æ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ —Å –º–∏–≥—Ä–∞—Ü–∏—è–º–∏ –ë–î. –û–Ω –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è —É—Ç–∏–ª–∏—Ç–æ–π migrator</li>
    <li><b>TokenTTL</b> ‚Äî –≤—Ä–µ–º—è –∂–∏–∑–Ω–∏ –≤—ã–¥–∞–≤–∞–µ–º—ã—Ö —Ç–æ–∫–µ–Ω–æ–≤ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏. –ù–∞ —Å–∞–º–æ–º –¥–µ–ª–µ, –≤—Ä–µ–º—è –∂–∏–∑–Ω–∏ ‚Äî —Å–ª–æ–∂–Ω–∞—è —à—Ç—É–∫–∞, –∏ –æ–Ω–æ –¥–æ–ª–∂–Ω–æ –∑–∞–≤–∏—Å–µ—Ç—å –æ—Ç —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Ñ–∞–∫—Ç–æ—Ä–æ–≤. –ù–æ –¥–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã —Å–¥–µ–ª–∞–µ–º –µ–≥–æ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–º, –∏ –±—É–¥–µ–º —Ö—Ä–∞–Ω–∏—Ç—å –≤ –∫–æ–Ω—Ñ–∏–≥–µ.</li>
</ul>
<p>–¢–µ–ø–µ—Ä—å –º–æ–∂–µ–º –Ω–∞–ø–∏—Å–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—é <b>MustLoad()</b>, –∫–æ—Ç–æ—Ä–∞—è –±—É–¥–µ—Ç –ø–∞—Ä—Å–∏—Ç—å —Ñ–∞–π–ª, –∞ —Ç–∞–∫–∂–µ –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é <b>fetchConfigPath()</b> –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø—É—Ç–∏ –¥–æ –∫–æ–Ω—Ñ–∏–≥-—Ñ–∞–π–ª–∞:</p>
<pre><code class="lang-go">// internal/config/config.go

func MustLoad() *Config {  
    configPath := fetchConfigPath()  
    if configPath == "" {  
        panic("config path is empty") 
    }  
    // check if file exists
    if _, err := os.Stat(configPath); os.IsNotExist(err) {
        panic("config file does not exist: " + configPath)
    }
    var cfg Config
    if err := cleanenv.ReadConfig(configPath, &cfg); err != nil {
        panic("config path is empty: " + err.Error())
    }
    return &cfg
}

// fetchConfigPath fetches config path from command line flag or environment variable.
// Priority: flag > env > default.
// Default value is empty string.
func fetchConfigPath() string {
    var res string
    flag.StringVar(&res, "config", "", "path to config file")
    flag.Parse()
    if res == "" {
        res = os.Getenv("CONFIG_PATH")
    }
    return res
}</code></pre>
<p>–ü–æ —Å–æ–≥–ª–∞—à–µ–Ω–∏—é, —Ñ—É–Ω–∫—Ü–∏–∏ —Å –ø—Ä–µ—Ñ–∏–∫—Å–æ–º Must –≤–º–µ—Å—Ç–æ –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏—è –æ—à–∏–±–æ–∫ —Å–æ–∑–¥–∞—é—Ç –ø–∞–Ω–∏–∫—É. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∏—Ö —Å –æ—Å—Ç–æ—Ä–æ–∂–Ω–æ—Å—Ç—å—é.</p>
<p>–ó–∞—á–µ–º –Ω—É–∂–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è fetchConfigPath()? –ù–∞—à–µ–º—É –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—é –Ω—É–∂–Ω–æ –ø–æ–Ω–∏–º–∞—Ç—å, –≥–¥–µ –∏—Å–∫–∞—Ç—å –∫–æ–Ω—Ñ–∏–≥-—Ñ–∞–π–ª, –¥–ª—è —ç—Ç–æ–≥–æ –Ω—É–∂–Ω–æ —É–∫–∞–∑–∞—Ç—å configPath. –°–¥–µ–ª–∞—Ç—å —ç—Ç–æ –º–æ–∂–Ω–æ —Ä–∞–∑–Ω—ã–º–∏ —Å–ø–æ—Å–æ–±–∞–º–∏, –Ω–∞–ø—Ä–∏–º–µ—Ä: —Ñ–ª–∞–≥ --config –∏–ª–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –æ–∫—Ä—É–∂–µ–Ω–∏—è CONFIG_PATH. –ù–∞—à–∞ —Ñ—É–Ω–∫—Ü–∏—è —Ä–µ–∞–ª–∏–∑—É–µ—Ç –æ–±–∞ –≤–∞—Ä–∏–∞–Ω—Ç–∞. –ï—Å–ª–∏ –≤–¥—Ä—É–≥ —É–∫–∞–∑–∞–Ω—ã –æ–±–∞ –∑–Ω–∞—á–µ–Ω–∏—è, —Ç–æ –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω —Ñ–ª–∞–≥.</p>
<p>–¢–æ –µ—Å—Ç—å, –∑–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –±—É–¥–µ—Ç –≤—ã–≥–ª—è–¥–µ—Ç—å —Ç–∞–∫ –≤ —Å–ª—É—á–∞–µ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –æ–∫—Ä—É–∂–µ–Ω–∏—è:</p>
<pre><code class="lang-bash">CONFIG_PATH=./path/to/config/file.yaml myApp</code></pre>
<p>–õ–∏–±–æ —Ç–∞–∫ –≤ —Å–ª—É—á–∞–µ —Ñ–ª–∞–≥–∞:</p>
<pre><code class="lang-bash">myApp --config=./path/to/config/file.yaml</code></pre>
<p>–¢–µ–ø–µ—Ä—å –¥–∞–≤–∞–π—Ç–µ –Ω–∞–ø–∏—à–µ–º —Å–∞–º –∫–æ–Ω—Ñ–∏–≥-—Ñ–∞–π–ª:</p>
<pre><code class="lang-bash"># config/config_local.yaml

env: "local"  
storage_path: "./storage/sso.db"  
grpc:  
    port: 44044  
    timeout: 10h</code></pre>
<p>–í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –∫ —Ñ—É–Ω–∫—Ü–∏–∏ main() –∏ —Å–æ–∑–¥–∞—ë–º —Ç–∞–º –æ–±—ä–µ–∫—Ç –∫–æ–Ω—Ñ–∏–≥–∞:</p>
<pre><code class="lang-go">// cmd/sso/main.go

func main() {
    cfg := config.MustLoad()
    ...
}</code></pre>
<p>–î–∞–ª–µ–µ –Ω–∞–ø–∏—à–µ–º –≤ —ç—Ç–æ–º –∂–µ —Ñ–∞–π–ª–µ —Ñ—É–Ω–∫—Ü–∏—é —Å–æ–∑–¥–∞–Ω–∏—è –æ–±—ä–µ–∫—Ç–∞ –ª–æ–≥–≥–µ—Ä–∞. –î–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –º—ã, –∫–æ–Ω–µ—á–Ω–æ –∂–µ, –±—É–¥–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –Ω–µ–¥–∞–≤–Ω–æ –≤—ã—à–µ–¥—à–∏–π log/slog, –∫–æ—Ç–æ—Ä—ã–π —è –æ—á–µ–Ω—å –ø–æ–ª—é–±–∏–ª –µ—â—ë –¥–æ –µ–≥–æ —Ä–µ–ª–∏–∑–∞:</p>
<pre><code class="lang-go">// cmd/sso/main.go

const (
    envLocal = "local"
    envDev   = "dev"
    envProd  = "prod"
)

func main() ...

func setupLogger(env string) *slog.Logger {
    var log *slog.Logger
    switch env {
    case envLocal:
        log = slog.New(slog.NewTextHandler(os.Stdout, &slog.HandlerOptions{Level: slog.LevelDebug}))
    case envDev:
        log = slog.New(slog.NewJSONHandler(os.Stdout, &slog.HandlerOptions{Level: slog.LevelDebug}))
    case envProd:
        log = slog.New(slog.NewJSONHandler(os.Stdout, &slog.HandlerOptions{Level: slog.LevelInfo}))
    }
    return log
}</code></pre>
<p>–ó–¥–µ—Å—å, –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–µ–∫—É—â–µ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è, —Å–æ–∑–¥–∞–µ–º –ª–æ–≥–≥–µ—Ä —Å —Ä–∞–∑–Ω—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏:</p>
<ul>
    <li><b>envLocal</b>: –ª–æ–∫–∞–ª—å–Ω—ã–π –∑–∞–ø—É—Å–∫ ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º TextHandler, —É–¥–æ–±–Ω—ã–π –¥–ª—è –∫–æ–Ω—Å–æ–ª–∏, –∏ —É—Ä–æ–≤–µ–Ω—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è Debug (—Ç.–µ. –±—É–¥–µ–º –≤—ã–≤–æ–¥–∏—Ç—å –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è)</li>
    <li><b>envDev</b>: –∑–∞–ø—É—Å–∫ –Ω–∞ —É–¥–∞–ª—ë–Ω–Ω–æ–º dev-—Å–µ—Ä–≤–µ—Ä–µ ‚Äî —É—Ä–æ–≤–µ–Ω—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–æ—Ç –∂–µ, –Ω–æ —Ñ–æ—Ä–º–∞—Ç –≤—ã–≤–æ–¥–∞ ‚Äî JSON, —É–¥–æ–±–Ω—ã–π –¥–ª—è —Å–∏—Å—Ç–µ–º —Å–±–æ—Ä–∞ –ª–æ–≥–æ–≤ (Kibana, Grafana Loki –∏ —Ç.–ø.)</li>
    <li><b>envProd</b>: –∑–∞–ø—É—Å–∫ –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ: –ø–æ–≤—ã—à–∞–µ–º —É—Ä–æ–≤–µ–Ω—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –¥–æ Info ‚Äî –Ω–∞–º –Ω–µ –Ω—É–∂–Ω—ã debug-–ª–æ–≥–∏ –≤ –ø—Ä–æ–¥–µ. –¢.–µ. –º—ã –±—É–¥–µ–º –ø–æ–ª—É—á–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è —Ç–æ–ª—å–∫–æ —Å —É—Ä–æ–≤–Ω–µ–º Info –∏–ª–∏ Error</li>
</ul>
<p>–î–æ–ø–∏—Å—ã–≤–∞–µ–º —Å–æ–∑–¥–∞–Ω–∏–µ –ª–æ–≥–≥–µ—Ä–∞ –≤ main():</p>
<pre><code class="lang-go">// cmd/sso/main.go

func main() {
    ...
    log := setupLogger(cfg.Env)
    ...</code></pre>
<h3 class="section-title" id="grpc_server">gRPC ‚Äî —Å–µ—Ä–≤–µ—Ä, –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–ø—Ä–æ—Å–æ–≤</h3>
<p>–û—Å—Ç–∞–≤–∏–º –Ω–µ–Ω–∞–¥–æ–ª–≥–æ –Ω–∞—à main.go –∏ —Å–ø—É—Å—Ç–∏–º—Å—è –Ω–∞ —É—Ä–æ–≤–µ–Ω—å –Ω–∏–∂–µ ‚Äî –Ω–∞–ø–∏—à–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∑–∞–ø—Ä–æ—Å–æ–≤. –ó–¥–µ—Å—å –Ω–∞–º –ø–æ–Ω–∞–¥–æ–±—è—Ç—Å—è —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —É—Ç–∏–ª–∏—Ç–æ–π protoc Go-—Ñ–∞–π–ª—ã, –∏–∑ –ø–∞–∫–µ—Ç–∞ protos, –∫–æ—Ç–æ—Ä—ã–π –º—ã –Ω–∞–ø–∏—Å–∞–ª–∏ —Ä–∞–Ω–µ–µ. –î–ª—è —ç—Ç–æ–≥–æ –ø–æ–¥–∫–ª—é—á–∏–º —ç—Ç–æ—Ç –ø–∞–∫–µ—Ç –∏ —Å–æ–∑–¥–∞–¥–∏–º —Ñ–∞–π–ª, –≤ –∫–æ—Ç–æ—Ä–æ–º –±—É–¥–µ–º –æ–ø–∏—Å—ã–≤–∞—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∑–∞–ø—Ä–æ—Å–æ–≤:</p>
<pre><code class="lang-go">// internal/grpc/auth/server.go
package server

import (
    "context"

    "google.golang.org/grpc"

    // –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–¥
    ssov1 "proto/gen/go/sso"
)

type serverAPI struct {
    ssov1.UnimplementedAuthServer // –•–∏—Ç—Ä–∞—è —à—Ç—É–∫–∞, –æ –Ω–µ–π –ø–æ–∑–∂–µ
    auth Auth
}

// –¢–æ—Ç —Å–∞–º—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å, –∫–æ—Ç–æ—Ä—ã–π –º—ã –ø–µ—Ä–µ–¥–∞–≤–∞–ª–∏ –≤ grpcApp
type Auth interface {
    Login(
        ctx context.Context,
        email string,
        password string,
        appID int,
    ) (token string, err error)
    RegisterNewUser(
        ctx context.Context,
        email string,
        password string,
    ) (userID int64, err error)
}

func Register(gRPCServer *grpc.Server, auth Auth) {  
    ssov1.RegisterAuthServer(gRPCServer, &serverAPI{auth: auth})  
}

func (s *serverAPI) Login(
    ctx context.Context,
    in *ssov1.LoginRequest,
) (*ssov1.LoginResponse, error) {
    // TODO
}

func (s *serverAPI) Register(
    ctx context.Context,
    in *ssov1.RegisterRequest,
) (*ssov1.RegisterResponse, error) {
    // TODO
}</code></pre>
<p>–ó–¥–µ—Å—å –º—ã –æ–ø–∏—Å–∞–ª–∏:</p>
<ul>
    <li>—Å—Ç—Ä—É–∫—Ç—É—Ä—É <b>serverAPI</b>, –∫–æ—Ç–æ—Ä–∞—è –±—É–¥–µ—Ç —Ä–µ–∞–ª–∏–∑–æ–≤—ã–≤–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª API</li>
    <li>–∫–∞—Ä–∫–∞—Å—ã –¥–ª—è –¥–≤—É—Ö <b>RPC-–º–µ—Ç–æ–¥–æ–≤</b>, –∫–æ—Ç–æ—Ä—ã–µ –º—ã –±—É–¥–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å: <b>Login</b> –∏ <b>Register</b> (–º–µ—Ç–æ–¥—ã —ç—Ç–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã <b>serverAPI</b>)</li>
    <li>–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –±—É–¥—É—â–µ–≥–æ <b>Auth</b> –∏–∑ —Å–µ—Ä–≤–∏—Å–Ω–æ–≥–æ —Å–ª–æ—è ‚Äî –µ–≥–æ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é –º—ã –Ω–∞–ø–∏—à–µ–º —á—É—Ç—å –ø–æ–∑–∂–µ, –∞ –ø–æ–∫–∞ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –≤ –∫–∞—á–µ—Å—Ç–≤–µ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞</li>
    <li>—Ç–∞–∫–∂–µ –∑–¥–µ—Å—å —É –Ω–∞—Å –µ—Å—Ç—å —Ñ—É–Ω–∫—Ü–∏—è <b>Register</b>, –∫–æ—Ç–æ—Ä–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç —ç—Ç—É <b>serverAPI</b> –≤ <b>gRPC-—Å–µ—Ä–≤–µ—Ä–µ</b></li>
</ul>
<p>–í —Å—Ç—Ä—É–∫—Ç—É—Ä–µ serverAPI —É –Ω–∞—Å —Ç–∞–∫–∂–µ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤–ª–æ–∂–µ–Ω–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ UnimplementedAuthServer ‚Äî protoc –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –µ—ë –Ω–∞ –æ—Å–Ω–æ–≤–µ proto-—Ñ–∞–π–ª–∞. –û–Ω–∞ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç —Å–æ–±–æ–π –Ω–µ–∫—É—é –ø—É—Å—Ç—É—é –∏–º–ø–ª–µ–º–µ–Ω—Ç–∞—Ü–∏—é –≤—Å–µ—Ö –º–µ—Ç–æ–¥–æ–≤ gRPC —Å–µ—Ä–≤–∏—Å–∞. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —ç—Ç–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –ø–æ–º–æ–≥–∞–µ—Ç –æ–±–µ—Å–ø–µ—á–∏—Ç—å –æ–±—Ä–∞—Ç–Ω—É—é —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ .proto —Ñ–∞–π–ª–∞. –ï—Å–ª–∏ –º—ã –¥–æ–±–∞–≤–∏–º –Ω–æ–≤—ã–π –º–µ—Ç–æ–¥ –≤ –Ω–∞—à .proto —Ñ–∞–π–ª –∏ –∑–∞–Ω–æ–≤–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∫–æ–¥, –Ω–æ –Ω–µ —Ä–µ–∞–ª–∏–∑—É–µ–º —ç—Ç–æ—Ç –º–µ—Ç–æ–¥ –≤ serverAPI, —Ç–æ –±–ª–∞–≥–æ–¥–∞—Ä—è –≤—Å—Ç—Ä–∞–∏–≤–∞–Ω–∏—é UnimplementedAuthServer –Ω–∞—à –∫–æ–¥ –≤—Å–µ —Ä–∞–≤–Ω–æ –±—É–¥–µ—Ç –∫–æ–º–ø–∏–ª–∏—Ä–æ–≤–∞—Ç—å—Å—è, –∞ –Ω–æ–≤—ã–π –º–µ—Ç–æ–¥ –ø—Ä–æ—Å—Ç–æ –≤–µ—Ä–Ω–µ—Ç –æ—à–∏–±–∫—É "Not implemented".</p>
<p>–û–±—Ä–∞—Ç–∏—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ, —á—Ç–æ —Ñ—É–Ω–∫—Ü–∏—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ (ssov1.RegisterAuthServer) –∏ –æ–±—ä–µ–∫—Ç—ã –∑–∞–ø—Ä–æ—Å–æ–≤ / –æ—Ç–≤–µ—Ç–æ–≤ –∑–∞ –Ω–∞—Å —Ç–∞–∫–∂–µ —É–∂–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω—ã, —á—Ç–æ –æ—á–µ–Ω—å —É–¥–æ–±–Ω–æ. –≠—Ç–æ —ç–∫–æ–Ω–æ–º–∏—Ç –∫—É—á—É –≤—Ä–µ–º–µ–Ω–∏.</p>
<p>–¢–µ–ø–µ—Ä—å –Ω–∞–ø–∏—à–µ–º —Ö—ç–Ω–¥–ª–µ—Ä—ã (–æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏) –∑–∞–ø—Ä–æ—Å–æ–≤:</p>
<pre><code class="lang-go">// internal/grpc/auth/server.go

import (
    ssov1 "proto/gen/go/sso"
)

func (s *serverAPI) Login(
    ctx context.Context,
    in *ssov1.LoginRequest,
) (*ssov1.LoginResponse, error) {
    if in.Email == "" {
        return nil, status.Error(codes.InvalidArgument, "email is required")
    }
    if in.Password == "" {
        return nil, status.Error(codes.InvalidArgument, "password is required")
    }
    if in.GetAppId() == 0 {
        return nil, status.Error(codes.InvalidArgument, "app_id is required")
    }
    token, err := s.auth.Login(ctx, in.GetEmail(), in.GetPassword(), int(in.GetAppId()))
    if err != nil {
        // –û—à–∏–±–∫—É auth.ErrInvalidCredentials –º—ã —Å–æ–∑–¥–∞–¥–∏–º –Ω–∏–∂–µ
        if errors.Is(err, auth.ErrInvalidCredentials) {
            return nil, status.Error(codes.InvalidArgument, "invalid email or password")
        }
        return nil, status.Error(codes.Internal, "failed to login")
    }
    return &ssov1.LoginResponse{Token: token}, nil
}</code></pre>
<p>–í–∞–ª–∏–¥–∞—Ü–∏—é –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –º–æ–∂–Ω–æ –≤—ã–Ω–µ—Å—Ç–∏ –≤ –æ—Ç–¥–µ–ª—å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é, –ø—Ä–∏ –∂–µ–ª–∞–Ω–∏–∏. –õ–∏–±–æ –¥–∞–∂–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤–Ω–µ—à–Ω–∏–π –ø–∞–∫–µ—Ç –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏.</p>
<p>–û–±—Ä–∞—Ç–∏—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ, —á—Ç–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—É—é –æ—à–∏–±–∫—É –º—ã —Å–æ–∑–¥–∞–µ–º —Å –ø–æ–º–æ—â—å—é —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–∏ status.Error –∏–∑ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ grpc/status. –≠—Ç–æ –Ω—É–∂–Ω–æ –¥–ª—è —Ç–æ–≥–æ, —á—Ç–æ–±—ã —Ñ–æ—Ä–º–∞—Ç –æ—à–∏–±–∫–∏ –±—ã–ª –ø–æ–Ω—è—Ç–µ–Ω –ª—é–±–æ–º—É grpc-–∫–ª–∏–µ–Ω—Ç—É.</p>
<p>–ö—Ä–æ–º–µ —Ç–æ–≥–æ, –º—ã –ø—Ä–∏—Å–≤–∞–∏–≤–∞–µ–º —ç—Ç–æ–π –æ—à–∏–±–∫–µ –∫–æ–¥ –∏–∑ –ø–∞–∫–µ—Ç–∞ grpc/codes ‚Äî —ç—Ç–æ —Ç–æ–∂–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å –∫–ª–∏–µ–Ω—Ç–∞–º–∏. –†–µ–∫–æ–º–µ–Ω–¥—É—é –≤—Å–µ–≥–¥–∞ –≤—ã–±–∏—Ä–∞—Ç—å –ø–æ–¥—Ö–æ–¥—è—â–∏–µ –∫–æ–¥—ã –æ—à–∏–±–æ–∫ –¥–ª—è –∫–∞–∂–¥–æ–π —Å–∏—Ç—É–∞—Ü–∏–∏. –ö –ø—Ä–∏–º–µ—Ä—É, –µ—Å–ª–∏ –Ω–µ –ø–æ–¥–æ—à–µ–ª –ø–∞—Ä–æ–ª—å –∏–ª–∏ –º—ã –Ω–µ –Ω–∞—à–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ë–î, —ç—Ç–æ ‚Äî codes.InvalidArgument, –µ—Å–ª–∏ –∂–µ –ë–î –≤–µ—Ä–Ω—É–ª–∞ –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω—É—é –æ—à–∏–±–∫—É, —ç—Ç–æ —É–∂–µ codes.Internal.</p>
<p>–í—Å—ë —ç—Ç–æ —Å–¥–µ–ª–∞–µ—Ç —Ä–∞–±–æ—Ç—É —Å –Ω–∞—à–∏–º —Å–µ—Ä–≤–µ—Ä–æ–º –≥–æ—Ä–∞–∑–¥–æ –±–æ–ª–µ–µ —É–¥–æ–±–Ω–æ–π –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ –∫–ª–∏–µ–Ω—Ç–∞.</p>
<p>–¢–µ–ø–µ—Ä—å –º–µ—Ç–æ–¥ Register():</p>
<pre><code class="lang-go">// internal/grpc/auth/server.go
...
func (s *serverAPI) Register(
    ctx context.Context,
    in *ssov1.RegisterRequest,
) (*ssov1.RegisterResponse, error) {
    if in.Email == "" {
        return nil, status.Error(codes.InvalidArgument, "email is required")
    }
    if in.Password == "" {
        return nil, status.Error(codes.InvalidArgument, "password is required")
    }
    uid, err := s.auth.RegisterNewUser(ctx, in.GetEmail(), in.GetPassword())
    if err != nil {
        // –û—à–∏–±–∫—É storage.ErrUserExists –º—ã —Å–æ–∑–¥–∞–¥–∏–º –Ω–∏–∂–µ
        if errors.Is(err, storage.ErrUserExists) {
            return nil, status.Error(codes.AlreadyExists, "user already exists")
        }
        return nil, status.Error(codes.Internal, "failed to register user")
    }
    return &ssov1.RegisterResponse{UserId: uid}, nil
}</code></pre>
<p>–ö–∞–∫ –≤–∏–¥–∏–º, –Ω–∞—à–∏ —Ö—ç–Ω–¥–ª–µ—Ä—ã –æ—á–µ–Ω—å –ø—Ä–æ—Å—Ç—ã–µ, –∏ –Ω–∞ —ç—Ç–æ–º –æ–Ω–∏ –ø–æ–ª–Ω–æ—Å—Ç—å—é –≥–æ—Ç–æ–≤—ã. –í—Å—è –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ –±—É–¥–µ—Ç –≤ —Å–µ—Ä–≤–∏—Å–Ω–æ–º —Å–ª–æ–µ, –¥–∞–≤–∞–π—Ç–µ –ø–µ—Ä–µ–π–¥—ë–º –∫ –Ω–µ–º—É.</p>
<h3 class="section-title" id="service_auth">–°–µ—Ä–≤–∏—Å–Ω—ã–π —Å–ª–æ–π. Auth</h3>
<p>–ù–∞—à —Å–µ—Ä–≤–∏—Å –±—É–¥–µ—Ç —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –Ω–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ –ª–æ–≥–∏–Ω–∏—Ç—å –∏—Ö, –≤—ã–¥–∞–≤–∞—è —Ç–æ–∫–µ–Ω—ã. –û—á–µ–≤–∏–¥–Ω–æ, —á—Ç–æ –µ–º—É –Ω—É–∂–µ–Ω –Ω–µ–∫–∏–π Storage (—Ö—Ä–∞–Ω–∏–ª–∏—â–µ), –∫–æ—Ç–æ—Ä—ã–π —É–º–µ–µ—Ç —Å–æ—Ö—Ä–∞–Ω—è—Ç—å –∏ –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è—Ö ‚Äî —ç—Ç–æ –±—É–¥–µ—Ç —É–∂–µ —Å–ª–æ–π —Ä–∞–±–æ—Ç—ã —Å –¥–∞–Ω–Ω—ã–º–∏. –ö –µ–≥–æ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –º—ã –ø—Ä–∏—Å—Ç—É–ø–∏–º –≤ —Å–ª–µ–¥—É—é—â–µ–º —Ä–∞–∑–¥–µ–ª–µ, –∞ –ø–æ–∫–∞ –Ω–∞–º, –∫–∞–∫ –æ–±—ã—á–Ω–æ, –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞.</p>
<p>–î–ª—è —É–¥–æ–±—Å—Ç–≤–∞ –æ–±–º–µ–Ω–∞ –¥–∞–Ω–Ω—ã–º–∏ –º–µ–∂–¥—É —ç—Ç–∏–º–∏ —Å–ª–æ—è–º–∏ –æ–ø–∏—à–µ–º –º–æ–¥–µ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:</p>
<pre><code class="lang-go">// internal/domain/models/user.go
package models

type User struct {
    ID       int64
    Email    string
    PassHash []byte
}</code></pre>
<p>–û–±—Ä–∞—Ç–∏—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ, —á—Ç–æ –ø–∞–ø–∫–∞ models –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ internal/domain ‚Äî —Ç—É—Ç –±—É–¥—É—Ç —Ö—Ä–∞–Ω–∏—Ç—å—Å—è –æ–±—â–∏–µ –º–æ–¥–µ–ª–∏ –¥–ª—è –≤—Å–µ–≥–æ –¥–æ–º–µ–Ω–∞, –∞ –Ω–µ —Ç–æ–ª—å–∫–æ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Å–ª–æ—è. –¢–æ –µ—Å—Ç—å, –º—ã –º–æ–∂–µ–º —Å–≤–æ–±–æ–¥–Ω–æ –∏–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è, –≤ —Ç–æ–º —á–∏—Å–ª–µ –∏ –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ –º–µ–∂–¥—É —Å–ª–æ—è–º–∏.</p>
<p>–¢–µ–ø–µ—Ä—å –º–æ–∂–µ–º –æ–ø–∏—Å–∞—Ç—å –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å —Ö—Ä–∞–Ω–∏–ª–∏—â–∞:</p>
<pre><code class="lang-go">// internal/services/auth/auth.go
package auth

import "proto_sso/internal/domain/models"

type UserSaver interface {
    SaveUser(
        ctx context.Context,
        email string,
        passHash []byte,
    ) (uid int64, err error)
}

type UserProvider interface {  
    User(ctx context.Context, email string) (models.User, error)  
}</code></pre>
<p>–£ –Ω–∞—Å —Ç—É—Ç –¥–≤–∞ —Ä–∞–∑–Ω—ã—Ö –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞, —É –∫–∞–∂–¥–æ–≥–æ –∏–∑ –∫–æ—Ç–æ—Ä—ã—Ö —Å–≤–æ—è —É–∑–∫–∞—è –æ–±–ª–∞—Å—Ç—å –ø—Ä–∏–º–µ–Ω–∏–º–æ—Å—Ç–∏. –≠—Ç–æ –¥–µ–ª–∞–µ—Ç –Ω–∞—à –∫–æ–¥ –±–æ–ª–µ–µ –≥–∏–±–∫–∏–º, –≤–µ–¥—å –∫—Ç–æ —Å–∫–∞–∑–∞–ª, —á—Ç–æ –∑–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏ –ø–æ–ª—É—á–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –æ–±—è–∑–∞–Ω–∞ –æ—Ç–≤–µ—á–∞—Ç—å –æ–¥–Ω–∞ —Å–∏—Å—Ç–µ–º–∞? –í–æ–∑–º–æ–∂–Ω–æ, –º—ã –∑–∞—Ö–æ—Ç–∏–º —Å–æ—Ö—Ä–∞–Ω—è—Ç—å –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ —á–µ—Ä–µ–∑ –∫–∞—Ñ–∫—É, –∞ –ø–æ–ª—É—á–∞—Ç—å –≤–æ–æ–±—â–µ gRPC / HTTP –∑–∞–ø—Ä–æ—Å–æ–º? –ö–æ–Ω–µ—á–Ω–æ, —á—Ç–æ —ç—Ç–æ —Ä–µ–¥–∫–∏–µ –∫–µ–π—Å—ã, –∏ –Ω–µ –Ω—É–∂–Ω–æ –∑–∞—Ç–∞—á–∏–≤–∞—Ç—å –∫–æ–¥ –ø–æ–¥ –≤—Å—ë –ø–æ–¥—Ä—è–¥, –Ω–æ –≤–µ–¥—å –∏ —Ü–µ–Ω–∞ –∑–∞ —ç—Ç–æ –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏ –Ω—É–ª–µ–≤–∞—è.</p>
<p>–ö—Ä–æ–º–µ —Ç–æ–≥–æ, –º–∏–Ω–∏–º–∞–ª–∏—Å—Ç–∏—á–Ω—ã–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã –ø—Ä–æ—â–µ —Ä–µ–∞–ª–∏–∑–æ–≤—ã–≤–∞—Ç—å –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å. –í—Å—è–∫–æ —É–¥–æ–±–Ω–µ–π, —á–µ–º –Ω–µ–∫–∏–π –æ–±—â–∏–π UserStorage, —Å–æ—Å—Ç–æ—è—â–∏–π –∏–∑ 50 –º–µ—Ç–æ–¥–æ–≤, –∏ –∫–æ—Ç–æ—Ä—ã–π –≤–æ –≤—Å–µ—Ö —Å–ª—É—á–∞—è—Ö –Ω—É–∂–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤—ã–≤–∞—Ç—å —Ü–µ–ª–∏–∫–æ–º, –¥–∞–∂–µ –µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ª–∏—à—å –æ–¥–∏–Ω –º–µ—Ç–æ–¥.</p>
<p>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É –Ω–∞—Å –±—É–¥–µ—Ç –ª–æ–≥–∏–Ω–∏—Ç—å—Å—è –Ω–µ –≤–æ –≤—Å–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è —Å—Ä–∞–∑—É, –∞ —Ç–æ–ª—å–∫–æ –≤ –æ–¥–Ω–æ –∫–∞–∫–æ–µ-—Ç–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ, –∏ –µ–≥–æ JWT-—Ç–æ–∫–µ–Ω –ø–æ–¥–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –∫–ª—é—á–æ–º –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è. –í –Ω–∞—à–µ–º —Å–ª—É—á–∞–µ, –æ–Ω –ª–æ–≥–∏–Ω–∏—Ç—Å—è –≤ URL Shortener. –≠—Ç–æ –∑–Ω–∞—á–∏—Ç, —á—Ç–æ –ø–æ–º–∏–º–æ —Ä–∞–±–æ—Ç—ã —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏, –Ω–∞–º –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —Ç–∞–∫–∂–µ –ø–æ–ª—É—á–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è—Ö (App). –î–ª—è –Ω–∞—á–∞–ª–∞, –Ω–∞–º –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ ID –∏ —Å–µ–∫—Ä–µ—Ç–Ω–æ–≥–æ –∫–ª—é—á–∞. –ó–∞–≤–µ–¥—ë–º –¥–ª—è —ç—Ç–æ–≥–æ –º–æ–¥–µ–ª—å App:</p>
<pre><code class="lang-go">// internal/domain/models/app.go
package models

type App struct {
    ID     int
    Name   string
    Secret string
}</code></pre>
<p>–ò –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è App –∏–∑ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞:</p>
<pre><code class="lang-go">// internal/services/auth/auth.go
...
type AppProvider interface {  
    App(ctx context.Context, appID int) (models.App, error)  
}</code></pre>
<p>–¢–µ–ø–µ—Ä—å –º—ã –º–æ–∂–µ–º –Ω–∞–ø–∏—Å–∞—Ç—å –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –¥–ª—è —Å–µ—Ä–≤–∏—Å–∞ Auth:</p>
<pre><code class="lang-go">// internal/services/auth/auth.go
...
type Auth struct {
    log         *slog.Logger
    usrSaver    UserSaver
    usrProvider UserProvider
    appProvider AppProvider
    tokenTTL    time.Duration
}

func New(  
    log *slog.Logger,  
    userSaver UserSaver,  
    userProvider UserProvider,  
    appProvider AppProvider,  
    tokenTTL time.Duration,  
) *Auth {  
    return &Auth{  
        usrSaver:    userSaver,  
        usrProvider: userProvider,  
        log:         log,  
        appProvider: appProvider,  
        tokenTTL:    tokenTTL,  // –í—Ä–µ–º—è –∂–∏–∑–Ω–∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—ã—Ö —Ç–æ–∫–µ–Ω–æ–≤
    }  
}</code></pre>
<p>–û–±—Ä–∞—Ç–∏—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ ‚Äî –º—ã –ø–µ—Ä–µ–¥–∞—ë–º userSaver, userProvider –∏ appProvider –æ—Ç–¥–µ–ª—å–Ω—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏, —Ö–æ—Ç—è —É –Ω–∏—Ö —É –≤—Å–µ—Ö –±—É–¥–µ—Ç –æ–±—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è. –¢.–µ. –º—ã –±—É–¥–µ–º –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å –æ–¥–∏–Ω –æ–±—ä–µ–∫—Ç –≤ —Ç—Ä–∏ –∞—Ä–≥—É–º–µ–Ω—Ç–∞.</p>
<p>–ß—Ç–æ–±—ã –±—ã–ª–æ —É–¥–æ–±–Ω–µ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –ª–æ–≥–∞–º–∏, –¥–æ–±–∞–≤–∏–º –ø—Ä–æ—Å—Ç–µ–Ω—å–∫—É—é –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é:</p>
<pre><code class="lang-go">// internal/lib/logger/sl/sl.go
package sl

func Err(err error) slog.Attr {
    return slog.Attr{
        Key:   "error",
        Value: slog.StringValue(err.Error()),
    }
}</code></pre>
<p>–ò —Ç–µ–ø–µ—Ä—å –æ—à–∏–±–∫–∏ –º–æ–∂–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å –≤–æ—Ç —Ç–∞–∫–∏–º –æ–±—Ä–∞–∑–æ–º:</p>
<pre><code class="lang-go">if err != nil {
    a.log.Error("failed to get user", sl.Err(err))
}</code></pre>
<p><b>–ú–µ—Ç–æ–¥ RegisterNewUser</b></p>
<p>–ü–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞–∫–æ–Ω–µ—Ü –∫ –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–µ ‚Äî –∫ –º–µ—Ç–æ–¥–∞–º RegisterNewUser –∏ Login. –ù–∞—á–Ω—ë–º —Å –ø–µ—Ä–≤–æ–≥–æ. –î–ª—è –Ω–µ–≥–æ –Ω–∞–º —Ç–∞–∫–∂–µ –ø–æ–Ω–∞–¥–æ–±–∏—Ç—Å—è –≤–Ω–µ—à–Ω–∏–π –ø–∞–∫–µ—Ç crypto/bcrypt ‚Äî —É—Å—Ç–∞–Ω–æ–≤–∏–º:</p>
<pre><code class="lang-bash">go get golang.org/x/crypto</code></pre>
<pre><code class="lang-go">// internal/services/auth/auth.go

// RegisterNewUser registers new user in the system and returns user ID.
// If user with given username already exists, returns error.
func (a *Auth) RegisterNewUser(ctx context.Context, email string, pass string) (int64, error) {
    // op (operation) - –∏–º—è —Ç–µ–∫—É—â–µ–π —Ñ—É–Ω–∫—Ü–∏–∏ –∏ –ø–∞–∫–µ—Ç–∞. –¢–∞–∫—É—é –º–µ—Ç–∫—É —É–¥–æ–±–Ω–æ
    // –¥–æ–±–∞–≤–ª—è—Ç—å –≤ –ª–æ–≥–∏ –∏ –≤ —Ç–µ–∫—Å—Ç –æ—à–∏–±–æ–∫, —á—Ç–æ–±—ã –ª–µ–≥—á–µ –±—ã–ª–æ –∏—Å–∫–∞—Ç—å —Ö–≤–æ—Å—Ç—ã
    // –≤ —Å–ª—É—á–∞–µ –ø–æ–ª–æ–º–æ–∫.
    const op = "Auth.RegisterNewUser"
    // –°–æ–∑–¥–∞—ë–º –ª–æ–∫–∞–ª—å–Ω—ã–π –æ–±—ä–µ–∫—Ç –ª–æ–≥–≥–µ—Ä–∞ —Å –¥–æ–ø. –ø–æ–ª—è–º–∏, —Å–æ–¥–µ—Ä–∂–∞—â–∏–º–∏ –ø–æ–ª–µ–∑–Ω—É—é –∏–Ω—Ñ—É
    // –æ —Ç–µ–∫—É—â–µ–º –≤—ã–∑–æ–≤–µ —Ñ—É–Ω–∫—Ü–∏–∏
    log := a.log.With(
        slog.String("op", op),
        slog.String("email", email),
    )
    log.Info("registering user")
    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Ö—ç—à –∏ —Å–æ–ª—å –¥–ª—è –ø–∞—Ä–æ–ª—è.
    passHash, err := bcrypt.GenerateFromPassword([]byte(pass), bcrypt.DefaultCost)
    if err != nil {
        log.Error("failed to generate password hash", sl.Err(err))
        return 0, fmt.Errorf("%s: %w", op, err)
    }
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ë–î
    id, err := a.usrSaver.SaveUser(ctx, email, passHash)
    if err != nil {
        log.Error("failed to save user", sl.Err(err))
        return 0, fmt.Errorf("%s: %w", op, err)
    }
    return id, nil
}</code></pre>
<p>–ó–¥–µ—Å—å –≤–∞–∂–Ω–æ —Ä–∞–∑–æ–±—Ä–∞—Ç—å—Å—è, —á—Ç–æ –¥–µ–ª–∞–µ—Ç —Ñ—É–Ω–∫—Ü–∏—è bcrypt.GenerateFromPassword(). –í —á–∏—Å—Ç–æ–º –≤–∏–¥–µ –ø–∞—Ä–æ–ª—å —Ö—Ä–∞–Ω–∏—Ç—å –Ω–µ–ª—å–∑—è ‚Äî —ç—Ç–æ —á—Ä–µ–≤–∞—Ç–æ —É—Ç–µ—á–∫–∞–º–∏: –µ—Å–ª–∏ –∑–ª–æ—É–º—ã—à–ª–µ–Ω–Ω–∏–∫ —É–∫—Ä–∞–¥—ë—Ç –Ω–∞—à—É –ë–î, –æ–Ω —É–∑–Ω–∞–µ—Ç –ø–∞—Ä–æ–ª–∏ –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –ø–æ–ª—É—á–∏—Ç –¥–æ—Å—Ç—É–ø –∫ –∏—Ö –∞–∫–∫–∞—É–Ω—Ç–∞–º –∏ —Ç.–ø. </p>
<p>–ß—Ç–æ–±—ã —ç—Ç–æ–≥–æ –∏–∑–±–µ–∂–∞—Ç—å, –º—ã –º–æ–∂–µ–º –±—Ä–∞—Ç—å —Ö—ç—à –æ—Ç –ø–∞—Ä–æ–ª—è –∏ —Ö—Ä–∞–Ω–∏—Ç—å —É–∂–µ –µ–≥–æ, –∞ –∫–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ø—ã—Ç–∞–µ—Ç—Å—è –∑–∞–ª–æ–≥–∏–Ω–∏—Ç—å—Å—è, –º—ã —Å–Ω–æ–≤–∞ –≤–æ–∑—å–º—ë–º —Ö—ç—à –æ—Ç –ø–æ–ª—É—á–µ–Ω–Ω–æ–≥–æ –ø–∞—Ä–æ–ª—è –∏ —Å—Ä–∞–≤–Ω–∏–º —Ö—ç—à–∏ –≤–º–µ—Å—Ç–æ –ø—Ä—è–º–æ–≥–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –¥–≤—É—Ö –ø–∞—Ä–æ–ª–µ–π. –ù–æ —ç—Ç–æ —Ç–æ–∂–µ –æ–ø–∞—Å–Ω–æ, —Ç.–∫. –µ—Å–ª–∏ –∑–ª–æ—É–º—ã—à–ª–µ–Ω–Ω–∏–∫ –ø–æ–¥–±–µ—Ä—ë—Ç –∏–ª–∏ —É–∫—Ä–∞–¥—ë—Ç —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –ø–∞—Ä–æ–ª—å, —Ç–æ –æ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–ª—É—á–∞–µ—Ç –¥–æ—Å—Ç—É–ø –∫–æ –≤—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º —Å —Ç–∞–∫–∏–º –∂–µ –ø–∞—Ä–æ–ª–µ–º (—Ç.–∫. —É –Ω–∏—Ö –±—É–¥–µ—Ç —Ç–∞–∫–æ–π –∂–µ —Ö—ç—à). –ö—Ä–æ–º–µ —Ç–æ–≥–æ, –µ—Å—Ç—å —Å–ø–æ—Å–æ–±—ã –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–æ —Ö—ç—à—É –ø–∞—Ä–æ–ª—å, –æ—Å–æ–±–µ–Ω–Ω–æ –µ—Å–ª–∏ —ç—Ç–æ –ø—Ä–æ—Å—Ç–µ–Ω—å–∫–∏–π –ø–æ–ø—É–ª—è—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å.</p>
<p>–ß—Ç–æ –∂–µ –¥–µ–ª–∞—Ç—å? –†–µ—à–µ–Ω–∏–µ –ø—Ä–æ—Å—Ç–æ–µ ‚Äî —Å–æ–∑–¥–∞—ë–º —Å–ª—É—á–∞–π–Ω—É—é —Å—Ç—Ä–æ–∫—É (–µ—ë –Ω–∞–∑—ã–≤–∞—é—Ç ‚Äî —Å–æ–ª—å, salt), –¥–æ–±–∞–≤–ª—è–µ–º –µ—ë –∫ –ø–∞—Ä–æ–ª—é: &lt;password&gt;+&lt;salt&gt;, –±–µ—Ä—ë–º —Ö—ç—à –æ—Ç —Ç–æ–≥–æ —á—Ç–æ –ø–æ–ª—É—á–∏–ª–æ—Å—å, —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –ë–î –∏ —Ä—è–¥–æ–º –≤ –æ—Ç–∫—Ä—ã—Ç–æ–º –≤–∏–¥–µ —Ç–∞–∫–∂–µ —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ–ª—å. –ö–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –±—É–¥–µ—Ç –ª–æ–≥–∏–Ω–∏—Ç—å—Å—è, –º—ã –±—É–¥–µ–º –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ –¥–æ–±–∞–≤–ª—è—Ç—å —Å–æ–ª—å –∫ –ø—Ä–∏—Å—ã–ª–∞–µ–º—ã–º –ø–∞—Ä–æ–ª—è–º –∏ —Å—Ä–∞–≤–Ω–∏–≤–∞—Ç—å —Ö—ç—à–∏. –¢–∞–∫–æ–π –≤–∞—Ä–∏–∞–Ω—Ç –Ω–∞–º–Ω–æ–≥–æ –±–µ–∑–æ–ø–∞—Å–Ω–µ–π, –ø–∞—Ä–æ–ª—å —Å–ª–æ–∂–Ω–µ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏ —Å–ª–∏–≤ –æ–¥–Ω–æ–≥–æ –ø–∞—Ä–æ–ª—è –Ω–µ –ø–æ–º–æ–∂–µ—Ç –ø–æ–¥–æ–±—Ä–∞—Ç—å –æ—Å—Ç–∞–ª—å–Ω—ã–µ.</p>
<p>–§—É–Ω–∫—Ü–∏—è bcrypt.GenerateFromPassword() –≤—ã–ø–æ–ª–Ω—è–µ—Ç –ø—Ä–æ—Ü–µ–¥—É—Ä—É –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ö—ç—à–∞ –∏ —Å–æ–ª–∏ –∑–∞ –Ω–∞—Å. –û–Ω–∞ –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –Ω–∞ –≤—Ö–æ–¥ –ø–∞—Ä–æ–ª—å, –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Å–æ–ª—å, —Ö—ç—à–∏—Ä—É–µ—Ç –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç –µ–¥–∏–Ω–æ–π —Å—Ç—Ä–æ–∫–æ–π. –í —ç—Ç–æ–π —Å—Ç—Ä–æ–∫–µ —Å–æ–¥–µ—Ä–∂–∏—Ç—Å—è –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –∏ —Ö—ç—à, –∏ —Å–æ–ª—å, —á—Ç–æ –æ—á–µ–Ω—å —É–¥–æ–±–Ω–æ ‚Äî –≤–µ–¥—å –Ω–∞–º –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ.</p>
<p>–£ —ç—Ç–æ–π —Ñ—É–Ω–∫—Ü–∏–∏ –µ—Å—Ç—å –≤—Ç–æ—Ä–æ–π –∞—Ä–≥—É–º–µ–Ω—Ç ‚Äî bcrypt.DefaultCost. –ß–µ–º –≤—ã—à–µ –∑–Ω–∞—á–µ–Ω–∏–µ —ç—Ç–æ–≥–æ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞, —Ç–µ–º –ª—É—á—à–µ –∑–∞—â–∏—â–µ–Ω –ø–∞—Ä–æ–ª—å, –Ω–æ —Ç–µ–º —Å–ª–æ–∂–Ω–µ–µ –∞–ª–≥–æ—Ä–∏—Ç–º –µ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è. –î–ª—è –ø–µ—Ç-–ø—Ä–æ–µ–∫—Ç–∞ –ª—É—á—à–µ –≤—ã–±—Ä–∞—Ç—å DefaultCost, –∞ –¥–ª—è –±–æ–ª–µ–µ —Å–µ—Ä—å–µ–∑–Ω—ã—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤ —Å—Ç–æ–∏—Ç –∏–∑—É—á–∏—Ç—å —ç—Ç—É —Ç–µ–º—É –≥–ª—É–±–∂–µ.</p>
<p>–¢–∞–∫–∏–º –æ–±—Ä–∞–∑–æ–º, –≤ —Å–ª—É—á–∞–µ –ø–æ–ø—ã—Ç–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –º—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ñ—É–Ω–∫—Ü–∏—é bcrypt.CompareHashAndPassword(savedHash, loginPassword), –∫–æ—Ç–æ—Ä–∞—è –≤—ã–ø–æ–ª–Ω–∏—Ç –∑–∞ –Ω–∞—Å –≤—Å—é —Ä–∞–±–æ—Ç—É –ø–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—é –∏ —Å–æ–æ–±—â–∏—Ç ‚Äî –ø–æ–¥—Ö–æ–¥–∏—Ç –ø–∞—Ä–æ–ª—å –∏–ª–∏ –Ω–µ—Ç.</p>
<p>–ü–µ—Ä–µ–¥ —Ç–µ–º –∫–∞–∫ –ø–µ—Ä–µ–π—Ç–∏ –Ω–µ–ø–æ—Å—Ä–µ–¥—Å—Ç–≤–µ–Ω–Ω–æ –∫ –º–µ—Ç–æ–¥—É Login, –Ω–∞–º –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –Ω–∞–ø–∏—Å–∞—Ç—å –∫–æ–¥ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ JWT-—Ç–æ–∫–µ–Ω–æ–≤, —Ç.–∫. —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Ä–∞–±–æ—Ç—ã —ç—Ç–æ–≥–æ –º–µ—Ç–æ–¥–∞ ‚Äî –ø–æ–ª—É—á–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏.</p>
<p><b>–ì–µ–Ω–µ—Ä–∞—Ü–∏—è JWT-—Ç–æ–∫–µ–Ω–∞ –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏</b></p>
<p>–î–ª—è —Ä–∞–±–æ—Ç—ã —Å JWT –º—ã –±—É–¥–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–ª–µ–¥—É—é—â—É—é –±–∏–±–ª–∏–æ—Ç–µ–∫—É:</p>
<pre><code class="lang-bash">go get github.com/golang-jwt/jwt/v5</code></pre>
<p>–¢–æ–∫–µ–Ω –±—É–¥–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å –≤ —Å–µ–±–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ –∏ –æ —Ç–µ–∫—É—â–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏. –ú–æ–∂–Ω–æ –≤—Å–µ —ç—Ç–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å –¥–ª–∏–Ω–Ω—ã–º —Å–ø–∏—Å–∫–æ–º –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤, –ª–∏–±–æ –º–æ–∂–Ω–æ –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å —Å—Ä–∞–∑—É –º–æ–¥–µ–ª–∏ User –∏ App. –¢–µ–ø–µ—Ä—å –º–æ–∂–µ–º –Ω–∞–ø–∏—Å–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—é –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ç–æ–∫–µ–Ω–∞:</p>
<pre><code class="lang-go">// internal/lib/jwt/jwt.go
package jwt

import (
    ...
	"github.com/golang-jwt/jwt/v5"
)

// NewToken creates new JWT token for given user and app.
func NewToken(user models.User, app models.App, duration time.Duration) (string, error) {  
    token := jwt.New(jwt.SigningMethodHS256)  
    // –î–æ–±–∞–≤–ª—è–µ–º –≤ —Ç–æ–∫–µ–Ω –≤—Å—é –Ω–µ–æ–±—Ö–æ–¥–∏–º—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
    claims := token.Claims.(jwt.MapClaims)  
    claims["uid"] = user.ID  
    claims["email"] = user.Email  
    claims["exp"] = time.Now().Add(duration).Unix()  
    claims["app_id"] = app.ID  
    // –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º —Ç–æ–∫–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É—è —Å–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    tokenString, err := token.SignedString([]byte(app.Secret))  
    if err != nil {  
        return "", err  
    }  
    return tokenString, nil  
}</code></pre>
<p>–û–±—Ä–∞—Ç–∏—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–∞ —ç—Ç—É —Å—Ç—Ä–æ—á–∫—É: claims["exp"] = time.Now().Add(duration).Unix(). –í –Ω–µ–π –º—ã –∑–∞–¥–∞—ë–º —Å—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è (TTL) —Ç–æ–∫–µ–Ω–∞ –≤ –≤–∏–¥–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –≤—Ä–µ–º–µ–Ω–Ω–æ–π –º–µ—Ç–∫–∏, –¥–æ –∫–æ—Ç–æ—Ä–æ–π –æ–Ω –±—É–¥–µ—Ç —Å—á–∏—Ç–∞—Ç—å—Å—è –≤–∞–ª–∏–¥–Ω—ã–º. –ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ –¥–µ–¥–ª–∞–π–Ω–∞ —Ç–æ–∫–µ–Ω –±—É–¥–µ—Ç —Å—á–∏—Ç–∞—Ç—å—Å—è "–ø—Ä–æ—Ç—É—Ö—à–∏–º", –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ –∫–ª–∏–µ–Ω—Ç–∞ –º—ã –µ–≥–æ –Ω–µ –±—É–¥–µ–º –ø—Ä–∏–Ω–∏–º–∞—Ç—å.</p>
<p><b>–ú–µ—Ç–æ–¥ Login</b></p>
<p>–¢–µ–ø–µ—Ä—å –Ω–∞–ø–∏—à–µ–º –º–µ—Ç–æ–¥ Login. –û–±—Ä–∞—Ç–∏—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ! –¢–µ–∫—É—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –º–µ—Ç–æ–¥–∞ –∏–º–µ–µ—Ç –æ–¥–Ω—É –∫—Ä–∏—Ç–∏—á–Ω—É—é –¥—ã—Ä—É –≤ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ ‚Äî –æ–Ω –Ω–µ –∑–∞—â–∏—â–µ–Ω –æ—Ç –±—Ä—É—Ç—Ñ–æ—Ä—Å–∞ (–ø–µ—Ä–µ–±–æ—Ä–∞ –ø–∞—Ä–æ–ª–µ–π). –†–µ—à–µ–Ω–æ –Ω–µ —É—Å–ª–æ–∂–Ω—è—Ç—å –ª–æ–≥–∏–∫—É —Ä–∞–∑–±–æ—Ä–æ–º —ç—Ç–æ–π —Ç–µ–º—ã. –°–æ–≤–µ—Ç—É—é –±—ã—Ç—å –∞–∫–∫—É—Ä–∞—Ç–Ω–µ–π ‚Äî –∂–µ–ª–∞—Ç–µ–ª—å–Ω–æ, –ø—Ä–∏–¥—É–º–∞—Ç—å –∫–∞–∫—É—é-—Ç–æ –ª–æ–≥–∏–∫—É –¥–ª—è –∑–∞—â–∏—Ç—ã.</p>
<pre><code class="lang-go">// internal/services/auth/auth.go

var (
    ErrInvalidCredentials = errors.New("invalid credentials")
)

// Login checks if user with given credentials exists in the system and returns access token.
//
// If user exists, but password is incorrect, returns error.
// If user doesn't exist, returns error.
func (a *Auth) Login(
    ctx context.Context,
    email string,
    password string, // –ø–∞—Ä–æ–ª—å –≤ —á–∏—Å—Ç–æ–º –≤–∏–¥–µ, –∞–∫–∫—É—Ä–∞—Ç–Ω–µ–π —Å –ª–æ–≥–∞–º–∏!
    appID int,       // ID –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è, –≤ –∫–æ—Ç–æ—Ä–æ–º –ª–æ–≥–∏–Ω–∏—Ç—Å—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
) (string, error) {
    const op = "Auth.Login"

    log := a.log.With(
        slog.String("op", op),
        slog.String("username", email),
        // password –ª–∏–±–æ –Ω–µ –ª–æ–≥–∏—Ä—É–µ–º, –ª–∏–±–æ –ª–æ–≥–∏—Ä—É–µ–º –≤ –∑–∞–º–∞—Å–∫–∏—Ä–æ–≤–∞–Ω–Ω–æ–º –≤–∏–¥–µ
    )
    log.Info("attempting to login user")
    // –î–æ—Å—Ç–∞—ë–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –ë–î
    user, err := a.usrProvider.User(ctx, email)
    if err != nil {
        if errors.Is(err, storage.ErrUserNotFound) {
            a.log.Warn("user not found", sl.Err(err))
            return "", fmt.Errorf("%s: %w", op, ErrInvalidCredentials)
        }
        a.log.Error("failed to get user", sl.Err(err))
        return "", fmt.Errorf("%s: %w", op, err)
    }
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –ø–æ–ª—É—á–µ–Ω–Ω–æ–≥–æ –ø–∞—Ä–æ–ª—è
    if err := bcrypt.CompareHashAndPassword(user.PassHash, []byte(password)); err != nil {
        a.log.Info("invalid credentials", sl.Err(err))
        return "", fmt.Errorf("%s: %w", op, ErrInvalidCredentials)
    }
    // –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏
    app, err := a.appProvider.App(ctx, appID)
    if err != nil {
        return "", fmt.Errorf("%s: %w", op, err)
    }
    log.Info("user logged in successfully")
    // –°–æ–∑–¥–∞—ë–º —Ç–æ–∫–µ–Ω –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
    token, err := jwt.NewToken(user, app, a.tokenTTL)
    if err != nil {
        a.log.Error("failed to generate token", sl.Err(err))
        return "", fmt.Errorf("%s: %w", op, err)
    }
    return token, nil
}</code></pre>
<p>–ù–∞ —ç—Ç–æ–º —Å–µ—Ä–≤–∏—Å Auth –ø–æ–ª–Ω–æ—Å—Ç—å—é –≥–æ—Ç–æ–≤, –º–æ–∂–µ–º –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç—å –∫ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞.</p>
<h3 class="section-title" id="storage">–°–ª–æ–π —Ä–∞–±–æ—Ç—ã —Å –¥–∞–Ω–Ω—ã–º–∏ ‚Äî Storage</h3>
<p>–î–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –±—É–¥–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å SQLite, —Ç.–∫. –Ω–µ –Ω—É–∂–Ω–æ –≤–æ–∑–∏—Ç—å—Å—è —Å –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π, –≤—Å—è –ë–î —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ –æ–¥–Ω–æ–º —Ñ–∞–π–ª–µ, –∞ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –Ω–µ–π –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∏–º–ø–æ—Ä—Ç–∞ –¥—Ä–∞–π–≤–µ—Ä–∞ sqlite –≤ –≤–∏–¥–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —á–µ—Ä–µ–∑ go mod:</p>
<pre><code class="lang-bash">go get github.com/mattn/go-sqlite3</code></pre>
<p>–ö–æ–¥ –ø–∞–∫–µ—Ç–∞ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ —Ä–∞–∑–º–µ—Å—Ç–∏–º –≤ internal/storage, –∞ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é –¥–ª—è sqlite –≤ internal/storage/sqlite.</p>
<p>–í –æ—Å–Ω–æ–≤–Ω–æ–º –ø–∞–∫–µ—Ç–µ storage –±—É–¥–µ–º —Ö—Ä–∞–Ω–∏—Ç—å –æ–±—â–∏–µ –æ–ø–∏—Å–∞–Ω–∏—è —Ç–∏–ø–æ–≤, –æ—à–∏–±–æ–∫ –∏ —Ç.–ø. –í –Ω–∞—à–µ–º —Ç–µ–∫—É—â–µ–º —Å–ª—É—á–∞–µ ‚Äî —ç—Ç–æ —Ç–æ–ª—å–∫–æ –æ—à–∏–±–∫–∏:</p>
<pre><code class="lang-go">// internal/storage/storage.go
package storage

var (  
    ErrUserExists   = errors.New("user already exists")  
    ErrUserNotFound = errors.New("user not found")  
    ErrAppNotFound  = errors.New("app not found")  
)</code></pre>
<p>–ü–æ —ç—Ç–∏–º –æ—à–∏–±–∫–∞–º —Å–µ—Ä–≤–∏—Å–Ω—ã–π —Å–ª–æ–π —Å–º–æ–∂–µ—Ç –ø–æ–Ω—è—Ç—å, —á—Ç–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫, –∏ –ø—Ä–∏–Ω–∏–º–∞—Ç—å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ —Ä–µ—à–µ–Ω–∏—è. –û–Ω–∏ –Ω–µ –¥–æ–ª–∂–Ω—ã –∑–∞–≤–∏—Å–µ—Ç—å –æ—Ç –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ (–±—É–¥—å —Ç–æ SQLite, Postgres, MongoDB –∏ —Ç.–ø.), –ø–æ—ç—Ç–æ–º—É –º—ã –∏—Ö —Ä–∞–∑–º–µ—Å—Ç–∏–ª–∏ –≤ –æ–±—â–µ–º –ø–∞–∫–µ—Ç–µ.</p>
<p><b>–ú–∏–≥—Ä–∞—Ü–∏–∏ –∏ —Å—Ö–µ–º–∞ –¥–∞–Ω–Ω—ã—Ö</b></p>
<p>–¢–µ–ø–µ—Ä—å –Ω–∞–º –Ω—É–∂–Ω–æ –ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å —Å—Ö–µ–º—É –¥–∞–Ω–Ω—ã—Ö. –ë—É–¥–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å–æ —Å—Ö–µ–º–æ–π –ë–î. –ú–∏–≥—Ä–∞—Ü–∏–∏ –ë–î ‚Äî —ç—Ç–æ –ø–æ—à–∞–≥–æ–≤—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö, –ø–æ–∑–≤–æ–ª—è—é—â–∏–µ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ –ø—Ä–∏–º–µ–Ω—è—Ç—å –∏ –æ—Ç–∫–∞—Ç—ã–≤–∞—Ç—å –º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏–∏ —Å—Ö–µ–º—ã. –û–Ω–∏, –æ–±—ã—á–Ω–æ, –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è—é—Ç –∏–∑ —Å–µ–±—è –Ω–∞–±–æ—Ä —Ñ–∞–π–ª–æ–≤ —Å SQL-–∑–∞–ø—Ä–æ—Å–∞–º–∏, –ø—Ä–∏–º–µ–Ω—è—è –∫–æ—Ç–æ—Ä—ã–µ –ø–æ –æ—á–µ—Ä–µ–¥–∏, –≤—ã –ø—Ä–∏–≤–µ–¥–µ—Ç–µ —Å—Ö–µ–º—É –ë–î –∫ –∞–∫—Ç—É–∞–ª—å–Ω–æ–º—É —Å–æ—Å—Ç–æ—è–Ω–∏—é. –≠—Ç–æ –Ω—É–∂–Ω–æ –¥–ª—è —Ç–æ–≥–æ, —á—Ç–æ–±—ã –æ–±–Ω–æ–≤–∏–≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π —Å –∫–æ–¥–æ–º, –º–æ–∂–Ω–æ –±—ã–ª–æ –±—ã —Ç–∞–∫ –∂–µ –ª–µ–≥–∫–æ –∞–∫—Ç—É–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ë–î.</p>
<p>–í–æ–∑—å–º—ë–º –≥–æ—Ç–æ–≤–æ–µ —Ä–µ—à–µ–Ω–∏–µ:</p>
<pre><code class="lang-go">go get github.com/golang-migrate/migrate/v4</code></pre>
<p>–†–∞–∑–ª–∏—á–Ω—ã—Ö –º–∏–≥—Ä–∞—Ç–æ—Ä–æ–≤ –Ω–∞ Go –¥–æ–≤–æ–ª—å–Ω–æ –º–Ω–æ–≥–æ, –∏ –≤—Å–µ –æ–Ω–∏ –ø–ª—é—Å-–º–∏–Ω—É—Å –Ω–µ–ø–ª–æ—Ö–∏–µ, —Ç–∞–∫ —á—Ç–æ –≤—ã–±–æ—Ä –Ω–µ –ø—Ä–∏–Ω—Ü–∏–ø–∏–∞–ª–µ–Ω.</p>
<p>–ö–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –º–∏–≥—Ä–∞—Ç–æ—Ä–æ–º? –ï—Å—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤:</p>
<ul>
    <li>–ó–∞–ø—É—Å–∫–∞—Ç—å –≤ Docker-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ (–ø–æ–ø—É–ª—è—Ä–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç)</li>
    <li>–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤ –≤–∏–¥–µ –∏—Å–ø–æ–ª–Ω—è–µ–º–æ–≥–æ —Ñ–∞–π–ª–∞ –∏ –∑–∞–ø—É—Å–∫–∞—Ç—å –µ–≥–æ</li>
    <li>–ù–∞–ø–∏—Å–∞—Ç—å –≤ —Ç–µ–∫—É—â–µ–º –ø—Ä–æ–µ–∫—Ç–µ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—É—é —É—Ç–∏–ª–∏—Ç—É-–≤—Ä–∞–ø–ø–µ—Ä</li>
</ul>
<p>–í—ã–±–µ—Ä–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π.</p>
<p>–°–æ–∑–¥–∞—ë–º —Ñ–∞–π–ª cmd/migrator/main.go –∏ –ø–∏—à–µ–º –≤ –Ω—ë–º –ø—Ä–æ—Å—Ç–µ–Ω—å–∫—É—é –æ–±—ë—Ä—Ç–∫—É:</p>
<pre><code class="lang-go">// cmd/migrator/main.go
package main

import (
    // –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –¥–ª—è –º–∏–≥—Ä–∞—Ü–∏–π
    "github.com/golang-migrate/migrate/v4"
    // –î—Ä–∞–π–≤–µ—Ä –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏–π SQLite 3
    _ "github.com/golang-migrate/migrate/v4/database/sqlite3"
    // –î—Ä–∞–π–≤–µ—Ä –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏–π –∏–∑ —Ñ–∞–π–ª–æ–≤
    _ "github.com/golang-migrate/migrate/v4/source/file"
)

func main() {
    var storagePath, migrationsPath, migrationsTable string
    // –ü–æ–ª—É—á–∞–µ–º –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –∏–∑ —Ñ–ª–∞–≥–æ–≤ –∑–∞–ø—É—Å–∫–∞
    // –ü—É—Ç—å –¥–æ —Ñ–∞–π–ª–∞ –ë–î.
    // –ï–≥–æ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ, —Ç.–∫. –º—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º SQLite, –¥—Ä—É–≥–∏–µ –∫—Ä–µ–¥—ã –Ω–µ –Ω—É–∂–Ω—ã.
    flag.StringVar(&storagePath, "storage-path", "", "path to storage")
    // –ü—É—Ç—å –¥–æ –ø–∞–ø–∫–∏ —Å –º–∏–≥—Ä–∞—Ü–∏—è–º–∏.
    flag.StringVar(&migrationsPath, "migrations-path", "", "path to migrations")
    // –¢–∞–±–ª–∏—Ü–∞, –≤ –∫–æ—Ç–æ—Ä–æ–π –±—É–¥–µ—Ç —Ö—Ä–∞–Ω–∏—Ç—å—Å—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –º–∏–≥—Ä–∞—Ü–∏—è—Ö. –û–Ω–∞ –Ω—É–∂–Ω–∞ 
    // –¥–ª—è —Ç–æ–≥–æ, —á—Ç–æ–±—ã –ø–æ–Ω–∏–º–∞—Ç—å, –∫–∞–∫–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏ —É–∂–µ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã, –∞ –∫–∞–∫–∏–µ –Ω–µ—Ç.
    // –î–µ—Ñ–æ–ª—Ç–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ - 'migrations'.
    flag.StringVar(&migrationsTable, "migrations-table", "migrations", "name of migrations table")
    flag.Parse() // –í—ã–ø–æ–ª–Ω—è–µ–º –ø–∞—Ä—Å–∏–Ω–≥ —Ñ–ª–∞–≥–æ–≤

    // –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
    if storagePath == "" {
        // –ü—Ä–æ—Å—Ç–µ–π—à–∏–π —Å–ø–æ—Å–æ–± –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–∫–∏ :)
        // –ü—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏, –º–æ–∂–µ—Ç–µ –≤—ã–±—Ä–∞—Ç—å –±–æ–ª–µ–µ –ø–æ–¥—Ö–æ–¥—è—â–∏–π –≤–∞—Ä–∏–∞–Ω—Ç.
        // –ú–µ–Ω—è –ø–∞–Ω–∏–∫–∞ –ø–æ–∫–∞ —É—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç, –ø–æ—Å–∫–æ–ª—å–∫—É —ç—Ç–æ –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —É—Ç–∏–ª–∏—Ç–∞.
        panic("storage-path is required")
    }
    if migrationsPath == "" {
        panic("migrations-path is required")
    }
    // –°–æ–∑–¥–∞–µ–º –æ–±—ä–µ–∫—Ç –º–∏–≥—Ä–∞—Ç–æ—Ä–∞, –ø–µ—Ä–µ–¥–∞–≤ –∫—Ä–µ–¥—ã –Ω–∞—à–µ–π –ë–î
    m, err := migrate.New(
        "file://"+migrationsPath,
        fmt.Sprintf("sqlite3://%s?x-migrations-table=%s", storagePath, migrationsTable),
    )
    if err != nil {
        panic(err)
    }
    // –í—ã–ø–æ–ª–Ω—è–µ–º –º–∏–≥—Ä–∞—Ü–∏–∏ –¥–æ –ø–æ—Å–ª–µ–¥–Ω–µ–π –≤–µ—Ä—Å–∏–∏
    if err := m.Up(); err != nil {
        if errors.Is(err, migrate.ErrNoChange) {
            fmt.Println("no migrations to apply")
            return
        }
        panic(err)
    }
}</code></pre>
<p>–û–±—Ä–∞—Ç–∏—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–∞ —Ç–æ, —á—Ç–æ –º—ã –∑–¥–µ—Å—å –≤—ã–Ω–µ—Å–ª–∏ –Ω–µ–π–º–∏–Ω–≥ —Ç–∞–±–ª–∏—Ü—ã –¥–ª—è –º–∏–≥—Ä–∞—Ü–∏–π –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–π —Ñ–ª–∞–≥ —Å –ø–æ–º–æ—â—å—é –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ ?x-migrations-table=%s. –û–±—ã—á–Ω–æ —ç—Ç–æ –Ω–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ, –Ω–æ —è –±—É–¥—É —Ö—Ä–∞–Ω–∏—Ç—å –æ—Ç–¥–µ–ª—å–Ω—ã–π –Ω–∞–±–æ—Ä –º–∏–≥—Ä–∞—Ü–∏–π –¥–ª—è —Ç–µ—Å—Ç–æ–≤, –∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –Ω–∏—Ö –±—É–¥–µ—Ç —Ö—Ä–∞–Ω–∏—Ç—å—Å—è –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–π —Ç–∞–±–ª–∏—Ü–µ.</p>
<p>–£ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –Ω–∞–º–∏ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ –¥–ª—è –º–∏–≥—Ä–∞—Ü–∏–π —Å–ª–µ–¥—É—é—â–∏–π —Ñ–æ—Ä–º–∞—Ç –Ω–µ–π–º–∏–Ω–≥–∞ –º–∏–≥—Ä–∞—Ü–∏–π: &lt;number&gt;_&lt;title&gt;.&lt;direction&gt;.sql, –≥–¥–µ:</p>
<ul>
    <li>number ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø–æ—Ä—è–¥–∫–∞ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏–π, –æ–Ω–∏ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –ø–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é –Ω–æ–º–µ—Ä–æ–≤. –¢—É—Ç –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –ª—é–±–æ–µ —Ü–µ–ª–æ–µ —á–∏—Å–ª–æ ‚Äî —ç—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø–æ—Ä—è–¥–∫–æ–≤—ã–π –Ω–æ–º–µ—Ä, timestamp –∏ —Ç.–ø. –Ø –±—É–¥—É –∏–º–µ–Ω–æ–≤–∞—Ç—å –ø–æ –ø–æ—Ä—è–¥–∫—É: 1, 2, 3 –∏ —Ç.–¥.</li>
    <li>title ‚Äî –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç—Å—è –±–∏–±–ª–∏–æ—Ç–µ–∫–æ–π, –æ–Ω –Ω—É–∂–µ–Ω —Ç–æ–ª—å–∫–æ –¥–ª—è –ª—é–¥–µ–π, —á—Ç–æ–±—ã –ø—Ä–æ—â–µ –±—ã–ª–æ –æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å—Å—è –≤ —Å–ø–∏—Å–∫–µ –º–∏–≥—Ä–∞—Ü–∏–π</li>
    <li>direction ‚Äî –∑–Ω–∞—á–µ–Ω–∏–µ up –∏–ª–∏ down. –§–∞–π–ª—ã —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º up –≤ –∏–º–µ–Ω–∏ –æ–±–Ω–æ–≤–ª—è—é—Ç —Å—Ö–µ–º—É –¥–æ –Ω–æ–≤–æ–π –≤–µ—Ä—Å–∏–∏, down ‚Äî –æ—Ç–∫–∞—Ç—ã–≤–∞—é—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è.</li>
</ul>
<p>–°–æ–∑–¥–∞—ë–º –ø–µ—Ä–≤—É—é –º–∏–≥—Ä–∞—Ü–∏—é –≤ –ø–∞–ø–∫–µ ./migrations:</p>
<pre><code class="lang-sql">-- migrations/1_init.up.sql

CREATE TABLE IF NOT EXISTS users
(
    id           INTEGER PRIMARY KEY,
    email        TEXT    NOT NULL UNIQUE,
    pass_hash    BLOB    NOT NULL
);
CREATE INDEX IF NOT EXISTS idx_email ON users (email);

CREATE TABLE IF NOT EXISTS apps
(
    id     INTEGER PRIMARY KEY,
    name   TEXT NOT NULL UNIQUE,
    secret TEXT NOT NULL UNIQUE
);</code></pre>
<p>–≠—Ç–∞ –º–∏–≥—Ä–∞—Ü–∏—è —Å–æ–∑–¥–∞—ë—Ç –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ —Ç–∞–±–ª–∏—Ü—ã –∏ –∏–Ω–¥–µ–∫—Å—ã. –¢–∞–±–ª–∏—Ü—ã –¥–æ–≤–æ–ª—å–Ω–æ –ø—Ä–æ—Å—Ç–µ–Ω—å–∫–∏–µ, –∏ –≤—ã—à–µ –º—ã —É–∂–µ –æ–±—Å—É–∂–¥–∞–ª–∏ –º–æ–¥–µ–ª–∏ –¥–∞–Ω–Ω—ã—Ö, –ø–æ—ç—Ç–æ–º—É —Ç—É—Ç –≤—Å—ë –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø–æ–Ω—è—Ç–Ω–æ. –û–±—Ä–∞—Ç–∏—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ, —á—Ç–æ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã email, name –∏ secret –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —É–Ω–∏–∫–∞–ª—å–Ω—ã–º–∏ –∏ –º—ã –¥–æ–±–∞–≤–∏–ª–∏ –¥–ª—è –Ω–∏—Ö —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π constraint.</p>
<p>–û–±—Ä–∞—Ç–Ω–∞—è –º–∏–≥—Ä–∞—Ü–∏—è:</p>
<pre><code class="lang-sql">-- ./migrations/1_init.down.sql

DROP TABLE IF EXISTS users;
DROP TABLE IF EXISTS apps;</code></pre>
<p>–ó–∞–≤–µ–¥—ë–º –ø–∞–ø–∫—É –ø–æ–¥ —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ñ–∞–π–ª–∞ –ë–î. –¢–µ–ø–µ—Ä—å –º–æ–∂–µ–º –∑–∞–ø—É—Å—Ç–∏—Ç—å —É—Ç–∏–ª–∏—Ç—É, —É–∫–∞–∑–∞–≤ –ø—É—Ç—å –¥–æ —Ñ–∞–π–ª–∞ –ë–î –∏ –ø–∞–ø–∫–∏ —Å –º–∏–≥—Ä–∞—Ü–∏—è–º–∏:</p>
<pre><code class="lang-bash">go run ./cmd/migrator --storage-path=./storage/sso.db --migrations-path=./migrations</code></pre>
<p>–ï—Å–ª–∏ –≤—Å—ë –ø—Ä–æ—à–ª–æ —Ö–æ—Ä–æ—à–æ, —É –≤–∞—Å –¥–æ–ª–∂–µ–Ω –ø–æ—è–≤–∏—Ç—å—Å—è —Ñ–∞–π–ª –ë–î (./storage/sso.db) —Å –∞–∫—Ç—É–∞–ª—å–Ω–æ–π —Å—Ö–µ–º–æ–π.</p>
<p><b>–†–µ–∞–ª–∏–∑–∞—Ü–∏—è Storage –¥–ª—è SQLite 3</b></p>
<p>–≠—Ç–æ—Ç —Ä–∞–∑–¥–µ–ª –Ω–∞–ø–∏—Å–∞–Ω –¥–æ–≤–æ–ª—å–Ω–æ –º–∏–Ω–∏–º–∞–ª–∏—Å—Ç–∏—á–Ω–æ, –ø–æ—Å–∫–æ–ª—å–∫—É –º—ã –¥–µ–ª–∞–µ–º —Ñ–æ–∫—É—Å –Ω–∞ gRPC, –∞ –Ω–µ –Ω–∞ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–∏ —Å –ë–î. –ï—Å–ª–∏ –≤—ã –∑–Ω–∞–∫–æ–º—ã —Å –ø–∞–∫–µ—Ç–æ–º database/sql, —Ç–æ –≤–∞–º –≤—Å—ë –±—É–¥–µ—Ç –ø–æ–Ω—è—Ç–Ω–æ. –ï—Å–ª–∏ –Ω–µ—Ç, —Ç–æ —Å—Ç–æ–∏—Ç –æ–∑–Ω–∞–∫–æ–º–∏—Ç—å—Å—è, –æ–Ω –æ–≥—Ä–æ–º–Ω–æ–π –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å—é —Ä–∞–Ω–æ –∏–ª–∏ –ø–æ–∑–¥–Ω–æ –ø—Ä–∏–≥–æ–¥–∏—Ç—Å—è –≤ —Ä–∞–±–æ—Ç–µ.</p>
<p>–°–æ–∑–¥–∞—ë–º —Ñ–∞–π–ª, –≤ –∫–æ—Ç–æ—Ä–æ–º –æ–ø–∏—à–µ–º —Ç–∏–ø Storage –∏ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –¥–ª—è –Ω–µ–≥–æ:</p>
<pre><code class="lang-go">// internal/storage/sqlite/sqlite.go
package sqlite

type Storage struct {
	db *sql.DB
}

// –ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä Storage
func New(storagePath string) (*Storage, error) {
	const op = "storage.sqlite.New"
	// –£–∫–∞–∑—ã–≤–∞–µ–º –ø—É—Ç—å –¥–æ —Ñ–∞–π–ª–∞ –ë–î
	db, err := sql.Open("sqlite3", storagePath)
	if err != nil {
		return nil, fmt.Errorf("%s: %w", op, err)
	}
	return &Storage{db: db}, nil
}</code></pre>
<p>–î–ª—è —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ –Ω–∞–º –Ω—É–∂–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —Ç—Ä–∏ –º–µ—Ç–æ–¥–∞: SaveUser(), User(), App(), –Ω–∞—á–Ω—ë–º –ø–µ—Ä–≤–æ–≥–æ:</p>
<pre><code class="lang-go">// internal/storage/sqlite/sqlite.go

// SaveUser saves user to db.
func (s *Storage) SaveUser(ctx context.Context, email string, passHash []byte) (int64, error) {
    const op = "storage.sqlite.SaveUser"

    // –ü—Ä–æ—Å—Ç–µ–Ω—å–∫–∏–π –∑–ø—Ä–æ—Å –Ω–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    stmt, err := s.db.Prepare("INSERT INTO users(email, pass_hash) VALUES(?, ?)")
    if err != nil {
        return 0, fmt.Errorf("%s: %w", op, err)
    }
    // –í—ã–ø–æ–ª–Ω—è–µ–º –∑–∞–ø—Ä–æ—Å, –ø–µ—Ä–µ–¥–∞–≤ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
    res, err := stmt.ExecContext(ctx, email, passHash)
    if err != nil {
        var sqliteErr sqlite3.Error
        // –ù–µ–±–æ–ª—å—à–æ–µ –∫—É–Ω–≥-—Ñ—É –¥–ª—è –≤—ã—è–≤–ª–µ–Ω–∏—è –æ—à–∏–±–∫–∏ ErrConstraintUnique
        // (—Å–º. –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ –Ω–∏–∂–µ)
        if errors.As(err, &sqliteErr) && sqliteErr.ExtendedCode == sqlite3.ErrConstraintUnique {
            return 0, fmt.Errorf("%s: %w", op, storage.ErrUserExists)
        }
        return 0, fmt.Errorf("%s: %w", op, err)
    }
    // –ü–æ–ª—É—á–∞–µ–º ID —Å–æ–∑–¥–∞–Ω–Ω–æ–π –∑–∞–ø–∏—Å–∏
    id, err := res.LastInsertId()
    if err != nil {
        return 0, fmt.Errorf("%s: %w", op, err)
    }
    return id, nil
}</code></pre>
<p>–°—É—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–∫–∏ sqliteErr.ExtendedCode == sqlite3.ErrConstraintUnique –≤ —Ç–æ–º, —á—Ç–æ–±—ã –≤—ã—è–≤–∏—Ç—å –æ—à–∏–±–∫—É –Ω–∞—Ä—É—à–µ–Ω–∏—è –∫–æ–Ω—Å—Ç—Ä—ç–∏–Ω—Ç–∞ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏ –ø–æ email, –¥—Ä—É–≥–∏–º–∏ —Å–ª–æ–≤–∞–º–∏ ‚Äî –∫–æ–≥–¥–∞ –º—ã –ø—ã—Ç–∞–µ–º—Å—è –¥–æ–±–∞–≤–∏—Ç—å –≤ —Ç–∞–±–ª–∏—Ü—É –∑–∞–ø–∏—Å—å —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º email, –∫–æ—Ç–æ—Ä—ã–π —É–∂–µ –µ—Å—Ç—å –≤ —Ç–∞–±–ª–∏—Ü–µ. –ï—Å–ª–∏ –º—ã –µ—ë –≤—ã—è–≤–ª—è–µ–º, —Ç–æ –Ω–∞—Ä—É–∂—É –Ω—É–∂–Ω–æ –≤–µ—Ä–Ω—É—Ç—å –æ—à–∏–±–∫—É storage.ErrUserExists, –∫–æ—Ç–æ—Ä—É—é –º—ã –ø–æ–¥–≥–æ—Ç–æ–≤–∏–ª–∏ –∑–∞—Ä–∞–Ω–µ–µ. –≠—Ç–æ –Ω—É–∂–Ω–æ –¥–ª—è —Ç–æ–≥–æ, —á—Ç–æ–±—ã –≤–Ω–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∏—Å–ø–æ–ª—å–∑—É–µ–º–æ–π –ë–î –≤—Å–µ–≥–¥–∞ –º–æ–∂–Ω–æ –±—ã–ª–æ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø–æ–ø—ã—Ç–∫—É –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –¥—É–±–ª–∏–∫–∞—Ç–∞ –∏–º–µ—é—â–µ–≥–æ—Å—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –ù–∞–º —ç—Ç–æ –ø–æ–Ω–∞–¥–æ–±–∏—Ç—Å—è –≤ –¥—Ä—É–≥–∏—Ö —Å–ª–æ—è—Ö, —á—Ç–æ–±—ã –æ—Ç—Ä–µ–∞–≥–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ –ø–æ–¥–æ–±–Ω—ã–π —Å–ª—É—á–∞–π –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º –æ–±—Ä–∞–∑–æ–º.</p>
<p>–ò–¥—ë–º –¥–∞–ª—å—à–µ, –Ω–∞–ø–∏—à–µ–º –º–µ—Ç–æ–¥ User(ctx context.Context, email string) –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ email: </p>
<pre><code class="lang-go">// internal/storage/sqlite/sqlite.go
...
// User returns user by email.
func (s *Storage) User(ctx context.Context, email string) (models.User, error) {
    const op = "storage.sqlite.User"

    stmt, err := s.db.Prepare("SELECT id, email, pass_hash FROM users WHERE email = ?")
    if err != nil {
        return models.User{}, fmt.Errorf("%s: %w", op, err)
    }
    row := stmt.QueryRowContext(ctx, email)
    var user models.User
    err = row.Scan(&user.ID, &user.Email, &user.PassHash)
    if err != nil {
        if errors.Is(err, sql.ErrNoRows) {
            return models.User{}, fmt.Errorf("%s: %w", op, storage.ErrUserNotFound)
        }
        return models.User{}, fmt.Errorf("%s: %w", op, err)
    }
    return user, nil
}</code></pre>
<p>–ó–¥–µ—Å—å –º—ã –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ –æ–ø—Ä–µ–¥–µ–ª—è–µ–º –æ—à–∏–±–∫—É, –Ω–æ –Ω–∞ —ç—Ç–æ—Ç —Ä–∞–∑ –Ω–∞—Å –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç sql.ErrNoRows, –æ–Ω–∞ –æ–∑–Ω–∞—á–∞–µ—Ç —á—Ç–æ –º—ã –Ω–µ —Å–º–æ–≥–ª–∏ –Ω–∞–π—Ç–∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â—É—é –∑–∞–ø–∏—Å—å. –í —ç—Ç–æ–º —Å–ª—É—á–∞–µ –º—ã –≤–µ—Ä–Ω—ë–º –Ω–∞—Ä—É–∂—É storage.ErrUserNotFound.</p>
<p>–û—Å—Ç–∞–ª—Å—è –ø–æ—Å–ª–µ–¥–Ω–∏–π –º–µ—Ç–æ–¥ ‚Äî App(ctx context.Context, id int):</p>
<pre><code class="lang-go">// internal/storage/sqlite/sqlite.go
...
// App returns app by id.
func (s *Storage) App(ctx context.Context, id int) (models.App, error) {
    const op = "storage.sqlite.App"

    stmt, err := s.db.Prepare("SELECT id, name, secret FROM apps WHERE id = ?")
    if err != nil {
        return models.App{}, fmt.Errorf("%s: %w", op, err)
    }
    row := stmt.QueryRowContext(ctx, id)
    var app models.App
    err = row.Scan(&app.ID, &app.Name, &app.Secret)
    if err != nil {
        if errors.Is(err, sql.ErrNoRows) {
            return models.App{}, fmt.Errorf("%s: %w", op, storage.ErrAppNotFound)
        }
        return models.App{}, fmt.Errorf("%s: %w", op, err)
    }
    return app, nil
}</code></pre>
<p>–ö–∞–∫ –∏ –≤ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —Å–ª—É—á–∞—è—Ö, –≤ —Å–ª—É—á–∞–µ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è –∑–∞–ø–∏—Å–∏ (sql.ErrNoRows), –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –Ω–∞—Ä—É–∂—É storage.ErrAppNotFound. –ù–∞ —ç—Ç–æ–º –Ω–∞—à Storage –≥–æ—Ç–æ–≤.</p>
<h3 class="section-title" id="make">–°–æ–±–∏—Ä–∞–µ–º –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –≤–æ–µ–¥–∏–Ω–æ</h3>
<p>–ò—Ç–∞–∫, –º—ã –Ω–∞–ø–∏—Å–∞–ª–∏ Auth (—Å–µ—Ä–≤–∏—Å–Ω—ã–π —Å–ª–æ–π) –∏ Storage (—Å–ª–æ–π —Ä–∞–±–æ—Ç—ã —Å –¥–∞–Ω–Ω—ã–º–∏), —Ç–µ–ø–µ—Ä—å –Ω–∞–º –Ω—É–∂–Ω–æ –ø–æ–¥–∫–ª—é—á–∏—Ç—å –∏—Ö –∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—é. –°–∞–º–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —É –Ω–∞—Å –±—É–¥–µ—Ç –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è—Ç—å –ø–∞–∫–µ—Ç internal/app. –ù–µ cmd/sso/main.go ‚Äî —ç—Ç–æ –±—ã–ª–∞ –ª–∏—à—å —Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞. –¢–∞–∫–æ–π –ø–æ–¥—Ö–æ–¥ –¥–µ–ª–∞–µ—Ç –∫–æ–¥ main –Ω–∞–º–Ω–æ–≥–æ –ø—Ä–æ—â–µ, –∏, –≥–ª–∞–≤–Ω–æ–µ ‚Äî –¥–∞—ë—Ç –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —Å–æ–∑–¥–∞–≤–∞—Ç—å —ç–∫–∑–µ–º–ø–ª—è—Ä –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –≤ –¥—Ä—É–≥–∏—Ö –º–µ—Å—Ç–∞—Ö ‚Äî –Ω–∞–ø—Ä–∏–º–µ—Ä, –≤ —Ç–µ—Å—Ç–∞—Ö, —á—Ç–æ –æ–±–ª–µ–≥—á–∞–µ—Ç —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ. –ü—Ä–∏ —ç—Ç–æ–º, gRPC-—Å–µ—Ä–≤–µ—Ä –º—ã –∑–∞–≤–µ—Ä–Ω—ë–º –≤ –µ—â—ë –æ–¥–Ω–æ –æ—Ç–¥–µ–ª—å–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ (internal/app/grpc) –≤–º–µ—Å—Ç–µ —Å–æ –≤—Å–µ–º–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—è–º–∏. –î–∞–≤–∞–π—Ç–µ —Å —ç—Ç–æ–≥–æ –∏ –Ω–∞—á–Ω—ë–º:</p>
<pre><code class="lang-go">// internal/app/grpc/app.go
package grpcapp

type App struct {
    log        *slog.Logger
    gRPCServer *grpc.Server
    port       int // –ü–æ—Ä—Ç, –Ω–∞ –∫–æ—Ç–æ—Ä–æ–º –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å grpc-—Å–µ—Ä–≤–µ—Ä
}</code></pre>
<p>–ó–¥–µ—Å—å –º—ã –æ–ø–∏—Å–∞–ª–∏ —Ç–∏–ø, –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ gRPC-—Å–µ—Ä–≤–µ—Ä–∞ –∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è —Å–µ—Ä–≤–∏—Å–Ω–æ–≥–æ —Å–ª–æ—è ‚Äî –≤ –Ω–∞—à–µ–º —Å–ª—É—á–∞–µ —ç—Ç–æ —Ç–æ–ª—å–∫–æ Auth, –Ω–æ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ —Å–µ—Ä–≤–∏—Å–æ–≤ –º–æ–∂–µ—Ç –±—ã—Ç—å –±–æ–ª—å—à–µ.</p>
<p>–ú—ã –±—É–¥–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±–∏–±–ª–∏–æ—Ç–µ–∫—É grpc-ecosystem/go-grpc-middleware, —Å–æ–¥–µ—Ä–∂–∞—â—É—é –≥–æ—Ç–æ–≤—ã–µ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –ø–æ–ª–µ–∑–Ω—ã—Ö –∏–Ω—Ç–µ—Ä—Å–µ–ø—Ç–æ—Ä–æ–≤ (–ø–æ–¥—Ä–æ–±–Ω–µ–µ –æ –Ω–∏—Ö –±—É–¥–µ—Ç –¥–∞–ª—å—à–µ):</p>
<pre><code class="lang-bash">go get github.com/grpc-ecosystem/go-grpc-middleware/v2</code></pre>
<p>–¢–µ–ø–µ—Ä—å –º–æ–∂–µ–º –Ω–∞–ø–∏—Å–∞—Ç—å —Å–∞–º –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä. –û–¥–∏–Ω –∏–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ authgrpc.Auth ‚Äî —ç—Ç–æ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å —Å–µ—Ä–≤–∏—Å–Ω–æ–≥–æ —Å–ª–æ–π, –Ω–µ –ø—É—Ç–∞—Ç—å gRPC-—Å–µ—Ä–≤–∏—Å–æ–º Auth. –ï–≥–æ –º—ã –Ω–∞–ø–∏—à–µ–º —á—É—Ç—å –Ω–∏–∂–µ. –ù–∞ –≤—Ö–æ–¥ c–µ—Ä–≤–µ—Ä –ø—Ä–∏–Ω–∏–º–∞–µ—Ç —Ä–∞–∑–ª–∏—á–Ω—ã–µ –æ–ø—Ü–∏–∏, –∏ –≤ –Ω–∞—à–µ–º —Å–ª—É—á–∞–µ —ç—Ç–æ –±—É–¥—É—Ç —Ç–æ–ª—å–∫–æ –∏–Ω—Ç–µ—Ä—Å–µ–ø—Ç–æ—Ä—ã.</p>
<p>–ò–Ω—Ç–µ—Ä—Å–µ–ø—Ç–æ—Ä gRPC —ç—Ç–æ, –≤ –Ω–µ–∫–æ—Ç–æ—Ä–æ–º —Å–º—ã—Å–ª–µ, –∞–Ω–∞–ª–æ–≥ Middleware –∏–∑ –º–∏—Ä–∞ HTTP / REST —Å–µ—Ä–≤–µ—Ä–æ–≤. –¢–æ –µ—Å—Ç—å, —ç—Ç–æ —Ñ—É–Ω–∫—Ü–∏—è, –∫–æ—Ç–æ—Ä–∞—è –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø–µ—Ä–µ–¥ –∏/–∏–ª–∏ –ø–æ—Å–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ RPC-–≤—ã–∑–æ–≤–∞ –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ —Å–µ—Ä–≤–µ—Ä–∞ –∏–ª–∏ –∫–ª–∏–µ–Ω—Ç–∞. –° –ø–æ–º–æ—â—å—é –∏–Ω—Ç–µ—Ä—Å–µ–ø—Ç–æ—Ä–æ–≤ –º—ã –º–æ–∂–µ–º –≤—ã–ø–æ–ª–Ω—è—Ç—å —Ä–∞–∑–ª–∏—á–Ω—ã–µ –ø–æ–ª–µ–∑–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤, –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é, –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –∏ –¥—Ä.), –Ω–µ –∏–∑–º–µ–Ω—è—è –æ—Å–Ω–æ–≤–Ω–æ–π –ª–æ–≥–∏–∫–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ RPC.</p>
<p>–£ –Ω–∞—Å –ø–æ–∫–∞ –≤—Å–µ–≥–æ –æ–¥–∏–Ω –∏–Ω—Ç–µ—Ä—Å–µ–ø—Ç–æ—Ä, –æ–Ω –æ–±–µ—Ä–Ω—É—Ç –≤ grpc.ChainUnaryInterceptor ‚Äî —ç—Ç–æ –Ω–µ–∫–∏–π –≤—Ä–∞–ø–ø–µ—Ä, –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –≤ –∫–∞—á–µ—Å—Ç–≤–µ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤ –Ω–∞–±–æ—Ä –∏–Ω—Ç–µ—Ä—Å–µ–ø—Ç–æ—Ä–æ–≤, –∞ –∫–æ–≥–¥–∞ –ø—Ä–∏—Ö–æ–¥–∏—Ç –æ–¥–∏–Ω–æ—á–Ω—ã–π –∑–∞–ø—Ä–æ—Å (Unary), –∑–∞–ø—É—Å–∫–∞–µ—Ç –≤—Å–µ —ç—Ç–∏ –∏–Ω—Ç–µ—Ä—Å–µ–ø—Ç–æ—Ä—ã –ø–æ–æ—á–µ—Ä—ë–¥–Ω–æ (–æ–± —ç—Ç–æ–º –≥–æ–≤–æ—Ä–∏—Ç —Å–ª–æ–≤–æ Chain –≤ –Ω–∞–∑–≤–∞–Ω–∏–∏). –ü–æ–º–∏–º–æ –æ–¥–∏–Ω–æ—á–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤, gRPC —É–º–µ–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å —Ç–∞–∫–∂–µ —Å –ø–æ—Ç–æ–∫–æ–≤—ã–º–∏ (Stream), –∏ –¥–ª—è –Ω–∏—Ö –º—ã –±—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏ grpc.ChainStreamInterceptor, –Ω–æ —ç—Ç–æ —É–∂–µ –¥—Ä—É–≥–∞—è –∏—Å—Ç–æ—Ä–∏—è.</p>
<p>–ò–Ω—Ç–µ—Ä—Å–µ–ø—Ç–æ—Ä recovery.UnaryServerInterceptor –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç –∏ –æ–±—Ä–∞–±–æ—Ç–∞–µ—Ç –ø–∞–Ω–∏–∫—É, –µ—Å–ª–∏ –æ–Ω–∞ —Å–ª—É—á–∏—Ç—Å—è –≤–Ω—É—Ç—Ä–∏ —Ö—ç–Ω–¥–ª–µ—Ä–∞. –ü–æ–ª–µ–∑–Ω–∞—è —à—Ç—É–∫–∞, –≤–µ–¥—å –º—ã –Ω–µ —Ö–æ—Ç–∏–º, —á—Ç–æ–±—ã –ø–∞–Ω–∏–∫–∞ –≤ –æ–¥–Ω–æ–º –∑–∞–ø—Ä–æ—Å–µ —É—Ä–æ–Ω–∏–ª–∞ –Ω–∞–º –≤–µ—Å—å —Å–µ—Ä–≤–∏—Å, –æ—Å—Ç–∞–Ω–æ–≤–∏–≤ –æ–±—Ä–∞–±–æ—Ç–∫—É –¥–∞–∂–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤. –í–æ–æ–±—â–µ, –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–∞–Ω–∏–∫–∏, —ç—Ç–æ –ø–æ—Ä–æ–π –¥–∏—Å–∫—É—Ç–∏–≤–Ω–∞—è —Ç–µ–º–∞, –∏ –µ—Å–ª–∏ –≤–∞–º —Ç–∞–∫–æ–π –ø–æ–¥—Ö–æ–¥ –Ω–µ –Ω—Ä–∞–≤–∏—Ç—Å—è, –º–æ–∂–µ—Ç–µ –ø—Ä–æ—Å—Ç–æ –Ω–µ –¥–æ–±–∞–≤–ª—è—Ç—å —ç—Ç–æ—Ç –∏–Ω—Ç–µ—Ä—Å–µ–ø—Ç–æ—Ä.</p>
<p>–í —Ç–µ–∫—É—â–µ–º –≤–∏–¥–µ –ø–∞–Ω–∏–∫–∞ –ø—Ä–æ—Å—Ç–æ –º–æ–ª—á–∞ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è, –∏ –µ—Å–ª–∏ –º—ã —Ö–æ—Ç–∏–º –¥–æ–±–∞–≤–∏—Ç—å –∫–∞–∫–∏–µ-—Ç–æ —Å–≤–æ–∏ –¥–µ–π—Å—Ç–≤–∏—è, —Ç–æ –º–æ–∂–Ω–æ –Ω–∞–ø–∏—Å–∞—Ç—å —Å–≤–æ–π RecoveryHandler. –ö –ø—Ä–∏–º–µ—Ä—É, –¥–æ–±–∞–≤–∏–º —Ö—ç–Ω–¥–ª–µ—Ä, –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –ø–∞–Ω–∏–∫–∏, —á—Ç–æ–±—ã –º—ã —ç—Ç–æ –∑–∞–º–µ—Ç–∏–ª–∏:</p>
<pre><code class="lang-go">recoveryOpts := []recovery.Option{
    recovery.WithRecoveryHandler(func(p interface{}) (err error) {
        // –õ–æ–≥–∏—Ä—É–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–∞–Ω–∏–∫–µ —Å —É—Ä–æ–≤–Ω–µ–º Error
        log.Error("Recovered from panic", slog.Any("panic", p))
        // –ú–æ–∂–µ—Ç–µ –ª–∏–±–æ —á–µ—Å—Ç–Ω–æ –≤–µ—Ä–Ω—É—Ç—å –∫–ª–∏–µ–Ω—Ç—É —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –ø–∞–Ω–∏–∫–∏
        // –õ–∏–±–æ –æ—Ç–≤–µ—Ç–∏—Ç—å - "internal error", –µ—Å–ª–∏ –Ω–µ —Ö–æ—Ç–∏–º –¥–µ–ª–∏—Ç—å—Å—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω–æ—Å—Ç—è–º–∏
        return status.Errorf(codes.Internal, "internal error")
    }),
}</code></pre>
<p>–ü–æ—Å–∫–æ–ª—å–∫—É, –∏–∑ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ —É –Ω–∞—Å —Ç–æ–ª—å–∫–æ –ª–æ–≥–∏, —ç—Ç–æ–≥–æ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ. –î–æ–±–∞–≤–∏–º –µ—â–µ –æ–¥–∏–Ω –≤–∞–∂–Ω—ã–π –∏–Ω—Ç–µ—Ä—Å–µ–ø—Ç–æ—Ä ‚Äî –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ –≤—Ö–æ–¥—è—â–∏–µ –∑–∞–ø—Ä–æ—Å—ã –∏ –æ—Ç–≤–µ—Ç—ã. –≠—Ç–æ –±—ã–≤–∞–µ—Ç –æ—á–µ–Ω—å –ø–æ–ª–µ–∑–Ω–æ –¥–ª—è –ø–æ–∏—Å–∫–µ —Ö–≤–æ—Å—Ç–æ–≤ –≤ —Å–ª—É—á–∞–µ –ø–æ–ª–æ–º–æ–∫ –∏ –¥–µ–±–∞–≥–∞. –î–ª—è —ç—Ç–æ–≥–æ –º—ã —Ç–∞–∫–∂–µ –≤–æ–∑—å–º—ë–º –≥–æ—Ç–æ–≤–æ–µ —Ä–µ—à–µ–Ω–∏–µ –∏–∑ –ø–∞–∫–µ—Ç–∞: logging.UnaryServerInterceptor(log, opts) (–ø—Ä–∏–º–µ—Ä –∏–º–ø–æ—Ä—Ç–∞ —Å–º. –Ω–∏–∂–µ). –ù–∞ –≤—Ö–æ–¥ –æ–Ω –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –ª–æ–≥–≥–µ—Ä –∏ –æ–ø—Ü–∏–∏. –ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –º—ã –Ω–µ –º–æ–∂–µ–º –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ–¥–∞—Ç—å –Ω–∞—à —Ç–µ–∫—É—â–∏–π –ª–æ–≥–≥–µ—Ä, —Ç.–∫. —É –µ–≥–æ –º–µ—Ç–æ–¥–∞ Log() –Ω–µ–º–Ω–æ–≥–æ –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è —Å–∏–≥–Ω–∞—Ç—É—Ä–∞, –æ—Ç —Ç–æ–π –∫–æ—Ç–æ—Ä—É—é —Ç—Ä–µ–±—É–µ—Ç —Ö—ç–Ω–¥–ª–µ—Ä</p>
<p>–≠—Ç–æ –∑–Ω–∞—á–∏—Ç, —á—Ç–æ –Ω–∞–º —Å–Ω–æ–≤–∞ –Ω—É–∂–µ–Ω –ø—Ä–æ—Å—Ç–µ–Ω—å–∫–∏–π –≤—Ä–∞–ø–ø–µ—Ä:</p>
<pre><code class="lang-go">// InterceptorLogger adapts slog logger to interceptor logger.
// This code is simple enough to be copied and not imported.
func InterceptorLogger(l *slog.Logger) logging.Logger {
    return logging.LoggerFunc(func(ctx context.Context, lvl logging.Level, msg string, fields ...any) {
        l.Log(ctx, slog.Level(lvl), msg, fields...)
    })
}</code></pre>
<p>–ó–¥–µ—Å—å –º—ã –ø—Ä–æ—Å—Ç–æ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –∏–º–µ—é—â—É—é—Å—è —Ñ—É–Ω–∫—Ü–∏—é Log() –≤ –∞–Ω–∞–ª–æ–≥–∏—á–Ω—É—é –∏–∑ –ø–∞–∫–µ—Ç–∞ –∏–Ω—Ç–µ—Ä—Å–µ–ø—Ç–æ—Ä–∞. –ü–æ–º–∏–º–æ –ª–æ–≥–≥–µ—Ä–∞, –¥–∞–Ω–Ω—ã–π –∏–Ω—Ç–µ—Ä—Å–µ–ø—Ç–æ—Ä –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –æ–ø—Ü–∏–∏. –ö –ø—Ä–∏–º–µ—Ä—É, –º–æ–∂–µ–º –ø–µ—Ä–µ–¥–∞—Ç—å –µ–º—É —Ç–∞–∫–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:</p>
<pre><code class="lang-go">loggingOpts := []logging.Option{
    logging.WithLogOnEvents(
        logging.PayloadReceived, logging.PayloadSent,
    ),
}</code></pre>
<p>–¢–∞–∫–∏–º –æ–±—Ä–∞–∑–æ–º –º—ã —Å–æ–æ–±—â–∏–º –∏–Ω—Ç–µ—Ä—Å–µ–ø—Ç–æ—Ä—É, —á—Ç–æ, –ø–æ–º–∏–º–æ –ø—Ä–æ—á–µ–≥–æ, –º—ã —Ç–∞–∫–∂–µ —Ö–æ—Ç–∏–º –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–ª–æ –∑–∞–ø—Ä–æ—Å–∞ –∏ –æ—Ç–≤–µ—Ç–∞. –¢–∞–∫–∞—è –æ–ø—Ü–∏—è –¥–∞–ª–µ–∫–æ –Ω–µ –≤—Å–µ–≥–¥–∞ —É–º–µ—Å—Ç–Ω–∞, —Ç.–∫. –≤ —Ç–µ–ª–µ –∑–∞–ø—Ä–æ—Å–æ–≤ –º–æ–∂–µ—Ç –Ω–∞—Ö–æ–¥–∏—Ç—å—Å—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è, –∫–æ—Ç–æ—Ä—É—é –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å –Ω–∏ –∫–∞–∫ –Ω–µ–ª—å–∑—è. –ö –ø—Ä–∏–º–µ—Ä—É, –ø–∞—Ä–æ–ª–∏ –≤ —á–∏—Å—Ç–æ–º –≤–∏–¥–µ. –û–±—Ä–∞—Ç–∏—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ, –µ—Å–ª–∏ –≤—ã –Ω–µ –º–∞—Å–∫–∏—Ä—É–µ—Ç–µ –ø–∞—Ä–æ–ª—å, —ç—Ç–æ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –¥—ã—Ä–∞ –≤ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏! –í —Ç–∞–∫–æ–º —Å–ª—É—á–∞–µ –ª—É—á—à–µ –≤–æ–æ–±—â–µ –æ—Ç–∫–∞–∑–∞—Ç—å—Å—è –æ—Ç –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–µ–ª–∞ –∑–∞–ø—Ä–æ—Å–∞.</p>
<p>–¢–∞–∫–∂–µ –∑–¥–µ—Å—å –≤—ã –º–æ–≥–ª–∏ –∑–∞–º–µ—Ç–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏—é authgrpc.Register, –∫–æ—Ç–æ—Ä–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é —Å–µ—Ä–≤–∏—Å–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ (authService) –Ω–∞ –Ω–∞—à–µ–º gRPC —Å–µ—Ä–≤–µ—Ä–µ (gRPCServer). –í –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ gRPC —ç—Ç–æ –æ–±—ã—á–Ω–æ –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ —Å–µ—Ä–≤–µ—Ä –±—É–¥–µ—Ç –∑–Ω–∞—Ç—å, –∫–∞–∫ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –≤—Ö–æ–¥—è—â–∏–µ RPC-–∑–∞–ø—Ä–æ—Å—ã, —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å —ç—Ç–∏–º —Å–µ—Ä–≤–∏—Å–æ–º –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏, –ø–æ—Ç–æ–º—É —á—Ç–æ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è —ç—Ç–æ–≥–æ —Å–µ—Ä–≤–∏—Å–∞ (–º–µ—Ç–æ–¥—ã, –∫–æ—Ç–æ—Ä—ã–µ –æ–Ω–∞ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç) —Ç–µ–ø–µ—Ä—å —Å–≤—è–∑–∞–Ω—ã —Å —Å–µ—Ä–≤–µ—Ä–æ–º gRPC.</p>
<p>–û—Å—Ç–∞–ª–æ—Å—å –ª–∏—à—å –Ω–∞—É—á–∏—Ç—å —ç—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞—Ç—å—Å—è. –°–æ–±–µ—Ä–µ–º –≤—Å–µ –≤ internal/app/grpc/app.go, –∏ –≤ –∏—Ç–æ–≥–µ –ø–æ–ª—É—á–∞–µ–º —Ç–∞–∫–æ–π –∫–æ–¥:</p>
<pre><code class="lang-go">// internal/app/grpc/app.go
package grpcapp

import (
    authgrpc "proto_sso/internal/grpc/auth"
)

type App struct {
	log        *slog.Logger
	gRPCServer *grpc.Server
	port       int // –ü–æ—Ä—Ç, –Ω–∞ –∫–æ—Ç–æ—Ä–æ–º –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å grpc-—Å–µ—Ä–≤–µ—Ä
}

// InterceptorLogger adapts slog logger to interceptor logger.
// This code is simple enough to be copied and not imported.
func InterceptorLogger(l *slog.Logger) logging.Logger {
	return logging.LoggerFunc(func(ctx context.Context, lvl logging.Level, msg string, fields ...any) {
		l.Log(ctx, slog.Level(lvl), msg, fields...)
	})
}

// New creates new gRPC server app.
func New(
	log *slog.Logger,
	authService authgrpc.Auth, //  —ç—Ç–æ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å —Å–µ—Ä–≤–∏—Å–Ω–æ–≥–æ —Å–ª–æ–π, –Ω–µ –ø—É—Ç–∞—Ç—å c gRPC-—Å–µ—Ä–≤–∏—Å–æ–º Auth
	port int,
) *App {
	// TODO: —Å–æ–∑–¥–∞—Ç—å gRPCServer –∏ –ø–æ–¥–∫–ª—é—á–∏—Ç—å –∫ –Ω–µ–º—É –∏–Ω—Ç–µ—Ä—Å–µ–ø—Ç–æ—Ä—ã
	// TODO: –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å —É —Å–µ—Ä–≤–µ—Ä–∞ –Ω–∞—à gRPC-—Å–µ—Ä–≤–∏—Å Auth
	loggingOpts := []logging.Option{
		logging.WithLogOnEvents(
			logging.PayloadReceived, logging.PayloadSent,
		),
	}
	recoveryOpts := []recovery.Option{
		recovery.WithRecoveryHandler(func(p interface{}) (err error) {
			// –õ–æ–≥–∏—Ä—É–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–∞–Ω–∏–∫–µ —Å —É—Ä–æ–≤–Ω–µ–º Error
			log.Error("Recovered from panic", slog.Any("panic", p))

			// –ú–æ–∂–µ—Ç–µ –ª–∏–±–æ —á–µ—Å—Ç–Ω–æ –≤–µ—Ä–Ω—É—Ç—å –∫–ª–∏–µ–Ω—Ç—É —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –ø–∞–Ω–∏–∫–∏
			// –õ–∏–±–æ –æ—Ç–≤–µ—Ç–∏—Ç—å - "internal error", –µ—Å–ª–∏ –Ω–µ —Ö–æ—Ç–∏–º –¥–µ–ª–∏—Ç—å—Å—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω–æ—Å—Ç—è–º–∏
			return status.Errorf(codes.Internal, "internal error")
		}),
	}
	// –°–µ—Ä–≤–µ—Ä —Å–æ–∑–¥–∞—ë—Ç—Å—è —Å–ª–µ–¥—É—é—â–∏–º –æ–±—Ä–∞–∑–æ–º
	gRPCServer := grpc.NewServer(grpc.ChainUnaryInterceptor(
		recovery.UnaryServerInterceptor(recoveryOpts...),
		logging.UnaryServerInterceptor(InterceptorLogger(log), loggingOpts...),
	))
	authgrpc.Register(gRPCServer, authService)
	// –í–µ—Ä–Ω—É—Ç—å –æ–±—ä–µ–∫—Ç App —Å–æ –≤—Å–µ–º–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–º–∏ –ø–æ–ª—è–º–∏
	return &App{
		log:        log,
		gRPCServer: gRPCServer,
		port:       port,
	}
}

// MustRun runs gRPC server and panics if any error occurs.
func (a *App) MustRun() {
	if err := a.Run(); err != nil {
		panic(err)
	}
}

// Run runs gRPC server.
func (a *App) Run() error {
	const op = "grpcapp.Run"

	// –°–æ–∑–¥–∞—ë–º listener, –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç —Å–ª—É—à–∏—Ç—å TCP-—Å–æ–æ–±—â–µ–Ω–∏—è, –∞–¥—Ä–µ—Å–æ–≤–∞–Ω–Ω—ã–µ –Ω–∞—à–µ–º—É gRPC-—Å–µ—Ä–≤–µ—Ä—É
	l, err := net.Listen("tcp", fmt.Sprintf(":%d", a.port))
	if err != nil {
		return fmt.Errorf("%s: %w", op, err)
	}
	a.log.Info("grpc server started", slog.String("addr", l.Addr().String()))
	// –ó–∞–ø—É—Å–∫–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ gRPC-—Å–æ–æ–±—â–µ–Ω–∏–π
	if err := a.gRPCServer.Serve(l); err != nil {
		return fmt.Errorf("%s: %w", op, err)
	}
	return nil
}</code></pre>
<p>–ú–æ–∂–µ–º —Å–º–µ–ª–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å MustRun(), –≤ –∫–æ—Ç–æ—Ä–æ–º –±—É–¥–µ–º –ø–∞–¥–∞—Ç—å —Å –ø–∞–Ω–∏–∫–æ–π, –µ—Å–ª–∏ —Å–ª—É—á–∏–ª–∞—Å—å –∫–∞–∫–∞—è-—Ç–æ –æ—à–∏–±–∫–∞. –¢–µ–ø–µ—Ä—å –º–æ–∂–µ–º —Å–æ–∑–¥–∞—Ç—å grpcApp –≤–Ω—É—Ç—Ä–∏ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:</p>
<pre><code class="lang-go">// internal/app/app.go
package app

import (
    grpcapp "proto_sso/internal/app/grpc"
)

type App struct {
    GRPCServer *grpcapp.App
}

func New(
    log *slog.Logger,
    grpcPort int,
    storagePath string,
    tokenTTL time.Duration,
) *App {
    storage, err := sqlite.New(storagePath)
    if err != nil {
        panic(err)
    }
    authService := auth.New(log, storage, storage, storage, tokenTTL)
    grpcApp := grpcapp.New(log, authService, grpcPort)
    return &App{
        GRPCServer: grpcApp,
    }
}</code></pre>
<p>–ú–æ–∂–µ—Ç —Å–º—É—â–∞—Ç—å —ç—Ç–∞ —Å—Ç—Ä–æ—á–∫–∞:</p>
<pre><code class="lang-go">authService := auth.New(log, storage, storage, storage, tokenTTL)</code></pre>
<p>–ê –∏–º–µ–Ω–Ω–æ, —Ç—Ä–∏–∂–¥—ã –ø–µ—Ä–µ–¥–∞–≤–∞–µ–º—ã–π storage. –£–≤—ã, —Ç–∞–∫–æ–≤—ã –∏–∑–¥–µ—Ä–∂–∫–∏ –º–∏–Ω–∏–º–∞–ª–∏—Å—Ç–∏—á–Ω—ã—Ö –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–≤. –ù–æ –ø–æ–¥—É–º–∞–π—Ç–µ –æ —Ç–æ–º, —á—Ç–æ –Ω–µ –≤–æ –≤—Å–µ—Ö —Å–ª—É—á–∞—è—Ö —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è–º–∏ —ç—Ç–∏—Ö –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–≤ –º–æ–∂–µ—Ç –±—ã—Ç—å storage, —ç—Ç–æ –¥–∞—ë—Ç –Ω–∞–º –±–æ–ª—å—à–µ –≥–∏–±–∫–æ—Å—Ç–∏.</p>
<p>–¢–µ–ø–µ—Ä—å –º–æ–∂–µ–º —Å–æ–∑–¥–∞—Ç—å –∏ –∑–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤ cmd/sso. –í –∏—Ç–æ–≥–µ, –Ω–∞—à main.go –±—É–¥–µ—Ç –≤—ã–≥–ª—è–¥–µ—Ç—å —Å–ª–µ–¥—É—é—â–∏–º –æ–±—Ä–∞–∑–æ–º:</p>
<pre><code class="lang-go">// cmd/sso/main.go
...
func main() {
    cfg := config.MustLoad()
    log := setupLogger(cfg.Env)
    application := app.New(log, cfg.GRPC.Port, cfg.StoragePath, cfg.TokenTTL)
    application.GRPCServer.MustRun()
}
...</code></pre>
<h3 class="section-title" id="shutdown">Graceful shutdown ‚Äî –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è</h3>
<p>–ù–∞—É—á–∏–º —Å–µ—Ä–≤–∏—Å –ø—Ä–µ–∫—Ä–∞—Å–Ω–æ –∑–∞–≤–µ—Ä—à–∞—Ç—å —Å–≤–æ—é —Ä–∞–±–æ—Ç—É –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏. –†–µ—á—å, –∫–æ–Ω–µ—á–Ω–æ –∂–µ, –ø—Ä–æ graceful shutdown - ‚Äî —ç—Ç–æ –ø—Ä–æ—Ü–µ—Å—Å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ä–∞–±–æ—Ç—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è, –ø—Ä–∏ –∫–æ—Ç–æ—Ä–æ–º –æ–Ω–æ –∑–∞–≤–µ—Ä—à–∞–µ—Ç —Ç–µ–∫—É—â–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –∏ –æ—Å–≤–æ–±–æ–∂–¥–∞–µ—Ç —Ä–µ—Å—É—Ä—Å—ã –ø–µ—Ä–µ–¥ –æ–∫–æ–Ω—á–∞—Ç–µ–ª—å–Ω—ã–º –≤—ã–∫–ª—é—á–µ–Ω–∏–µ–º. –ü—Ä–æ—Å—Ç—ã–º–∏ —Å–ª–æ–≤–∞–º–∏, –µ—Å–ª–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø–æ–Ω–∏–º–∞–µ—Ç, —á—Ç–æ –µ–≥–æ –ø–æ–ø—Ä–æ—Å–∏–ª–∏ –∑–∞–≤–µ—Ä—à–∏—Ç—å —Ä–∞–±–æ—Ç—É, –æ–Ω–æ –ø–µ—Ä–µ–¥ —ç—Ç–∏–º –¥–æ–ª–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ –≤–∞–∂–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è: –Ω–∞–ø—Ä–∏–º–µ—Ä, –Ω–µ –æ–±—Ä—ã–≤–∞—Ç—å –∑–∞–ø—Ä–æ—Å—ã –ø–æ—Å—Ä–µ–¥–∏ —Ä–∞–±–æ—Ç—ã. –ß—Ç–æ–±—ã –Ω–∞—É—á–∏—Ç—å –Ω–∞—à–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ grpcApp –ø—Ä–∞–≤–∏–ª—å–Ω–æ –∑–∞–≤–µ—Ä—à–∞—Ç—å —Ä–∞–±–æ—Ç—É, –¥–æ–±–∞–≤–∏–º –µ–º—É –º–µ—Ç–æ–¥ Stop():</p>
<pre><code class="lang-go">// internal/app/grpc/app.go
...
// Stop stops gRPC server.
func (a *App) Stop() {
    const op = "grpcapp.Stop"

    a.log.With(slog.String("op", op)).
        Info("stopping gRPC server", slog.Int("port", a.port))
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –≤ gRPCServer –º–µ—Ö–∞–Ω–∏–∑–º graceful shutdown
    a.gRPCServer.GracefulStop()
}</code></pre>
<p>–ö–∞–∫ –≤–∏–¥–∏–º, –Ω–∞–º –ø–æ—á—Ç–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –ø—Ä–∏—à–ª–æ—Å—å –¥–ª—è —ç—Ç–æ–≥–æ –¥–µ–ª–∞—Ç—å —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ ‚Äî –≤ –∏—Å–ø–æ–ª—å–∑—É–µ–º–æ–º –Ω–∞–º–∏ gRPCServer *grpc.Server —É–∂–µ –µ—Å—Ç—å –ø–æ–¥—Ö–æ–¥—è—â–∏–π –º–µ—Ç–æ–¥. –ß—Ç–æ –æ–Ω –¥–µ–ª–∞–µ—Ç:</p>
<ul>
    <li>–ü–µ—Ä–µ—Å—Ç–∞—ë—Ç –ø—Ä–∏–Ω–∏–º–∞—Ç—å –Ω–æ–≤—ã–µ –∑–∞–ø—Ä–æ—Å—ã</li>
    <li>–ñ–¥—ë—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ç–µ–∫—É—â–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤</li>
    <li>–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</li>
</ul>
<p>–¢–µ–ø–µ—Ä—å –≤ main() –Ω–∞–º –Ω—É–∂–Ω–æ –≤ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –º–æ–º–µ–Ω—Ç –≤—ã–∑–≤–∞—Ç—å —ç—Ç–æ—Ç –º–µ—Ç–æ–¥. –î–ª—è —ç—Ç–æ–≥–æ –Ω–∞–º –Ω—É–∂–Ω–æ –Ω–∞—É—á–∏—Ç—å –ø—Ä–æ–≥—Ä–∞–º–º—É –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞—Ç—å —Å–∏–≥–Ω–∞–ª—ã SIGINT –∏ SIGTERM –æ—Ç –û–° (—Ç.–µ. –ø–æ–Ω–∏–º–∞—Ç—å, –∫–æ–≥–¥–∞ –æ—Ç –û–° –ø—Ä–∏—à–ª–∞ –∫–æ–º–∞–Ω–¥–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ —Ä–∞–±–æ—Ç—ã). –î–ª—è —ç—Ç–æ–≥–æ –æ–±—ã—á–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–∞–∫–æ–π –ø–æ–¥—Ö–æ–¥:</p>
<pre><code class="lang-go">// –°–æ–∑–¥–∞—ë–º –∫–∞–Ω–∞–ª –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Å–∏–≥–Ω–∞–ª–∞—Ö
stop := make(chan os.Signal, 1)
// "–°–ª—É—à–∞–µ–º" –ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–Ω—ã–µ —Å–∏–≥–Ω–∞–ª—ã
signal.Notify(stop, syscall.SIGTERM, syscall.SIGINT)

// –ñ–¥—ë–º –¥–∞–Ω–Ω—ã—Ö –∏–∑ –∫–∞–Ω–∞–ª–∞
&lt;-stop

// TODO: –∑–¥–µ—Å—å –±—É–¥–µ—Ç –∫–æ–¥ graceful shutdown</code></pre>
<p>–ü–æ–∫–∞ —Å–∏–≥–Ω–∞–ª–æ–≤ –Ω–µ—Ç, –∫–æ–º–∞–Ω–¥–∞ &lt;-stop –±—É–¥–µ—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –¥–∞–ª—å–Ω–µ–π—à–µ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∫–æ–¥–∞, —Ç.–µ. –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å, –∏ –º—ã –Ω–µ –≤—ã–π–¥–µ–º –∏–∑ main() —Ä–∞–Ω—å—à–µ –≤—Ä–µ–º–µ–Ω–∏. –ö–∞–∫ —Ç–æ–ª—å–∫–æ –ø—Ä–∏–¥–µ—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π —Å–∏–≥–Ω–∞–ª, –≤ –∫–∞–Ω–∞–ª stop –ø—Ä–∏–¥–µ—Ç –∑–Ω–∞—á–µ–Ω–∏–µ, –∏ –º—ã –¥–≤–∏–Ω–µ–º—Å—è –¥–∞–ª—å—à–µ ‚Äî –≤—ã–ø–æ–ª–Ω–∏–º –∫–æ–¥ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∏ –≤—ã–π–¥–µ–º –∏–∑ –ø—Ä–æ–≥—Ä–∞–º–º—ã. –ù–æ –ø–µ—Ä–µ–¥ —ç—Ç–∏–º –≤—Å–ø–æ–º–Ω–∏–º, —á—Ç–æ –∫–æ–º–∞–Ω–¥–∞ –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ —Ç–æ–∂–µ –±—ã–ª–∞ –±–ª–æ–∫–∏—Ä—É—é—â–∞—è, –ø–æ—ç—Ç–æ–º—É –µ—ë —Ç–µ–ø–µ—Ä—å –Ω—É–∂–Ω–æ –≤—ã–ø–æ–ª–Ω—è—Ç—å –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ, —Ç.–µ.: go application.GRPCServer.MustRun().</p>
<p>–°–æ–±–∏—Ä–∞–µ–º –≤—Å—ë —ç—Ç–æ –≤–º–µ—Å—Ç–µ –∏ –ø–æ–ª—É—á–∞–µ–º:</p>
<pre><code class="lang-go">func main() {
    ...
    go func() {
        application.GRPCServer.MustRun()
    }()
    // Graceful shutdown
    stop := make(chan os.Signal, 1)
    signal.Notify(stop, syscall.SIGTERM, syscall.SIGINT)
    // Waiting for SIGINT (pkill -2) or SIGTERM
    <-stop
    // initiate graceful shutdown
    application.GRPCServer.Stop() // Assuming GRPCServer has Stop() method for graceful shutdown
    log.Info("Gracefully stopped")
}</code></pre>
<p><b>TODO: </b>—Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ –Ω–∞–ø–∏—Å–∞—Ç—å –∞–Ω–∞–ª–æ–≥–∏—á–Ω—ã–π –º–µ—Ç–æ–¥ Stop() –¥–ª—è sqlite-—Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ Storage. –¢–∞–º —ç—Ç–æ –¥–µ–ª–∞–µ—Ç—Å—è —Ç–æ–∂–µ –æ–¥–Ω–æ–π —Å—Ç—Ä–æ—á–∫–æ–π: s.db.Close(). –ü—Ä–∏ —ç—Ç–æ–º, –∫–æ–Ω–µ—á–Ω–æ –∂–µ, –ø—Ä–∏–¥–µ—Ç—Å—è –¥–æ–±–∞–≤–∏—Ç—å Storage –≤ —Å—Ç—Ä—É–∫—Ç—É—Ä—É App –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (internal/app/app.go). –ü—Ä–∏ –∂–µ–ª–∞–Ω–∏–∏, –º–æ–∂–µ—Ç–µ –æ–±–µ—Ä–Ω—É—Ç—å —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ StorageApp ‚Äî —ç—Ç–æ —Ö–æ—Ä–æ—à–∏–π –ø–æ–¥—Ö–æ–¥.</p>
<h3 class="section-title" id="func_tests">–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ —Ç–µ—Å—Ç—ã</h3>
<p>–ú—ã –Ω–∞–ø–∏—à–µ–º —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ —Ç–µ—Å—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ –±—É–¥—É—Ç —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–∞—à–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∫–∞–∫ —á—ë—Ä–Ω—É—é –∫–æ—Ä–æ–±–∫—É. –≠—Ç–æ –∑–Ω–∞—á–∏—Ç, —á—Ç–æ –º—ã –±—É–¥–µ–º —á–µ—Å—Ç–Ω–æ –ø–æ–¥–Ω–∏–º–∞—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ, –∫–æ—Ç–æ—Ä–æ–µ –Ω–µ –±—É–¥–µ—Ç –ø–æ–¥–æ–∑—Ä–µ–≤–∞—Ç—å –æ —Ç–æ–º, —á—Ç–æ –µ–≥–æ —Ç–µ—Å—Ç–∏—Ä—É—é—Ç, –∏ –±—É–¥–µ–º —á–µ—Å—Ç–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –≤ –Ω–µ–≥–æ —Å–µ—Ç–µ–≤—ã–µ –∑–∞–ø—Ä–æ—Å—ã. –¢–∞–∫–∏–µ —Ç–µ—Å—Ç—ã –ø–æ–∑–≤–æ–ª—è—é—Ç —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª–Ω—ã–π –≤–µ—Å—å —Ñ–ª–æ—É —Ä–∞–±–æ—Ç—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è, –∏ –ø—Ä–∏ —ç—Ç–æ–º –ø–æ–∑–≤–æ–ª—è—é—Ç –¥–æ–≤–æ–ª—å–Ω–æ –≥–∏–±–∫–æ –ø—Ä–æ–≤–µ—Ä—è—Ç—å –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏ –ª—é–±—ã–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –∫–µ–π—Å—ã. –¢–∞–∫–∂–µ –æ–Ω–∏ —É–¥–æ–±–Ω–æ —Ç–µ–º, —á—Ç–æ –∏—Ö –º–æ–∂–Ω–æ –ª–µ–≥–∫–æ –∑–∞–ø—É—Å–∫–∞—Ç—å –ª–æ–∫–∞–ª—å–Ω–æ, –≤ –æ—Ç–ª–∏—á–∏–µ –æ—Ç —Ç–µ—Ö –∂–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤. –¢–µ—Å—Ç—ã –Ω—É–∂–Ω—ã –Ω–µ —Ç–æ–ª—å–∫–æ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–æ–∫ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏ —Ä–∞–±–æ—Ç—ã, –æ–Ω–∏ —Ç–∞–∫–∂–µ —Å–ª—É–∂–∞—Ç —É–¥–æ–±–Ω—ã–º —Å–ø–æ—Å–æ–±–æ–º –∑–∞—Å—Ç–∞–≤–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —á—Ç–æ-—Ç–æ —Å–¥–µ–ª–∞—Ç—å. –û—Å–æ–±–µ–Ω–Ω–æ, –∫–æ–≥–¥–∞ —ç—Ç–æ —Å–ª–æ–∂–Ω—ã–π —Ä–µ–¥–∫–∏–π –∫–µ–π—Å. –ù–∞–º —ç—Ç–æ –º–æ–∂–µ—Ç –ø–æ–Ω–∞–¥–æ–±–∏—Ç—å—Å—è –≤–æ –≤—Ä–µ–º—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏, –¥–µ–±–∞–≥–∞ –∏ —Ç.–ø. –ü–æ–¥–æ–±–Ω—ã–µ —Ç–µ—Å—Ç—ã —Ç–∞–∫–∂–µ –ø–æ—Ä–æ–π –Ω–∞–∑—ã–≤–∞—é—Ç –∏–∑–æ–ª—è—Ü–∏–æ–Ω–Ω—ã–º–∏, —Ç.–∫. –≤ —Å–ª—É—á–∞–µ –Ω–∞–ª–∏—á–∏—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π (—Ç.–µ. –¥—Ä—É–≥–∏—Ö —Å–µ—Ä–≤–∏—Å–æ–≤, —Å –∫–æ—Ç–æ—Ä—ã–º–∏ –Ω—É–∂–Ω–æ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å), –æ–Ω–∏ –∑–∞–º–µ–Ω—è—é—Ç—Å—è —Å–µ—Ç–µ–≤—ã–º–∏ –º–æ–∫–∞–º–∏. –ò–º–µ–Ω–Ω–æ —Å–µ—Ç–µ–≤—ã–º–∏, –ø–æ—Ç–æ–º—É –Ω–∞—à–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤—Å—ë –µ—â—ë –¥—É–º–∞–µ—Ç, —á—Ç–æ –æ–Ω–æ —á–µ—Å—Ç–Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –∏ —á–µ—Å—Ç–Ω–æ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤—É–µ—Ç —Å —Å–æ—Å–µ–¥—è–º–∏. –ï—â—ë –æ–¥–Ω–æ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–æ –ø–æ–¥–æ–±–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤ –≤ –Ω–∞—à–µ–º —Å–ª—É—á–∞–µ ‚Äî –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ –∏—Ö –Ω–∞–ø–∏—Å–∞–Ω–∏—è –º—ã –Ω–∞—É—á–∏–º—Å—è –ø–∏—Å–∞—Ç—å gRPC-–∫–ª–∏–µ–Ω—Ç –¥–ª—è –Ω–∞—à–µ–≥–æ —Å–µ—Ä–≤–∏—Å–∞.</p>
<p>–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ —Ç–µ—Å—Ç—ã –º—ã –ø–æ–ª–æ–∂–∏–º –≤ –æ—Ç–¥–µ–ª—å–Ω—É—é –ø–∞–ø–∫—É ‚Äî tests/. C—Ç—Ä—É–∫—Ç—É—Ä–∞ –±—É–¥–µ—Ç –≤—ã–≥–ª—è–¥–µ—Ç—å —Ç–∞–∫:</p>
<pre><code class="lang-bash">./tests
‚îú‚îÄ‚îÄ auth_register_login_test.go ... –¢–µ—Å—Ç-–∫–µ–π—Å—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ Login 
‚îú‚îÄ‚îÄ some_other_case_test.go ....... –ö–∞–∫–∏–µ-—Ç–æ –¥—Ä—É–≥–∏–µ –∫–µ–π—Å—ã
‚îú‚îÄ‚îÄ migrations .................... –ú–∏–≥—Ä–∞—Ü–∏–∏ –¥–ª—è —Ç–µ—Å—Ç–æ–≤
‚îÇ   ‚îî‚îÄ‚îÄ 1_init_apps.up.sql
‚îî‚îÄ‚îÄ suite
    ‚îî‚îÄ‚îÄ suite.go .................. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –≤—Å–µ–≥–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ–≥–æ –¥–ª—è —Ç–µ—Å—Ç–æ–≤</code></pre>
<ul>
    <li>–í –∫–æ—Ä–Ω–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ tests –º—ã —Ö—Ä–∞–Ω–∏–º —Å–∞–º–∏ —Ñ–∞–π–ª—ã —Ç–µ—Å—Ç–æ–≤ —Å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º–∏ –∫–µ–π—Å–∞–º–∏ (—É –Ω–∏—Ö –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Å—É—Ñ—Ñ–∏–∫—Å _test.go)</li>
    <li>tests/migrations ‚Äî –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –º–∏–≥—Ä–∞—Ü–∏–∏, –∫–æ—Ç–æ—Ä—ã–µ –Ω—É–∂–Ω—ã —Ç–æ–ª—å–∫–æ –¥–ª—è —Ç–µ—Å—Ç–æ–≤. –û–±—ã—á–Ω–æ —è –∏—Ö –∏—Å–ø–æ–ª—å–∑—É—é –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ë–î —Å–∞–º—ã–º–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏. –ù–∞–ø—Ä–∏–º–µ—Ä, –∑–¥–µ—Å—å –º—ã –Ω–∞–ø–∏—à–µ–º –º–∏–≥—Ä–∞—Ü–∏—é –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –≤ —Ç–∞–±–ª–∏—Ü—É apps.</li>
    <li>tests/suite ‚Äî –∑–¥–µ—Å—å –º—ã –±—É–¥–µ–º –≥–æ—Ç–æ–≤–∏—Ç—å –≤—Å—ë, —á—Ç–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –∫–∞–∂–¥–æ–º—É —Ç–µ—Å—Ç—É. –ù–∞–ø—Ä–∏–º–µ—Ä, —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å –ë–î, —Å–æ–∑–¥–∞–Ω–∏–µ gRPC-–∫–ª–∏–µ–Ω—Ç–∞ –∏ –¥—Ä.</li>
</ul>
<p><b>–ú–∏–≥—Ä–∞—Ü–∏–∏ –¥–ª—è —Ç–µ—Å—Ç–æ–≤</b></p>
<p>–ù–∞—á–Ω—ë–º —Å —Å–∞–º–æ–≥–æ –ø—Ä–æ—Å—Ç–æ–≥–æ ‚Äî —Å –º–∏–≥—Ä–∞—Ü–∏–π, –Ω–∞–º –ø–æ–Ω–∞–¥–æ–±–∏—Ç—Å—è –≤—Å–µ–≥–æ –æ–¥–Ω–∞:</p>
<pre><code class="lang-sql">-- tests/migrations/1_init_apps.up.sql

INSERT INTO apps (id, name, secret)  
VALUES (1, 'test', 'test-secret') 
ON CONFLICT DO NOTHING;</code></pre>
<p>–û–±—Ä–∞—Ç–∏—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ, –Ω–∞ —Å—Ç—Ä–æ—á–∫—É ON CONFLICT DO NOTHING ‚Äî –µ—Å–ª–∏ —Ç–∞–∫–∞—è –∑–∞–ø–∏—Å—å —É–∂–µ –µ—Å—Ç—å, –º–∏–≥—Ä–∞—Ü–∏—è –ø—Ä–æ—Å—Ç–æ –Ω–∏—á–µ–≥–æ –Ω–µ —Å–¥–µ–ª–∞–µ—Ç. –¢–∞–∫–∂–µ –¥–µ—Ä–∂–∏–º –≤ –≥–æ–ª–æ–≤–µ, —á—Ç–æ —É–∫–∞–∑–∞–Ω–Ω—ã–µ id –∏ secret –Ω–∞–º —Å–∫–æ—Ä–æ –ø–æ–Ω–∞–¥–æ–±—è—Ç—Å—è –≤ —Ç–µ—Å—Ç–∞—Ö. –û–±—Ä–∞—Ç–Ω—É—é –º–∏–≥—Ä–∞—Ü–∏—é –ø–∏—Å–∞—Ç—å –Ω–µ –±—É–¥–µ–º, —Ç.–∫. –≤ —Ç–µ—Å—Ç–æ–≤–æ–π –±–∞–∑–µ —ç—Ç–æ –Ω–µ –Ω—É–∂–Ω–æ.</p>
<p>–í—ã–ø–æ–ª–Ω—è—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏ –∏–∑ —ç—Ç–æ–π –ø–∞–ø–∫–∏ –±—É–¥–µ–º —Ç–æ–π –∂–µ —É—Ç–∏–ª–∏—Ç–æ–π, –Ω–æ —Å –¥—Ä—É–≥–∏–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏:</p>
<pre><code class="lang-go">go run ./cmd/migrator \
    --storage-path=./storage/sso.db \
    --migrations-path=./tests/migrations \
    --migrations-table=migrations_test</code></pre>
<p>–¢–æ –µ—Å—Ç—å, –º—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–ª—è –Ω–∏—Ö –æ—Ç–¥–µ–ª—å–Ω—É—é —Ç–∞–±–ª–∏—Ü—É migrations_test, —á—Ç–æ–±—ã —ç—Ç–∏ —Ç–µ—Å—Ç–æ–≤—ã–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –±—ã–ª–∏ –Ω–µ–∑–∞–≤–∏—Å–∏–º—ã –æ—Ç –æ—Å–Ω–æ–≤–Ω—ã—Ö. –¢–∞–∫–∂–µ —É–∫–∞–∑—ã–≤–∞–µ–º, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ, –¥—Ä—É–≥–æ–π –ø—É—Ç—å –¥–æ —Ñ–∞–π–ª–æ–≤ –º–∏–≥—Ä–∞—Ü–∏–π.</p>
<p><b>Suite ‚Äî –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ —Ç–µ—Å—Ç—É</b></p>
<p>–¢–µ–ø–µ—Ä—å –ø–æ–¥–≥–æ—Ç–æ–≤–∏–º Suite. –û–Ω –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç –∏–∑ —Å–µ–±—è —Å—Ç—Ä—É–∫—Ç—É—Ä—É, –≤ –∫–æ—Ç–æ—Ä–æ–π —Å–æ–¥–µ—Ä–∂–∏—Ç—Å—è –≤—Å—ë –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ–µ –¥–ª—è —Ç–µ—Å—Ç–∞:</p>
<pre><code class="lang-go">// tests/suite/suite.go
package suite

import (
	ssov1 "proto/gen/go/sso"
)

type Suite struct {
	*testing.T                  // –ü–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è –¥–ª—è –≤—ã–∑–æ–≤–∞ –º–µ—Ç–æ–¥–æ–≤ *testing.T
	Cfg        *config.Config   // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
	AuthClient ssov1.AuthClient // –ö–ª–∏–µ–Ω—Ç –¥–ª—è –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å gRPC-—Å–µ—Ä–≤–µ—Ä–æ–º Auth
}</code></pre>
<ul>
    <li>*testing.T ‚Äî –æ–±—ä–µ–∫—Ç –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º —Ç–µ—Å—Ç–æ–º, –ø–æ–¥—Ä–æ–±–Ω–µ–µ –º–æ–∂–Ω–æ –ø–æ—á–∏—Ç–∞—Ç—å —Ç—É—Ç</li>
    <li>Cfg ‚Äî –æ–±—ã—á–Ω—ã–π –æ–±—ä–µ–∫—Ç –∫–æ–Ω—Ñ–∏–≥–∞, —Ç–æ—Ç –∂–µ —á—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –∏–∑ cmd</li>
    <li>AuthClient ‚Äî gRPC-–∫–ª–∏–µ–Ω—Ç –Ω–∞—à–µ–≥–æ Auth-—Å–µ—Ä–≤–µ—Ä–∞, –æ—Å–Ω–æ–≤–Ω–æ–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç Suit'–∞, —Å –µ–≥–æ –ø–æ–º–æ—â—å—é –±—É–¥–µ–º –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –∑–∞–ø—Ä–æ—Å—ã –≤ —Ç–µ—Å—Ç–∏—Ä—É–µ–º–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</li>
</ul>
<p>–¢–µ–ø–µ—Ä—å –Ω–∞–ø–∏—à–µ–º –¥–ª—è –Ω–µ–≥–æ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä:</p>
<pre><code class="lang-go">package suite
...
// New creates new test suite.
func New(t *testing.T) (context.Context, *Suite) {
	t.Helper()   // –§—É–Ω–∫—Ü–∏—è –±—É–¥–µ—Ç –≤–æ—Å–ø—Ä–∏–Ω–∏–º–∞—Ç—å—Å—è –∫–∞–∫ –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è –¥–ª—è —Ç–µ—Å—Ç–æ–≤
	t.Parallel() // –†–∞–∑—Ä–µ—à–∞–µ–º –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–π –∑–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤

	// –ß–∏—Ç–∞–µ–º –∫–æ–Ω—Ñ–∏–≥ –∏–∑ —Ñ–∞–π–ª–∞
	cfg := config.MustLoad()

	// –û—Å–Ω–æ–≤–Ω–æ–π —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç
	ctx, cancelCtx := context.WithTimeout(context.Background(), cfg.GRPC.Timeout)

	// –ö–æ–≥–¥–∞ —Ç–µ—Å—Ç—ã –ø—Ä–æ–π–¥—É—Ç, –∑–∞–∫—Ä—ã–≤–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç
	t.Cleanup(func() {
		t.Helper()
		cancelCtx()
	})

	// –ê–¥—Ä–µ—Å –Ω–∞—à–µ–≥–æ gRPC-—Å–µ—Ä–≤–µ—Ä–∞ grpcHost (???)
	grpcAddress := net.JoinHostPort("", strconv.Itoa(cfg.GRPC.Port))

	// –°–æ–∑–¥–∞–µ–º –∫–ª–∏–µ–Ω—Ç
	cc, err := grpc.NewClient(
		grpcAddress,
		// context.Background(),
		grpc.WithTransportCredentials(insecure.NewCredentials()),
	)
	if err != nil {
		t.Fatalf("grpc server connection failed: %v", err)
	}

	// gRPC-–∫–ª–∏–µ–Ω—Ç —Å–µ—Ä–≤–µ—Ä–∞ Auth
	authClient := ssov1.NewAuthClient(cc)

	return ctx, &Suite{
		T:          t,
		Cfg:        cfg,
		AuthClient: authClient,
	}
}</code></pre>
<p>t.Helper() ‚Äî –ø–æ–º–µ—á–∞–µ—Ç —Ñ—É–Ω–∫—Ü–∏—é –∫–∞–∫ –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—É—é, —ç—Ç–æ –Ω—É–∂–Ω–æ –¥–ª—è —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –≤—ã–≤–æ–¥–∞ —Ç–µ—Å—Ç–æ–≤, –æ—Å–æ–±–µ–Ω–Ω–æ –ø—Ä–∏ –∏—Ö –ø–∞–¥–µ–Ω–∏–∏. –ê –∏–º–µ–Ω–Ω–æ, —á—Ç–æ-—Ç–æ —Å—Ñ—ç–π–ª–∏—Ç—Å—è –≤–Ω—É—Ç—Ä–∏ —Ç–∞–∫–æ–≥–æ —Ö–µ–ª–ø–µ—Ä–∞, –≤ –≤—ã–≤–æ–¥–µ –±—É–¥–µ—Ç —É–∫–∞–∑–∞–Ω–∞ —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–∞—è —Ñ—É–Ω–∫—Ü–∏—è (–Ω–æ –≤ —Ç—Ä–µ–π—Å–µ —Ç–µ–∫—É—â–∞—è —Ñ—É–Ω–∫—Ü–∏—è –±—É–¥–µ—Ç, –∫–æ–Ω–µ—á–Ω–æ), —á—Ç–æ –æ—á–µ–Ω—å —É–¥–æ–±–Ω–æ –ø—Ä–∏ –æ—Ç–ª–∞–¥–∫–µ. –ò –≤–æ—Ç —Ç—É—Ç –º—ã –º–æ–∂–µ–º —Å–Ω–æ–≤–∞ –ø—Ä–æ—á—É–≤—Å—Ç–≤–æ–≤–∞—Ç—å –∫—Ä—É—Ç–æ—Å—Ç—å –∫–æ–¥–æ–≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–∑ Protobuf: –≤—Å–µ–≥–æ –æ–¥–Ω–æ–π —Å—Ç—Ä–æ—á–∫–æ–π –º—ã —Å–æ–∑–¥–∞—ë–º –≥–æ—Ç–æ–≤—ã–π –∫–ª–∏–µ–Ω—Ç –¥–ª—è –Ω–∞—à–µ–≥–æ gRPC-—Å–µ—Ä–≤–µ—Ä–∞: authClient := ssov1.NewAuthClient(cc).  –ú–µ—Ç–æ–¥–∞–º–∏ —ç—Ç–æ–≥–æ –∫–ª–∏–µ–Ω—Ç—É –±—É–¥—É—Ç –º–µ—Ç–æ–¥—ã —Å–µ—Ä–≤–∏—Å–∞, –æ–ø–∏—Å–∞–Ω–Ω—ã–µ –≤ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–µ, —Ç.–µ.: authClient.Login() –∏ authClient.Register().</p>
<p><b>–¢–µ—Å—Ç-–∫–µ–π—Å HappyPath –¥–ª—è –º–µ—Ç–æ–¥–∞ Login()</b></p>
<p>–ß—Ç–æ –∂, —É –Ω–∞—Å –≤—Å—ë –≥–æ—Ç–æ–≤–æ –¥–ª—è –Ω–∞–ø–∏—Å–∞–Ω–∏—è –ø–µ—Ä–≤–æ–≥–æ —Ç–µ—Å—Ç-–∫–µ–π—Å–∞. –ù–∞—á–Ω—ë–º –ø—Ä–æ—Å—Ç–µ–Ω—å–∫–æ–≥–æ Happy Path —Å—Ü–µ–Ω–∞—Ä–∏—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ (—ç—Ç–æ –∫–æ–≥–¥–∞ —É –Ω–∞—Å –≤—Å—ë –∏–¥–µ—Ç —á–µ—Ç–∫–æ –ø–æ –ø–ª–∞–Ω—É). –°–¥–µ–ª–∞–µ–º –±–∞–∑–æ–≤—ã–µ –ø—Ä–∏—Å–µ–¥–∞–Ω–∏—è –∏ –Ω–∞–º–µ—Ç–∏–º –ø–ª–∞–Ω –¥–µ–π—Å—Ç–≤–∏–π:</p>
<pre><code class="lang-go">// tests/auth_register_login_test.go
package tests

const (
    appID = 1                 // ID –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è, –∫–æ—Ç–æ—Ä–æ–µ –º—ã —Å–æ–∑–¥–∞–ª–∏ –º–∏–≥—Ä–∞—Ü–∏–µ–π
    appSecret = "test-secret" // –°–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
)

func TestRegisterLogin_Login_HappyPath(t *testing.T) {
    ctx, st := suite.New(t) // –°–æ–∑–¥–∞—ë–º Suite
    // TODO: –ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ç–µ—Å—Ç–æ–≤—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ (—Å–ª—É—á–∞–π–Ω—ã–µ)
    // TODO: –°–¥–µ–ª–∞—Ç—å –Ω—É–∂–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã
    // TODO: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
}</code></pre>
<p>–í –∫–∞—á–µ—Å—Ç–≤–µ –¥–∞–Ω–Ω—ã—Ö –Ω–∞–º –ø–æ–Ω–∞–¥–æ–±–∏—Ç—Å—è –ª–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å, —Ç.–∫. –º—ã —Ç–µ—Å—Ç–∏—Ä—É–µ–º –º–µ—Ç–æ–¥ RPC-–º–µ—Ç–æ–¥ Login(). –ü—Ä–∏ —ç—Ç–æ–º –Ω–∞–º –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –Ω–∞–¥–æ –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∏—Ö —Å–ª—É—á–∞–π–Ω—ã–º –æ–±—Ä–∞–∑–æ–º - –ø–æ—Ç–æ–º—É —á—Ç–æ –º—ã –Ω–µ –æ—á–∏—â–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —Ç–µ—Å—Ç–æ–≤, –∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –æ–¥–∏–Ω–∞–∫–æ–≤—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ —É –Ω–∞—Å –±—ã—Ç—å –Ω–µ –º–æ–∂–µ—Ç. –≠—Ç–æ –ø–æ–≤—ã—à–∞–µ—Ç –∫–∞—á–µ—Å—Ç–≤–æ —Ç–µ—Å—Ç–æ–≤, —Ç.–∫. –º—ã –Ω–µ –ø—Ä–∏–≤—è–∑—ã–≤–∞–µ–º—Å—è –∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –¥–∞–Ω–Ω—ã–º, –±–æ–ª—å—à–µ —à–∞–Ω—Å–æ–≤ –ø–æ–π–º–∞—Ç—å –∫–∞–∫–æ–π-–Ω–∏–±—É–¥—å —Ä–µ–¥–∫–∏–π –±–∞–≥.</p>
<p>–ü–æ—á–µ–º—É –Ω–µ –æ—á–∏—â–∞–µ–º –ë–î –ø–æ—Å–ª–µ —Ç–µ—Å—Ç–æ–≤ - —Ç–∞–∫–∏–º –æ–±—Ä–∞–∑–æ–º –º—ã —Ç–∞–∫–∂–µ —Ç–µ—Å—Ç–∏—Ä—É–µ–º (–ø—É—Å—Ç—å –∏ –Ω–µ –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ), —á—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Å–µ–±—è –≤–µ–¥—ë—Ç –ø—Ä–∏ –ª—é–±—ã—Ö —Å–æ—Å—Ç–æ—è–Ω–∏—è—Ö –ë–î ‚Äî –∫–æ–≥–¥–∞ —Ç–∞–º –ø—É—Å—Ç–æ, –∫–æ–≥–¥–∞ –¥–∞–Ω–Ω—ã—Ö –º–Ω–æ–≥–æ, –∫–æ–≥–¥–∞ —Å—Ä–µ–¥–∏ –¥–∞–Ω–Ω—ã—Ö –µ—Å—Ç—å —Å–ª–æ–º–∞–Ω–Ω—ã–µ –∏ —Ç.–ø. –õ–∏—à–Ω–∏–º —ç—Ç–æ —Ç–æ—á–Ω–æ –Ω–µ –±—É–¥–µ—Ç. –ö—Ä–æ–º–µ —Ç–æ–≥–æ, –≤—Å–µ–≥–¥–∞ —É–¥–æ–±–Ω–æ –∏–º–µ—Ç—å –ø–æ–¥ —Ä—É–∫–æ–π –Ω–µ –ø—É—Å—Ç—É—é –ë–î, –∫–æ—Ç–æ—Ä–∞—è –∂–∏–≤–µ—Ç —Å–≤–æ–µ–π –∂–∏–∑–Ω—å –∏ –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ –ø–æ–ø–æ–ª–Ω—è–µ—Ç—Å—è –¥–∞–Ω–Ω—ã–º–∏. –ù–æ –Ω–∞–ø—Ä–∏–º–µ—Ä –≤ GitHub Actions (–∏–ª–∏, –∫ –ø—Ä–∏–º–µ—Ä—É, –≤ –ø–∞–π–ø–ª–∞–π–Ω–µ GitLab), –∫–æ–Ω–µ—á–Ω–æ –∂–µ, –±—É–¥–µ—Ç –∫–∞–∂–¥—ã–π —Ä–∞–∑ –ø–æ–¥–Ω–∏–º–∞—Ç—å—Å—è —Å–≤–µ–∂–∞—è –ë–î, –ø–æ—ç—Ç–æ–º—É —Ç–∞–º –ø—Ä–∏–¥–µ—Ç—Å—è –∫–∞–∂–¥—ã–π —Ä–∞–∑ –∑–∞–ø—É—Å–∫–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏.</p>
<p>–î–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å–ª—É—á–∞–π–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö —è –∏—Å–ø–æ–ª—å–∑—É—é –±–∏–±–ª–∏–æ—Ç–µ–∫—É brianvoe/gofakeit ‚Äî –æ—á–µ–Ω—å –∫—Ä—É—Ç–∞—è —à—Ç—É–∫–∞, –º–æ–∂–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ–≥—Ä–æ–º–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö –≤–∏–¥–æ–≤ –¥–∞–Ω–Ω—ã—Ö. –î–∞–≤–∞–π—Ç–µ —É—Å—Ç–∞–Ω–æ–≤–∏–º –µ—ë:</p>
<pre><code class="lang-bash">go get github.com/brianvoe/gofakeit/v6</code></pre>
<p>–¢–µ–ø–µ—Ä—å –º–æ–∂–µ–º —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Å–ª—É—á–∞–π–Ω—ã–µ email –∏ –ø–∞—Ä–æ–ª—å (–Ω–∞–ø–æ–º–Ω—é, —á—Ç–æ email —Å–ª—É–∂–∏—Ç —É –Ω–∞—Å –ª–æ–≥–∏–Ω–æ–º):</p>
<pre><code class="lang-go">const passDefaultLen = 10
email := gofakeit.Email()
pass := gofakeit.Password(true, true, true, true, false, passLen)
// –∏–ª–∏ –Ω–∞–ø—Ä–∏–º–µ—Ä, —á—Ç–æ–±—ã –ø—Ä–∏—á–µ—Å–∞—Ç—å –∫—Ä–∞—Å–∏–≤–µ–µ
pass := randomFakePassword()
func randomFakePassword() string {
    return gofakeit.Password(true, true, true, true, false, passDefaultLen)
}</code></pre>
<p>–¢–µ–ø–µ—Ä—å –º–æ–∂–µ–º –¥–æ–±–∞–≤–∏—Ç—å –≤—Å—ë —ç—Ç–æ –≤ —Ç–µ—Å—Ç –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç—å RPC-–∑–∞–ø—Ä–æ—Å—ã:</p>
<pre><code class="lang-go">// tests/auth_register_login_test.go
package tests

import (
    ssov1 "proto/gen/go/sso"
)

const (
    appID  = 1
    appKey = "test-secret"
    passDefaultLen = 10
)

func TestRegisterLogin_Login_HappyPath(t *testing.T) {
    ctx, st := suite.New(t)

    email := gofakeit.Email()
    pass := randomFakePassword()

    // –°–Ω–∞—á–∞–ª–∞ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –∫–æ—Ç–æ—Ä–æ–≥–æ –±—É–¥–µ–º –ª–æ–≥–∏–Ω–∏—Ç—å
    respReg, err := st.AuthClient.Register(ctx, &ssov1.RegisterRequest{
        Email:    email,
        Password: pass,
    })
    // –≠—Ç–æ –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å, –ø–æ—ç—Ç–æ–º—É –¥–µ–ª–∞–µ–º –ª–∏—à—å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏
    require.NoError(t, err)
    assert.NotEmpty(t, respReg.GetUserId())

    // –ê —ç—Ç–æ –æ—Å–Ω–æ–≤–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
    respLogin, err := st.AuthClient.Login(ctx, &ssov1.LoginRequest{
        Email:    email,
        Password: pass,
        AppId:    appID,
    })
    require.NoError(t, err)

    // –¢—â–∞—Ç–µ–ª—å–Ω–æ –ø—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã:
    // TODO: –î–æ—Å—Ç–∞–≤—ë–º –∏–∑ –æ—Ç–≤–µ—Ç–∞ —Ç–æ–∫–µ–Ω –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º –µ–≥–æ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
}</code></pre>
<p>–ù–∞—à–∏ —Ç–µ—Å—Ç—ã –Ω–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç –∑–∞—Ä–∞–Ω–µ–µ –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (–∫—Ä–æ–º–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è, –Ω–æ –º—ã –ø–æ–∫–∞ –∏ –Ω–µ –ø–ª–∞–Ω–∏—Ä—É–µ–º –¥–µ–ª–∞—Ç—å –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –Ω–∏–º–∏), –º—ã —á–µ—Å—Ç–Ω–æ –∏–º–∏—Ç–∏—Ä—É–µ–º –ø–æ–≤–µ–¥–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ‚Äî –æ–Ω –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–ª—Å—è –∏ –ø—ã—Ç–∞–µ—Ç—Å—è –∑–∞–ª–æ–≥–∏–Ω–∏—Ç—å—Å—è. –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ –∑–Ω–∞–µ—Ç, —á—Ç–æ —ç—Ç–æ –ª–∏—à—å —Ç–µ—Å—Ç, –¥–ª—è –Ω–µ–≥–æ —ç—Ç–æ –≤–ø–æ–ª–Ω–µ —Ä–µ–∞–ª—å–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã.</p>
<p>–í —ç—Ç–æ–º —Ç–µ—Å—Ç–µ –º—ã –ø—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–±–æ—Ç—É –º–µ—Ç–æ–¥–∞ Login(), –∞ —Å–∞–º–æ–µ –≤–∞–∂–Ω–æ–µ –≤ –Ω—ë–º ‚Äî —ç—Ç–æ —Ç–æ–∫–µ–Ω, –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–∏—Ö–æ–¥–∏—Ç —Å –æ—Ç–≤–µ—Ç–æ–º –æ—Ç Auth-—Å–µ—Ä–≤–µ—Ä–∞. –≠—Ç–æ –∑–Ω–∞—á–∏—Ç, —á—Ç–æ –Ω–∞–º –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –≤—ã–ø–æ–ª–Ω–∏—Ç—å —Ç–µ –∂–µ –¥–µ–π—Å—Ç–≤–∏—è, –∫–æ—Ç–æ—Ä—ã–µ –±—É–¥–µ—Ç —Å–æ–≤–µ—Ä—à–∞—Ç—å –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ:</p>
<ul>
    <li>jwt.Parse() ‚Äî –ø–∞—Ä—Å–∏–Ω–≥ –∏ –≤–∞–ª–∏–¥–∞—Ü–∏—è —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º —Å–µ–∫—Ä–µ—Ç–Ω–æ–≥–æ –∫–ª—é—á–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è</li>
    <li>–ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Å–µ—Ö –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –ø–æ–ª–µ–π, –∫–æ—Ç–æ—Ä—ã–µ –ø—Ä–∏—à–ª–∏ –≤–º–µ—Å—Ç–µ —Å —Ç–æ–∫–µ–Ω–æ–º: uid, email, app_id</li>
</ul>
<p>–î–æ–±–∞–≤–∏–º —ç—Ç–∏ –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤ –Ω–∞—à —Ç–µ—Å—Ç:</p>
<pre><code class="lang-go">
...
// –ü–æ–ª—É—á–∞–µ–º —Ç–æ–∫–µ–Ω –∏–∑ –æ—Ç–≤–µ—Ç–∞
token := respLogin.GetToken()
require.NotEmpty(t, token) // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –æ–Ω –Ω–µ –ø—É—Å—Ç–æ–π

// –û—Ç–º–µ—á–∞–µ–º –≤—Ä–µ–º—è, –≤ –∫–æ—Ç–æ—Ä–æ–µ –±—ã –≤—ã–ø–æ–ª–Ω–µ–Ω –ª–æ–≥–∏–Ω.
// –≠—Ç–æ –ø–æ–Ω–∞–¥–æ–±–∏—Ç—Å—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ TTL —Ç–æ–∫–µ–Ω–∞
loginTime := time.Now()

// –ü–∞—Ä—Å–∏–º –∏ –≤–∞–ª–∏–¥–∏—Ä—É–µ–º —Ç–æ–∫–µ–Ω
tokenParsed, err := jwt.Parse(token, func(token *jwt.Token) (interface{}, error) {
    return []byte(appSecret), nil
})
// –ï—Å–ª–∏ –∫–ª—é—á –æ–∫–∞–∂–µ—Ç—Å—è –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–º, –º—ã –ø–æ–ª—É—á–∏–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â—É—é –æ—à–∏–±–∫—É
require.NoError(t, err)

// –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –∫ —Ç–∏–ø—É jwt.MapClaims, –≤ –∫–æ—Ç–æ—Ä–æ–º –º—ã —Å–æ—Ö—Ä–∞–Ω—è–ª–∏ –¥–∞–Ω–Ω—ã–µ
claims, ok := tokenParsed.Claims.(jwt.MapClaims)
require.True(t, ok)

// –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ç–æ–∫–µ–Ω–∞
assert.Equal(t, respReg.GetUserId(), int64(claims["uid"].(float64)))
assert.Equal(t, email, claims["email"].(string))
assert.Equal(t, appID, int(claims["app_id"].(float64)))

const deltaSeconds = 1

// –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ TTL —Ç–æ–∫–µ–Ω–∞ –ø—Ä–∏–º–µ—Ä–Ω–æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –Ω–∞—à–∏–º –æ–∂–∏–¥–∞–Ω–∏—è–º.
assert.InDelta(t, loginTime.Add(st.Cfg.TokenTTL).Unix(), claims["exp"].(float64), deltaSeconds)
....</code></pre>
<p>–í—Ä–µ–º—è, –∫–æ—Ç–æ—Ä–æ–µ –º—ã –æ—Ç–º–µ—á–∞–µ–º –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é loginTime –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–º–Ω–æ–≥–æ –Ω–µ—Ç–æ—á–Ω—ã–º, —Ç.–∫. —Ç–æ—á–Ω–æ–µ –≤—Ä–µ–º—è –æ–ø—Ä–µ–¥–µ–ª—è–µ–º —Å–µ—Ä–≤–µ—Ä Auth, –∞ –¥–ª—è –Ω–∞—à–∏—Ö —Ç–µ—Å—Ç–æ–≤ –æ–Ω, –∫–∞–∫ –º—ã –ø–æ–º–Ω–∏–º, —á–µ—Ä–Ω–∞—è –∫–æ—Ä–æ–±–∫–∞. –¢–æ –µ—Å—Ç—å, –º–æ–∂–µ—Ç –±—ã—Ç—å –ª–∞–≥ –º–µ–∂–¥—É –º–æ–º–µ–Ω—Ç–æ–º –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–ø—Ä–æ—Å–∞ —Å–µ—Ä–≤–µ—Ä–æ–º –∏ –ø–æ–ª—É—á–µ–Ω–∏–µ–º –Ω–∞–º–∏ –æ—Ç–≤–µ—Ç–∞. –î–ª—è —Ç–µ—Å—Ç–æ–≤ –Ω–∞—Å —ç—Ç–æ —É—Å—Ç—Ä–æ–∏—Ç, –Ω–æ –Ω–∞–º –ø—Ä–∏–¥–µ—Ç—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—é assert.InDelta –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∑–Ω–∞—á–µ–Ω–∏—è exp (expiration time). –ê –∏–º–µ–Ω–Ω–æ, –º—ã –±–µ—Ä—ë–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π –≤—ã—à–µ loginTime, –¥–æ–±–∞–≤–ª—è–µ–º –∫ –Ω–µ–º—É st.Cfg.TokenTTL, –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ–º —ç—Ç–æ –≤ UnixTimestamp (–≤ –∫–æ—Ç–æ—Ä–æ–º –º—ã –∏–∑–Ω–∞—á–∞–ª—å–Ω–æ —Å–æ—Ö—Ä–∞–Ω—è–ª–∏), –∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø–æ–ª–µ exp —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —ç—Ç–æ–º—É –∑–Ω–∞—á–µ–Ω–∏—é —Å —Ç–æ—á–Ω–æ—Å—Ç—å—é –¥–æ –æ–¥–Ω–æ–π —Å–µ–∫—É–Ω–¥—ã.</p>
<p><b>–ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤</b></p>
<p>–ï—Å–ª–∏ —É –≤–∞—Å —Å–≤–µ–∂–∞—è —á–∏—Å—Ç–∞—è –ë–î, —Ç–æ –ø–µ—Ä–≤—ã–º –¥–µ–ª–æ–º –ø—Ä–æ–≥–æ–Ω—è–µ–º –æ—Å–Ω–æ–≤–Ω—ã–µ –º–∏–≥—Ä–∞—Ü–∏:</p>
<pre><code class="lang-go">go run ./cmd/migrator \
    --storage-path=./storage/sso.db \
    --migrations-path=./migrations</code></pre>
<p>–ó–∞—Ç–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –º–∏–≥—Ä–∞—Ü–∏–∏:</p>
<pre><code class="lang-go">go run ./cmd/migrator \
    --storage-path=./storage/sso.db \
    --migrations-path=./tests/migrations \
    --migrations-table=migrations_test</code></pre>
<p>–¢–µ–ø–µ—Ä—å –∑–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ:</p>
<pre><code class="lang-go">go run ./cmd/sso --config=./config/local_tests_config.yaml</code></pre>
<p>–õ—É—á—à–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–ª—è —Ç–µ—Å—Ç–æ–≤ –æ—Ç–¥–µ–ª—å–Ω—ã–π –∫–æ–Ω—Ñ–∏–≥-—Ñ–∞–π–ª, –ø–æ—ç—Ç–æ–º—É –∑–¥–µ—Å—å —É–∫–∞–∑–∞–Ω–æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–µ –∏–º—è: local_tests_config.yaml. –ù–æ –¥–µ–ª–∞—Ç—å —Ç–∞–∫ –Ω–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ.</p>
<p>–ò –Ω–∞–∫–æ–Ω–µ—Ü –º–æ–∂–µ–º –∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–∞–º–∏ —Ç–µ—Å—Ç—ã, —É–∫–∞–∑–∞–≤ –≥–¥–µ –æ–Ω–∏ –Ω–∞—Ö–æ–¥—è—Ç—Å—è (–Ω–µ –∑–∞–±—ã—Ç—å –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –≤ –ë–î –¥–æ–±–∞–≤–∏–ª—Å—è App —Å id = 1):</p>
<pre><code class="lang-go">go test ./tests -count=1 -v</code></pre>
<p>–ü–∞—Ä–∞–º–µ—Ç—Ä -count=1 ‚Äî —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —Å–ø–æ—Å–æ–± –∑–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç—ã —Å –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ–º –∫—ç—à–∞, –∞ -v –¥–æ–±–∞–≤–∏—Ç—å –±–æ–ª—å—à–µ –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–µ–π –≤ –≤—ã–≤–æ–¥ —Ç–µ—Å—Ç–∞.</p>
<p>–ö—Ä–æ–º–µ —Ç–æ–≥–æ, –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã —Ç–µ—Å—Ç–æ–≤ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∑–∞–≥—Ä—É–∂–∞—Ç—å –∫–æ–Ω—Ñ–∏–≥. –î–ª—è —ç—Ç–æ–≥–æ –∏–∑–º–µ–Ω–∏—Ç—å –ø–æ–¥–≥—Ä—É–∑–∫—É –≤ config.go:</p>
<pre><code class="lang-go">// internal/config/config.go
...
func MustLoad() *Config {
	configPath := fetchConfigPath()
	if configPath == "" {
		panic("config path is empty")
	}
	return MustLoadPath(configPath)
}

func MustLoadPath(configPath string) *Config {
	if _, err := os.Stat(configPath); os.IsNotExist(err) {
		panic("config file does not exist: " + configPath)
	}
	var cfg Config
	if err := cleanenv.ReadConfig(configPath, &cfg); err != nil {
		panic("cannot read config: " + err.Error())
	}
	return &cfg
}
...</code></pre>
<p>–¢–∞–∫–∂–µ –ø–æ–ø—Ä–∞–≤–∏–º suite.go:</p>
<pre><code class="lang-go">// tests/suite/suite.go
const (
	grpcHost = "localhost"
)

func New(t *testing.T) (context.Context, *Suite) {
	...
	cfg := config.MustLoadPath(configPath())
	ctx, cancelCtx := context.WithTimeout(context.Background(), cfg.GRPC.Timeout)
	t.Cleanup(func() {
		t.Helper()
		cancelCtx()
	})
	cc, err := grpc.NewClient(
		grpcAddress(cfg),
		// context.Background(),
		grpc.WithTransportCredentials(insecure.NewCredentials()),
	)
    ...
}

func configPath() string {
	const key = "CONFIG_PATH"
	if v := os.Getenv(key); v != "" {
		return v
	}
	return "../config/local_tests.yaml"
}

func grpcAddress(cfg *config.Config) string {
	return net.JoinHostPort(grpcHost, strconv.Itoa(cfg.GRPC.Port))
}
</code></pre>
<p>–¢–µ–ø–µ—Ä—å —Ç–µ—Å—Ç—ã –¥–æ–ª–∂–Ω—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ—Ç—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å.</p>
<p><b>–ù–µ–≥–∞—Ç–∏–≤–Ω—ã–µ –∫–µ–π—Å—ã</b></p>
<p>–û–±—ã—á–Ω–æ —Å —Ç–µ—Å—Ç–∞—Ö —Å–∞–º—ã–º–∏ –ø–æ–ª–µ–∑–Ω—ã–º–∏ —è–≤–ª—è—é—Ç—Å—è –Ω–µ–≥–∞—Ç–∏–≤–Ω—ã–µ –∫–µ–π—Å—ã. –¢–æ –µ—Å—Ç—å, –º—ã –ø—ã—Ç–∞–µ–º—Å—è —Å–ª–æ–º–∞—Ç—å –Ω–∞—à–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ, –∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –æ–Ω–æ –≤–µ–¥—ë—Ç —Å–µ–±—è —Ç–∞–∫, –∫–∞–∫ –º—ã –æ–∂–∏–¥–∞–µ–º. –ü–æ–∫–∞–∂–µ–º –ø–∞—Ä—É –ø—Ä–∏–º–µ—Ä–æ–≤. –ß—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç —Å–¥–µ–ª–∞—Ç—å –Ω–µ —Ç–∞–∫? –ù–∞–ø—Ä–∏–º–µ—Ä, –æ–Ω –º–æ–∂–µ—Ç –ø–æ–ø—ã—Ç–∞—Ç—å—Å—è –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑ —Å –æ–¥–∏–Ω–∞–∫–æ–≤—ã–º –ª–æ–≥–∏–Ω–æ–º. –ù–∞—à–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ –¥–æ–ª–∂–Ω–æ —Ç–∞–∫–æ–µ –ø–æ–∑–≤–æ–ª—è—Ç—å, –∏ –¥–æ–ª–∂–Ω–æ –æ—Ç–≤–µ—á–∞—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –æ—à–∏–±–∫–æ–π. –ò —É–∂ —Ç–µ–º –±–æ–ª–µ–µ, –æ–Ω–æ –Ω–µ –¥–æ–ª–∂–Ω–æ –ø–∞–¥–∞—Ç—å —Å –ø–∞–Ω–∏–∫–æ–π, –Ω–∞–ø—Ä–∏–º–µ—Ä. –¢–µ—Å—Ç –º–æ–∂–µ—Ç –≤—ã–≥–ª—è–¥–µ—Ç—å, –Ω–∞–ø—Ä–∏–º–µ—Ä, —Ç–∞–∫:</p>
<pre><code class="lang-go">func TestRegisterLogin_DuplicatedRegistration(t *testing.T) {
    ctx, st := suite.New(t)

    email := gofakeit.Email()
    pass := randomFakePassword()

    // –ü–µ—Ä–≤–∞—è –ø–æ–ø—ã—Ç–∫–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —É—Å–ø–µ—à–Ω–æ–π
    respReg, err := st.AuthClient.Register(ctx, &ssov1.RegisterRequest{
        Email:    email,
        Password: pass,
    })
    require.NoError(t, err)
    require.NotEmpty(t, respReg.GetUserId())

    // –í—Ç–æ—Ä–∞—è –ø–æ–ø—ã—Ç–∫–∞ - —Ñ—ç–∏–ª
    respReg, err = st.AuthClient.Register(ctx, &ssov1.RegisterRequest{
        Email:    email,
        Password: pass,
    })
    require.Error(t, err)
    assert.Empty(t, respReg.GetUserId())
    assert.ErrorContains(t, err, "user already exists")
}</code></pre>
<p>–¢–∞–∫–∂–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –ø—Ä–∏—Å—ã–ª–∞—Ç—å –Ω–µ–≤–µ—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –Ω–∞ –≤—Ö–æ–¥. –í–∞—Ä–∏–∞—Ü–∏–π –ø–æ–¥–æ–±–Ω—ã—Ö –∫–µ–π—Å–æ–≤ –¥–æ–≤–æ–ª—å–Ω–æ –º–Ω–æ–≥–æ, –∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∏–º–µ—Ä–Ω–æ –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ, –ø–æ—ç—Ç–æ–º—É –º—ã –Ω–∞–ø–∏—à–µ–º —Ç–∞–±–ª–∏—á–Ω—ã–µ —Ç–µ—Å—Ç—ã. –ù–∞—á–Ω—ë–º —Å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:</p>
<pre><code class="lang-go">func TestRegister_FailCases(t *testing.T) {
    ctx, st := suite.New(t)

    tests := []struct {
        name        string
        email       string
        password    string
        expectedErr string
    }{
        {
            name:        "Register with Empty Password",
            email:       gofakeit.Email(),
            password:    "",
            expectedErr: "password is required",
        },
        {
            name:        "Register with Empty Email",
            email:       "",
            password:    randomFakePassword(),
            expectedErr: "email is required",
        },
        {
            name:        "Register with Both Empty",
            email:       "",
            password:    "",
            expectedErr: "email is required",
        },
    }

    for _, tt := range tests {
        t.Run(tt.name, func(t *testing.T) {
            _, err := st.AuthClient.Register(ctx, &ssov1.RegisterRequest{
                Email:    tt.email,
                Password: tt.password,
            })
            require.Error(t, err)
            require.Contains(t, err.Error(), tt.expectedErr)

        })
    }
}</code></pre>
<p>–ò –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ –¥–ª—è –ª–æ–≥–∏–Ω–∞:</p>
<pre><code class="lang-go">func TestLogin_FailCases(t *testing.T) {
    ctx, st := suite.New(t)

    tests := []struct {
        name        string
        email       string
        password    string
        appID       int32
        expectedErr string
    }{
        {
            name:        "Login with Empty Password",
            email:       gofakeit.Email(),
            password:    "",
            appID:       appID,
            expectedErr: "password is required",
        },
        {
            name:        "Login with Empty Email",
            email:       "",
            password:    randomFakePassword(),
            appID:       appID,
            expectedErr: "email is required",
        },
        {
            name:        "Login with Both Empty Email and Password",
            email:       "",
            password:    "",
            appID:       appID,
            expectedErr: "email is required",
        },
        {
            name:        "Login with Non-Matching Password",
            email:       gofakeit.Email(),
            password:    randomFakePassword(),
            appID:       appID,
            expectedErr: "invalid email or password",
        },
        {
            name:        "Login without AppID",
            email:       gofakeit.Email(),
            password:    randomFakePassword(),
            appID:       emptyAppID,
            expectedErr: "app_id is required",
        },
    }

    for _, tt := range tests {
        t.Run(tt.name, func(t *testing.T) {
            _, err := st.AuthClient.Register(ctx, &ssov1.RegisterRequest{
                Email:    gofakeit.Email(),
                Password: randomFakePassword(),
            })
            require.NoError(t, err)

            _, err = st.AuthClient.Login(ctx, &ssov1.LoginRequest{
                Email:    tt.email,
                Password: tt.password,
                AppId:    tt.appID,
            })
            require.Error(t, err)
            require.Contains(t, err.Error(), tt.expectedErr)
        })
    }
}</code></pre>
<h3 class="section-title" id="integration">–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –≤–Ω–µ—à–Ω–∏–º —Å–µ—Ä–≤–∏—Å–æ–º ‚Äî URL Shortener</h3>
<p>–ß–∞—â–µ –≤—Å–µ–≥–æ gRPC –∏—Å–ø–æ–ª—å–∑—É—é—Ç –¥–ª—è –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è –º–µ–∂–¥—É —Å–µ—Ä–≤–∏—Å–∞–º–∏, –ø–æ—ç—Ç–æ–º—É –º—ã –Ω–µ –º–æ–∂–µ–º –Ω–µ –∑–∞—Ç—Ä–æ–Ω—É—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞—à–µ–≥–æ SSO –∫ –∫–æ–º—É-–Ω–∏–±—É–¥—å –≤–Ω–µ—à–Ω–µ–º—É —Å–µ—Ä–≤–∏—Å—É. –î–µ–ª–∞–µ—Ç—Å—è —ç—Ç–æ –¥–æ–≤–æ–ª—å–Ω–æ –ø—Ä–æ—Å—Ç–æ, –ø–æ—ç—Ç–æ–º—É –≤ –∫–∞—á–µ—Å—Ç–≤–µ —Ç–∞–∫–æ–≥–æ —Å–µ—Ä–≤–∏—Å–∞ –º–æ–∂–µ—Ç–µ –≤–∑—è—Ç—å –ª—é–±–æ–π –ø–µ—Ç-–ø—Ä–æ–µ–∫—Ç –∏–ª–∏ –Ω–∞–±—Ä–æ—Å–∞—Ç—å —á—Ç–æ-—Ç–æ –Ω–∞ –∫–æ–ª–µ–Ω–∫–µ. –ú—ã –∂–µ –±—É–¥–µ–º —Ä–∞–±–æ—Ç–∞—Ç—å –Ω–∞ –ø—Ä–∏–º–µ—Ä–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –≤ URL Shortener, —Å—Ç–∞—Ç—å—è –æ –∫–æ—Ç–æ—Ä–æ–º –µ—Å—Ç—å —Ä—è–¥–æ–º –Ω–∞ —Å–∞–π—Ç–µ.</p>
<p>–ò—Ç–∞–∫, –¥–ª—è –Ω–∞—á–∞–ª–∞ –Ω–∞–º –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è –µ—â—ë –æ–¥–Ω–∞ —Ä—É—á–∫–∞. –î–µ–ª–æ –≤ —Ç–æ–º, —á—Ç–æ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –º–µ—Ç–æ–¥—ã (Login / RegisterNewUser) –≤–Ω–µ—à–Ω–µ–º—É —Å–µ—Ä–≤–∏—Å—É –Ω–µ —Å–∏–ª—å–Ω–æ –Ω—É–∂–Ω—ã –ø—Ä–∏ –Ω–∞—à–µ–π —Ç–µ–∫—É—â–µ–π —Å—Ö–µ–º–µ. –ù–∞–ø–æ–º–Ω—é, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å (–∏–ª–∏ –µ–≥–æ –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ) —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ –∏–¥—ë—Ç –≤ SSO –∑–∞ —Ç–æ–∫–µ–Ω–æ–º, –∏ —Å —ç—Ç–∏–º —Ç–æ–∫–µ–Ω–æ–º —É–∂–µ –∏–¥–µ—Ç –≤ URL Shortener, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–∫–∞ –ø—Ä–æ—Å—Ç–æ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ç–æ–∫–µ–Ω–∞, –±–µ–∑ –∫–∞–∫–∏—Ö-–ª–∏–±–æ –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ SSO —Å–æ —Å–≤–æ–µ–π —Å—Ç–æ—Ä–æ–Ω—ã.</p>
<p><b>gRPC-–º–µ—Ç–æ–¥: IsAdmin()</b></p>
<p>–î–ª—è —Ç–æ–≥–æ, —á—Ç–æ–±—ã –Ω–µ –ø–µ—Ä–µ—É—Å–ª–æ–∂–Ω—è—Ç—å —Å—Ç–∞—Ç—å—é, –¥–æ–±–∞–≤–∏–º –ø—Ä–æ—Å—Ç–µ–π—à—É—é, –Ω–æ –ø—Ä–∏ —ç—Ç–æ–º –æ—á–µ–Ω—å –ø–æ–ª–µ–∑–Ω—É—é, –Ω–æ–≤—É—é —Ä—É—á–∫—É: sso.IsAdmin(userID). –û–Ω–∞ –±—É–¥–µ—Ç —Å–æ–æ–±—â–∞—Ç—å, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Ç–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–¥–º–∏–Ω–æ–º. Shortener –∂–µ —Å –µ—ë –ø–æ–º–æ—â—å—é –±—É–¥–µ—Ç —Ä–µ—à–∞—Ç—å ‚Äî –ø–æ–∑–≤–æ–ª—è—Ç—å –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —á—É–∂–∏–µ –∑–∞–ø–∏—Å–∏. –ù–∞ –∫–∞–∫–∏–µ —É–ø—Ä–æ—â–µ–Ω–∏—è –º—ã –∑–¥–µ—Å—å –ø–æ–π–¥–µ–º:</p>
<ul>
    <li>–†—É—á–∫–∞ –Ω–µ –±—É–¥–µ–º –∑–∞—â–∏—â–µ–Ω–∞: —Ç–æ –µ—Å—Ç—å, –ª—é–±–æ–π –∂–µ–ª–∞—é—â–∏–π —Å–º–æ–∂–µ—Ç —É–∑–Ω–∞—Ç—å, –∫—Ç–æ —è–≤–ª—è–µ—Ç—Å—è –∞–¥–º–∏–Ω–æ–º.</li>
    <li>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –±—É–¥–µ—Ç –∞–¥–º–∏–Ω–æ–º —Å—Ä–∞–∑—É –≤–æ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–∞—Ö: –Ω–µ –±—É–¥–µ–º –ø–æ–∫–∞ –∑–∞–º–æ—Ä–∞—á–∏–≤–∞—Ç—å—Å—è —Å–æ —Å–ª–æ–∂–Ω–æ–π —Å–∏—Å—Ç–µ–º–æ–π —Ä–æ–ª–µ–π</li>
    <li>–û—Ç–ø—Ä–∞–≤–ª—è—Ç—å –≤–º–µ—Å—Ç–æ userID –≤–µ—Å—å JWT-—Ç–æ–∫–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: —ç—Ç–æ —É—Å–ª–æ–∂–Ω–∏—Ç –ª—é–±–æ–ø—ã—Ç–Ω—ã–º –ª–∏—Ü–∞–º –ø–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ ‚Äî –∏–º –Ω—É–∂–Ω–æ –±—É–¥–µ—Ç —É–∫—Ä–∞—Å—Ç—å –Ω–∞—Å—Ç–æ—è—â–∏–π –ø–æ–¥–ø–∏—Å–∞–Ω–Ω—ã–π JWT-—Ç–æ–∫–µ–Ω, –∞ –Ω–µ –ø—Ä–æ—Å—Ç–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –ª—é–±–æ–π userID. –≠—Ç–æ –Ω–µ —Å–∞–º—ã–π –ª—É—á—à–∏–π –≤–∞—Ä–∏–∞–Ω—Ç, –Ω–æ –∑–∞—Ç–æ –æ–Ω —Å–∞–º—ã–π –ø—Ä–æ—Å—Ç–æ–π.</li>
</ul>
<p>–í —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–º –ø–ª–∞–Ω–µ —Ä–µ—à–µ–Ω–∏–µ —Ç–æ–∂–µ –±—É–¥–µ—Ç —É–ø—Ä–æ—â—ë–Ω–Ω–æ–µ: –º—ã –ø—Ä–æ—Å—Ç–æ –¥–æ–±–∞–≤–∏–º –∫–æ–ª–æ–Ω–∫—É is_admin –≤ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π —Ç–∞–±–ª–∏—Ü–µ users. –≠—Ç–æ –Ω–µ –æ—á–µ–Ω—å —Ö–æ—Ä–æ—à–æ, —Ç.–∫. –¥–∞–Ω–Ω—ã–µ —Å—Ç–æ–∏—Ç –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞—Ç—å ‚Äî –∞ –∏–º–µ–Ω–Ω–æ, –≤—ã–Ω–µ—Å—Ç–∏ —Ä–æ–ª–∏ / –ø—Ä–∞–≤–∞ –≤ –æ—Ç–¥–µ–ª—å–Ω—É—é —Ç–∞–±–ª–∏—Ü—É. –ü—Ä–µ–¥—Å—Ç–∞–≤–∏–º, —á—Ç–æ —É –Ω–∞—Å –º–∏–ª–ª–∏–æ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –∞ –∞–¥–º–∏–Ω–æ–≤ –≤—Å–µ–≥–æ 10 ‚Äî –ø—Ä–∏–¥—ë—Ç—Å—è —Ö—Ä–∞–Ω–∏—Ç—å –º–∏–ª–ª–∏–æ–Ω –∑–Ω–∞—á–µ–Ω–∏–π is_admin, —Ö–æ—Ç—è –º–æ–≥–ª–∏ –±—ã —Å–¥–µ–ª–∞—Ç—å –≤—Å–µ–≥–æ 10 –∑–∞–ø–∏—Å–µ–π –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–π —Ç–∞–±–ª–∏—á–∫–µ. –°–æ–≤–µ—Ç - —Å—Ä–∞–∑—É –ø–µ—Ä–µ–¥–µ–ª–∞—Ç—å –Ω–∞ –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—É—é —Ç–∞–±–ª–∏—Ü—É.</p>
<p>–ü–µ—Ä–≤—ã–º –¥–µ–ª–æ–º –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π –º–µ—Ç–æ–¥ –≤ –∫–æ–Ω—Ç—Ä–∞–∫—Ç. –û—Ç–∫—Ä—ã–≤–∞–µ–º –Ω–∞—à sso.proto –∏ –¥–æ–±–∞–≤–ª—è–µ–º:</p>
<pre><code class="lang-proto">service Auth {
    // ...
    // IsAdmin checks whether a user is an admin.
    rpc IsAdmin (IsAdminRequest) returns (IsAdminResponse);
}

message IsAdminRequest {
    int64 user_id = 1; // User ID to validate.
}

message IsAdminResponse {
    bool is_admin = 1;  // Indicates whether the user is an admin.
}</code></pre>
<p>–¢–µ–ø–µ—Ä—å, –Ω–∞–º –Ω—É–∂–Ω–æ:</p>
<ul>
    <li>–ù–∞–ø–∏—Å–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–æ–ª–æ–Ω–∫–∏ is_admin</li>
    <li>–î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–æ–¥ IsAdmin() –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π</li>
    <li>–î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–æ–¥ IsAdmin() –≤ —Å–µ—Ä–≤–∏—Å Auth (–≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π)</li>
    <li>–î–æ–±–∞–≤–∏—Ç—å gRPC-–º–µ—Ç–æ–¥ IsAdmin()</li>
</ul>
<p>–ß—Ç–æ –ø–æ–¥–µ–ª–∞—Ç—å, —Ç–∞–∫–æ–≤—ã —Ä–µ–∞–ª–∏–∏ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ —Å–µ—Ä–≤–∏—Å–æ—Å—Ç—Ä–æ–µ–Ω–∏—è :) –≠—Ç–æ –µ—â–µ –Ω–µ —Å–∞–º–æ–µ —Å—Ç—Ä–∞—à–Ω–æ–µ, –ø–æ—Ä–æ–π –ø—Ä–∏—Ö–æ–¥–∏—Ç—Å—è –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –º–æ–¥–µ–ª—å –º–µ–∂–¥—É –∫–∞–∂–¥—ã–º —Å–ª–æ–µ–º. –û—Ç —á–∞—Å—Ç–∏, –ø–æ—ç—Ç–æ–º—É –±—É–¥–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å int64 –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å userID –≤–º–µ—Å—Ç–æ –∫–∞—Å—Ç–æ–º–Ω–æ–≥–æ —Ç–∏–ø–∞ (—Ö–æ—Ç—è, –ø–æ—Å–ª–µ–¥–Ω–µ–µ –±—ã–ª–æ –±—ã –ª—É—á—à–µ).</p>
<p>–ò–¥—ë–º –ø–æ –ø–æ—Ä—è–¥–∫—É, –Ω–∞—á–∏–Ω–∞—è —Å –º–∏–≥—Ä–∞—Ü–∏–∏:</p>
<pre><code class="lang-sql">-- migrations/2_add_is_admin_column_to_users_tbl.up.sql
ALTER TABLE users
    ADD COLUMN is_admin BOOLEAN NOT NULL DEFAULT FALSE;</code></pre>
<p>–ò –æ–±—Ä–∞—Ç–Ω–∞—è:</p>
<pre><code class="lang-sql">-- migrations/2_add_is_admin_column_to_users_tbl.down.sql
ALTER TABLE users DROP COLUMN is_admin;</code></pre>
<p>–ó–∞–ø—É—Å–∫–∞–µ–º –º–∏–≥—Ä–∞—Ç–æ—Ä:</p>
<pre><code class="lang-bash">go run ./cmd/migrator \
    --storage-path=./storage/sso.db \
    --migrations-path=./migrations</code></pre>
<p>–¢–µ–ø–µ—Ä—å –º–µ—Ç–æ–¥ –¥–ª—è —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è:</p>
<pre><code class="lang-go">// internal/storage/sqlite/sqlite.go

func (s *Storage) IsAdmin(ctx context.Context, userID int64) (bool, error) {
    const op = "storage.sqlite.IsAdmin"

    stmt, err := s.db.Prepare("SELECT is_admin FROM users WHERE id = ?")
    if err != nil {
        return false, fmt.Errorf("%s: %w", op, err)
    }
    row := stmt.QueryRowContext(ctx, userID)
    var isAdmin bool
    err = row.Scan(&isAdmin)
    if err != nil {
        if errors.Is(err, sql.ErrNoRows) {
            return false, fmt.Errorf("%s: %w", op, storage.ErrUserNotFound)
        }
        return false, fmt.Errorf("%s: %w", op, err)
    }
    return isAdmin, nil
}</code></pre>
<p>–ú–µ—Ç–æ–¥ –¥–ª—è —Å–µ—Ä–≤–∏—Å–∞ Auth (–Ω–µ –∑–∞–±—ã–≤–∞–µ–º –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π –º–µ—Ç–æ–¥ –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å UserProvider):</p>
<pre><code class="lang-go">// internal/services/auth/auth.go

type UserProvider interface {
    // ...
    IsAdmin(ctx context.Context, userID int64) (bool, error)
}

// IsAdmin checks if user is admin.
func (a *Auth) IsAdmin(ctx context.Context, userID int64) (bool, error) {
    const op = "Auth.IsAdmin"

    log := a.log.With(
        slog.String("op", op),
        slog.Int64("user_id", userID),
    )
    log.Info("checking if user is admin")
    isAdmin, err := a.usrProvider.IsAdmin(ctx, userID)
    if err != nil {
        return false, fmt.Errorf("%s: %w", op, err)
    }
    log.Info("checked if user is admin", slog.Bool("is_admin", isAdmin))
    return isAdmin, nil
}</code></pre>
<p>–ò –Ω–∞–∫–æ–Ω–µ—Ü –º–µ—Ç–æ–¥ –¥–ª—è —Å–µ—Ä–≤–µ—Ä–∞ (–Ω–µ –∑–∞–±—ã–≤ –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π –º–µ—Ç–æ–¥ –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å Auth):</p>
<pre><code class="lang-go">// internal/grpc/auth/server.go

type Auth interface {
    // ...
    IsAdmin(ctx context.Context, userID int64) (bool, error)
}

func (s *serverAPI) IsAdmin(
    ctx context.Context,
    in *ssov1.IsAdminRequest,
) (*ssov1.IsAdminResponse, error) {
    if in.UserId == 0 {
        return nil, status.Error(codes.InvalidArgument, "user_id is required")
    }
    isAdmin, err := s.auth.IsAdmin(ctx, in.GetUserId())
    if err != nil {
        if errors.Is(err, storage.ErrUserNotFound) {
            return nil, status.Error(codes.NotFound, "user not found")
        }
        return nil, status.Error(codes.Internal, "failed to check admin status")
    }
    return &ssov1.IsAdminResponse{IsAdmin: isAdmin}, nil
}</code></pre>
<p><b>TODO</b></p>

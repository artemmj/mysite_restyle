<h1 class="article-title">–ù–∞—Å—Ç—Ä–æ–π–∫–∞ JWT –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –≤ Django</h1>
<div class="article-meta">
    <span>üóì 25 –ú–∞—Ä—Ç–∞ 2025</span>
    <span>üè∑Ô∏è Django, JWT</span>
</div>
<pre><code class="lang-bash">pip install PyJWT</code></pre>
<pre><code class="lang-bash">python project/manage.py startapp user</code></pre>
<pre><code class="lang-py">import jwt
from datetime import datetime, timedelta

from django.conf import settings
from django.contrib.auth.models import AbstractBaseUser, BaseUserManager, PermissionsMixin
from django.db import models


class User(AbstractBaseUser, PermissionsMixin):
    username = models.CharField(db_index=True, max_length=255, unique=True)
    email = models.EmailField(db_index=True, unique=True)
    is_active = models.BooleanField(default=True)
    is_staff = models.BooleanField(default=False)
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

    USERNAME_FIELD = 'email'  # —Å–æ–æ–±—â–∞–µ—Ç, –∫–∞–∫–æ–µ –ø–æ–ª–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–ª—è –≤—Ö–æ–¥–∞ –≤ —Å–∏—Å—Ç–µ–º—É
    REQUIRED_FIELDS = ['username']  # –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è

    objects = UserManager()

    def __str__(self):
        return self.email

    @property
    def token(self):
        return self._generate_jwt_token()

    def get_full_name(self):
        return self.username

    def get_short_name(self):
        return self.username

    def _generate_jwt_token(self):
        dt = datetime.now() + timedelta(days=1)
        return jwt.encode({
            'id': self.pk,
            'exp': int(dt.strftime('%s'))
        }, settings.SECRET_KEY, algorithm='HS256')</code></pre>
<pre><code class="lang-py">from django.contrib.auth.models import BaseUserManager

class UserManager(BaseUserManager):
    def create_user(self, username, email, password=None):
        """ –°–æ–∑–¥–∞–µ—Ç –æ–±—ã—á–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è."""
        if username is None:
            raise TypeError('Users must have a username.')
        if email is None:
            raise TypeError('Users must have an email address.')
        user = self.model(username=username, email=self.normalize_email(email))
        user.set_password(password)
        user.save()
        return user

    def create_superuser(self, username, email, password):
        """ –°–æ–∑–¥–∞–µ—Ç —Å—É–ø–µ—Ä–∞–¥–º–∏–Ω–∞."""
        if password is None:
            raise TypeError('Superusers must have a password.')
        user = self.create_user(username, email, password)
        user.is_superuser = True
        user.is_staff = True
        user.save()
        return user</code></pre>
<p>–í settings —É–∫–∞–∑–∞—Ç—å –º–æ–¥–µ–ª—å —é–∑–µ—Ä–∞, –ø—Ä–æ–≤–µ—Å—Ç–∏ –º–∏–≥—Ä–∞—Ü–∏—é, –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å —é–∑–µ—Ä–∞ –≤ admin.py</p>
<pre><code class="lang-py">AUTH_USER_MODEL = 'user.User'</code></pre>
<h3 class="section-title">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</h3>
<pre><code class="lang-py">from django.contrib.auth import get_user_model

from rest_framework import status, viewsets
from rest_framework .decorators import action
from rest_framework.permissions import AllowAny
from rest_framework.response import Response

# from .renderers import UserJSONRenderer
from .serializers import UserRegistrationSerializer, UserLoginSerializer

User = get_user_model()


class UserAPIView(viewsets.GenericViewSet):
    queryset = User.objects.all()
    serializer_class = UserRegistrationSerializer
    permission_classes = (AllowAny,)
    # renderer_classes = (UserJSONRenderer,)

    @action(['post'], detail=False)
    def registration(self, request):
        serializer = self.serializer_class(data=request.data)
        serializer.is_valid(raise_exception=True)
        serializer.save()
        return Response(serializer.data, status=status.HTTP_201_CREATED)

    @action(['post'], detail=False)
    def login(self, request):
        serializer = UserLoginSerializer(data=request.data)
        serializer.is_valid(raise_exception=True)
        return Response(serializer.data, status=status.HTTP_200_OK)</code></pre>
</div>
<p>–ó–∞—Ä–µ–≥–∞—Ç—å –≤—å—é—Å–µ—Ç –≤ api/urls.py</p>
<pre><code class="lang-py">from django.contrib.auth.models import BaseUserManager

class UserManager(BaseUserManager):
    def create_user(self, username, email, password=None):
        """ –°–æ–∑–¥–∞–µ—Ç –æ–±—ã—á–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è."""
        if username is None:
            raise TypeError('Users must have a username.')
        if email is None:
            raise TypeError('Users must have an email address.')
        user = self.model(username=username, email=self.normalize_email(email))
        user.set_password(password)
        user.save()
        return user

    def create_superuser(self, username, email, password):
        """ –°–æ–∑–¥–∞–µ—Ç —Å—É–ø–µ—Ä–∞–¥–º–∏–Ω–∞."""
        if password is None:
            raise TypeError('Superusers must have a password.')
        user = self.create_user(username, email, password)
        user.is_superuser = True
        user.is_staff = True
        user.save()
        return user</code></pre>
<pre><code class="lang-py">from django.contrib.auth import authenticate, get_user_model

from rest_framework import serializers

User = get_user_model()


class UserRegistrationSerializer(serializers.ModelSerializer):
    """–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ."""
    password = serializers.CharField(
        max_length=128,
        min_length=3,
        write_only=True
    )
    token = serializers.CharField(max_length=255, read_only=True)  # –¥–æ—Å—Ç—É–ø–µ–Ω —Ç–æ–ª—å–∫–æ –Ω–∞ —á—Ç–µ–Ω–∏–µ

    class Meta:
        model = User
        fields = ('email', 'username', 'password', 'token')

    def create(self, validated_data):
        # –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –º–µ—Ç–æ–¥ create_user –∏–∑ UserManager
        return User.objects.create_user(**validated_data)


class UserLoginSerializer(serializers.ModelSerializer):
    email = serializers.CharField(max_length=255)
    username = serializers.CharField(max_length=255, read_only=True)
    password = serializers.CharField(max_length=128, write_only=True)
    token = serializers.CharField(max_length=255, read_only=True)

    class Meta:
        model = User
        fields = ('email', 'username', 'password', 'token')

    def validate(self, data):
        email = data.get('email', None)
        password = data.get('password', None)

        if email is None:
            raise serializers.ValidationError('A email is needed.')
        if password is None:
            raise serializers.ValidationError('A password is needed.')

        # –ú–µ—Ç–æ–¥ authenticate –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è Django
        # email –ø–µ—Ä–µ–¥–∞–µ–º –∫–∞–∫ username, —Ç–∞–∫ –∫–∞–∫ USERNAME_FIELD = email.
        user = authenticate(username=email, password=password)

        if user is None:
            raise serializers.ValidationError('User not found.')
        if not user.is_active:
            raise serializers.ValidationError('This user has been deactivated.')

        return {
            'email': user.email,
            'username': user.username,
            'token': user.token
        }</code></pre>
<h3 class="section-title">–ü–µ—Ä–µ–≥—Ä—É–∑–∫–∞ EXCEPTION_HANDLER –∏ NON_FIELD_ERRORS_KEY</h3>
<p>–ù–∞—Å—Ç—Ä–æ–π–∫–∞ DRF –ø–æ–¥ –Ω–∞–∑–≤–∞–Ω–∏–µ–º EXCEPTION_HANDLER –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ª–æ–≤–∞—Ä—å –æ—à–∏–±–æ–∫</p>
<pre><code class="lang-py">from rest_framework.views import exception_handler

def core_exception_handler(exc, context):
    response = exception_handler(exc, context)
    handlers = {
        'ValidationError': _handle_generic_error
    }
    exception_class = exc.__class__.__name__

    if exception_class in handlers:
        return handlers[exception_class](exc, context, response)

    return response


def _handle_generic_error(exc, context, response):
    response.data = {
        'errors': response.data
    }
    return response</code></pre>
<p>–î–æ–±–∞–≤–∏—Ç—å –∫–∞—Å—Ç–æ–º–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤ settings</p>
<pre><code class="lang-py">REST_FRAMEWORK = {
    'EXCEPTION_HANDLER': 'project.exceptions.core_exception_handler',
    'NON_FIELD_ERRORS_KEY': 'error',
}</code></pre>
<h3 class="section-title">–ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</h3>
<p>–í Django —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏–¥–µ—è –±–µ–∫–µ–Ω–¥–æ–≤ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏. –ë–µ–∫–µ–Ω–¥ - —ç—Ç–æ, –ø–æ —Å—É—Ç–∏, –ø–ª–∞–Ω –ø—Ä–∏–Ω—è—Ç–∏—è —Ä–µ—à–µ–Ω–∏—è –æ —Ç–æ–º, –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å. –ù–∞–º –Ω—É–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π –±–µ–∫–µ–Ω–¥ –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ JWT, –ø–æ—Å–∫–æ–ª—å–∫—É –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –æ–Ω –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –Ω–∏ Django –Ω–∏ DRF.</p>
<pre><code class="lang-py">import jwt

from django.conf import settings
from django.contrib.auth import get_user_model

from rest_framework import authentication, exceptions

User = get_user_model()


class JWTAuthentication(authentication.BaseAuthentication):
    authentication_header_prefix = 'Token'

    def authenticate(self, request):
        request.user = None

        auth_header = authentication.get_authorization_header(request).split()
        auth_header_prefix = self.authentication_header_prefix.lower()

        if not auth_header:
            return None

        if len(auth_header) == 1:
            return None
        elif len(auth_header) > 2:
            return None

        prefix = auth_header[0].decode('utf-8')
        token = auth_header[1].decode('utf-8')

        if prefix.lower() != auth_header_prefix:
            return None

        return self._authenticate_credentials(request, token)

    def _authenticate_credentials(self, request, token):
        """–ü–æ–ø—ã—Ç–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ —Å –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏."""
        try:
            payload = jwt.decode(token, settings.SECRET_KEY)
        except Exception:
            raise exceptions.AuthenticationFailed('–û—à–∏–±–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏. –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–∫–µ–Ω.')

        try:
            user = User.objects.get(pk=payload['id'])
        except User.DoesNotExist:
            raise exceptions.AuthenticationFailed('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π –¥–∞–Ω–Ω–æ–º—É —Ç–æ–∫–µ–Ω—É –Ω–µ –Ω–∞–π–¥–µ–Ω.')

        if not user.is_active:
            raise exceptions.AuthenticationFailed('–î–∞–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω.')

        return (user, token)</code></pre>
<p>–°–æ–æ–±—â–∏—Ç—å DRF –ø—Ä–æ –Ω–∞—à –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–æ–Ω–Ω—ã–π –±–µ–∫–µ–Ω–¥</p>
<pre><code class="lang-py">REST_FRAMEWORK = {
    ...
    'DEFAULT_AUTHENTICATION_CLASSES': (
        'apps.user.backends.JWTAuthentication',
    ),
    ...
}</code></pre>
